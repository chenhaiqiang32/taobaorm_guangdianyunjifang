var Al=Object.defineProperty;var Ml=(i,t,e)=>t in i?Al(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var O=(i,t,e)=>(Ml(i,typeof t!="symbol"?t+"":t,e),e),fn=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var P=(i,t,e)=>(fn(i,t,"read from private field"),e?e.call(i):t.get(i)),z=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)},K=(i,t,e,s)=>(fn(i,t,"write to private field"),s?s.call(i,e):t.set(i,e),e);var Y=(i,t,e)=>(fn(i,t,"access private method"),e);import{R as la,P as cr,E as Ji,V as M,M as jt,T as Vt,Q as zs,S as Nr,a as F,b as ur,U as ot,c as Z,D as Cl,d as _l,e as Pl,f as Rl,W as Ue,g as k,C as U,h as kt,i as Ei,j as Vn,N as ca,B as zt,k as hs,l as ua,m as de,L as ds,n as Ds,o as ze,p as Ee,F as Ai,q as Ze,r as ha,s as lt,t as Ur,u as ms,v as Ll,w as qn,x as da,y as Ht,z as oe,A as ns,G as fs,H as At,I as Dl,J as Bl,K as Il,O as Ol,X as Fl,Y as ve,Z as ie,_ as Ke,$ as fa,a0 as Dt,a1 as Nl,a2 as pa,a3 as Ul,a4 as kl,a5 as zl,a6 as hr,a7 as Tt,a8 as dr,a9 as fr,aa as ma,ab as ga,ac as va,ad as Mi,ae as Ye,af as Bs,ag as Ct,ah as le,ai as Hl,aj as Q,ak as pr,al as Ci,am as Gl,an as kr,ao as Wn,ap as Bt,aq as jl,ar as ya,as as vi,at as yi,au as Vl,av as en,aw as ql,ax as Kn,ay as ba,az as Wl,aA as Xn,aB as xa,aC as Kl,aD as Xl,aE as _t,aF as wa,aG as Yl,aH as $l,aI as Zl,aJ as Sa,aK as Ql,aL as Jl,aM as mr,aN as ec,aO as tc,aP as sc,aQ as ic,aR as nc,aS as rc,aT as oc,aU as ac,aV as lc,aW as cc,aX as Ta,aY as zr,aZ as uc,a_ as hc,a$ as dc,b0 as fc,b1 as pc,b2 as mc,b3 as Hr,b4 as Gr,b5 as jr,b6 as gc,b7 as vc,b8 as Is,b9 as Vr,ba as qr,bb as Ys,bc as yc,bd as bc,be as xc,bf as wc,bg as ct,bh as Ea,bi as Sc,bj as Tc,bk as Ec,bl as _e,bm as Ac,bn as Mc,bo as Cc,bp as _c,bq as Aa,br as Pc,bs as Rc,bt as Lc,bu as Dc,bv as Bc,bw as $s,bx as Ic,by as pn,bz as Wr,bA as Oc,bB as Fc}from"./weather-2f4c1b70.js";import{s as Zs}from"./main-6e4b7904.js";import{sceneChange as Nc}from"./dataProgress-9ee5847f.js";var Os=function(){var i=0,t=document.createElement("div");t.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",t.addEventListener("click",function(h){h.preventDefault(),s(++i%t.children.length)},!1);function e(h){return t.appendChild(h.dom),h}function s(h){for(var u=0;u<t.children.length;u++)t.children[u].style.display=u===h?"block":"none";i=h}var n=(performance||Date).now(),r=n,o=0,a=e(new Os.Panel("FPS","#0ff","#002")),l=e(new Os.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var c=e(new Os.Panel("MB","#f08","#201"));return s(0),{REVISION:16,dom:t,addPanel:e,showPanel:s,begin:function(){n=(performance||Date).now()},end:function(){o++;var h=(performance||Date).now();if(l.update(h-n,200),h>=r+1e3&&(a.update(o*1e3/(h-r),100),r=h,o=0,c)){var u=performance.memory;c.update(u.usedJSHeapSize/1048576,u.jsHeapSizeLimit/1048576)}return h},update:function(){n=this.end()},domElement:t,setMode:s}};Os.Panel=function(i,t,e){var s=1/0,n=0,r=Math.round,o=r(window.devicePixelRatio||1),a=80*o,l=48*o,c=3*o,h=2*o,u=3*o,d=15*o,f=74*o,g=30*o,v=document.createElement("canvas");v.width=a,v.height=l,v.style.cssText="width:80px;height:48px";var p=v.getContext("2d");return p.font="bold "+9*o+"px Helvetica,Arial,sans-serif",p.textBaseline="top",p.fillStyle=e,p.fillRect(0,0,a,l),p.fillStyle=t,p.fillText(i,c,h),p.fillRect(u,d,f,g),p.fillStyle=e,p.globalAlpha=.9,p.fillRect(u,d,f,g),{dom:v,update:function(m,y){s=Math.min(s,m),n=Math.max(n,m),p.fillStyle=e,p.globalAlpha=1,p.fillRect(0,0,a,d),p.fillStyle=t,p.fillText(r(m)+" "+i+" ("+r(s)+"-"+r(n)+")",c,h),p.drawImage(v,u+o,d,f-o,g,u,d,f-o,g),p.fillRect(u+f-o,d,o,g),p.fillStyle=e,p.globalAlpha=.9,p.fillRect(u+f-o,d,o,r((1-m/y)*g))}}};const Uc=Os,Kr={type:"change"},mn={type:"start"},Xr={type:"end"},Qs=new la,Yr=new cr,kc=Math.cos(70*ur.DEG2RAD);class zc extends Ji{constructor(t,e){super(),this.object=t,this.domElement=e,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new M,this.cursor=new M,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableDolly=!0,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:jt.ROTATE,MIDDLE:jt.DOLLY,RIGHT:jt.PAN},this.touches={ONE:Vt.ROTATE,TWO:Vt.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return a.phi},this.getAzimuthalAngle=function(){return a.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(S){S.addEventListener("keydown",dn),this._domElementKeyEvents=S},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",dn),this._domElementKeyEvents=null},this.saveState=function(){s.target0.copy(s.target),s.position0.copy(s.object.position),s.zoom0=s.object.zoom},this.reset=function(){s.target.copy(s.target0),s.object.position.copy(s.position0),s.object.zoom=s.zoom0,s.object.updateProjectionMatrix(),s.dispatchEvent(Kr),s.update(),r=n.NONE},this.update=function(){const S=new M,I=new zs().setFromUnitVectors(t.up,new M(0,1,0)),j=I.clone().invert(),$=new M,ye=new zs,ut=new M,Re=2*Math.PI;return function(El=null){const Or=s.object.position;S.copy(Or).sub(s.target),S.applyQuaternion(I),a.setFromVector3(S),s.autoRotate&&r===n.NONE&&_(R(El)),s.enableDamping?(a.theta+=l.theta*s.dampingFactor,a.phi+=l.phi*s.dampingFactor):(a.theta+=l.theta,a.phi+=l.phi);let Qe=s.minAzimuthAngle,Je=s.maxAzimuthAngle;isFinite(Qe)&&isFinite(Je)&&(Qe<-Math.PI?Qe+=Re:Qe>Math.PI&&(Qe-=Re),Je<-Math.PI?Je+=Re:Je>Math.PI&&(Je-=Re),Qe<=Je?a.theta=Math.max(Qe,Math.min(Je,a.theta)):a.theta=a.theta>(Qe+Je)/2?Math.max(Qe,a.theta):Math.min(Je,a.theta)),a.phi=Math.max(s.minPolarAngle,Math.min(s.maxPolarAngle,a.phi)),a.makeSafe(),s.enableDamping===!0?s.target.addScaledVector(h,s.dampingFactor):s.target.add(h),s.target.sub(s.cursor),s.target.clampLength(s.minTargetRadius,s.maxTargetRadius),s.target.add(s.cursor);let Ss=!1;if(s.zoomToCursor&&E||s.object.isOrthographicCamera)a.radius=X(a.radius);else{const et=a.radius;a.radius=X(a.radius*c),Ss=et!=a.radius}if(S.setFromSpherical(a),S.applyQuaternion(j),Or.copy(s.target).add(S),s.object.lookAt(s.target),s.enableDamping===!0?(l.theta*=1-s.dampingFactor,l.phi*=1-s.dampingFactor,h.multiplyScalar(1-s.dampingFactor)):(l.set(0,0,0),h.set(0,0,0)),s.zoomToCursor&&E){let et=null;if(s.object.isPerspectiveCamera){const Ts=S.length();et=X(Ts*c);const Xs=Ts-et;s.object.position.addScaledVector(b,Xs),s.object.updateMatrixWorld(),Ss=!!Xs}else if(s.object.isOrthographicCamera){const Ts=new M(w.x,w.y,0);Ts.unproject(s.object);const Xs=s.object.zoom;s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom/c)),s.object.updateProjectionMatrix(),Ss=Xs!==s.object.zoom;const Fr=new M(w.x,w.y,0);Fr.unproject(s.object),s.object.position.sub(Fr).add(Ts),s.object.updateMatrixWorld(),et=S.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),s.zoomToCursor=!1;et!==null&&(this.screenSpacePanning?s.target.set(0,0,-1).transformDirection(s.object.matrix).multiplyScalar(et).add(s.object.position):(Qs.origin.copy(s.object.position),Qs.direction.set(0,0,-1).transformDirection(s.object.matrix),Math.abs(s.object.up.dot(Qs.direction))<kc?t.lookAt(s.target):(Yr.setFromNormalAndCoplanarPoint(s.object.up,s.target),Qs.intersectPlane(Yr,s.target))))}else if(s.object.isOrthographicCamera){const et=s.object.zoom;s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom/c)),et!==s.object.zoom&&(s.object.updateProjectionMatrix(),Ss=!0)}return c=1,E=!1,Ss||$.distanceToSquared(s.object.position)>o||8*(1-ye.dot(s.object.quaternion))>o||ut.distanceToSquared(s.target)>o?(s.dispatchEvent(Kr),$.copy(s.object.position),ye.copy(s.object.quaternion),ut.copy(s.target),!0):!1}}(),this.dispose=function(){s.domElement.removeEventListener("contextmenu",Br),s.domElement.removeEventListener("pointerdown",_r),s.domElement.removeEventListener("pointercancel",ws),s.domElement.removeEventListener("wheel",Pr),s.domElement.removeEventListener("pointermove",hn),s.domElement.removeEventListener("pointerup",ws),s.domElement.getRootNode().removeEventListener("keydown",Rr,{capture:!0}),s._domElementKeyEvents!==null&&(s._domElementKeyEvents.removeEventListener("keydown",dn),s._domElementKeyEvents=null)};const s=this,n={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let r=n.NONE;const o=1e-6,a=new Nr,l=new Nr;let c=1;const h=new M,u=new F,d=new F,f=new F,g=new F,v=new F,p=new F,m=new F,y=new F,x=new F,b=new M,w=new F;let E=!1;const T=[],A={};let C=!1;function R(S){return S!==null?2*Math.PI/60*s.autoRotateSpeed*S:2*Math.PI/60/60*s.autoRotateSpeed}function L(S){const I=Math.abs(S*.01);return Math.pow(.95,s.zoomSpeed*I)}function _(S){l.theta-=S}function D(S){l.phi-=S}const B=function(){const S=new M;return function(j,$){S.setFromMatrixColumn($,0),S.multiplyScalar(-j),h.add(S)}}(),N=function(){const S=new M;return function(j,$){s.screenSpacePanning===!0?S.setFromMatrixColumn($,1):(S.setFromMatrixColumn($,0),S.crossVectors(s.object.up,S)),S.multiplyScalar(j),h.add(S)}}(),H=function(){const S=new M;return function(j,$){const ye=s.domElement;if(s.object.isPerspectiveCamera){const ut=s.object.position;S.copy(ut).sub(s.target);let Re=S.length();Re*=Math.tan(s.object.fov/2*Math.PI/180),B(2*j*Re/ye.clientHeight,s.object.matrix),N(2*$*Re/ye.clientHeight,s.object.matrix)}else s.object.isOrthographicCamera?(B(j*(s.object.right-s.object.left)/s.object.zoom/ye.clientWidth,s.object.matrix),N($*(s.object.top-s.object.bottom)/s.object.zoom/ye.clientHeight,s.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),s.enablePan=!1)}}();function J(S){s.object.isPerspectiveCamera||s.object.isOrthographicCamera?c/=S:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),s.enableZoom=!1)}function ne(S){s.object.isPerspectiveCamera||s.object.isOrthographicCamera?c*=S:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),s.enableZoom=!1)}function pe(S,I){if(!s.zoomToCursor)return;E=!0;const j=s.domElement.getBoundingClientRect(),$=S-j.left,ye=I-j.top,ut=j.width,Re=j.height;w.x=$/ut*2-1,w.y=-(ye/Re)*2+1,b.set(w.x,w.y,1).unproject(s.object).sub(s.object.position).normalize()}function X(S){return Math.max(s.minDistance,Math.min(s.maxDistance,S))}function ys(S){u.set(S.clientX,S.clientY)}function ln(S){pe(S.clientX,S.clientX),m.set(S.clientX,S.clientY)}function Ws(S){g.set(S.clientX,S.clientY)}function bs(S){d.set(S.clientX,S.clientY),f.subVectors(d,u).multiplyScalar(s.rotateSpeed);const I=s.domElement;_(2*Math.PI*f.x/I.clientHeight),D(2*Math.PI*f.y/I.clientHeight),u.copy(d),s.update()}function xs(S){y.set(S.clientX,S.clientY),x.subVectors(y,m),x.y>0?J(L(x.y)):x.y<0&&ne(L(x.y)),m.copy(y),s.update()}function Pt(S){v.set(S.clientX,S.clientY),p.subVectors(v,g).multiplyScalar(s.panSpeed),H(p.x,p.y),g.copy(v),s.update()}function cn(S){pe(S.clientX,S.clientY),S.deltaY<0?ne(L(S.deltaY)):S.deltaY>0&&J(L(S.deltaY)),s.update()}function un(S){let I=!1;switch(S.code){case s.keys.UP:S.ctrlKey||S.metaKey||S.shiftKey?D(2*Math.PI*s.rotateSpeed/s.domElement.clientHeight):H(0,s.keyPanSpeed),I=!0;break;case s.keys.BOTTOM:S.ctrlKey||S.metaKey||S.shiftKey?D(-2*Math.PI*s.rotateSpeed/s.domElement.clientHeight):H(0,-s.keyPanSpeed),I=!0;break;case s.keys.LEFT:S.ctrlKey||S.metaKey||S.shiftKey?_(2*Math.PI*s.rotateSpeed/s.domElement.clientHeight):H(s.keyPanSpeed,0),I=!0;break;case s.keys.RIGHT:S.ctrlKey||S.metaKey||S.shiftKey?_(-2*Math.PI*s.rotateSpeed/s.domElement.clientHeight):H(-s.keyPanSpeed,0),I=!0;break}I&&(S.preventDefault(),s.update())}function Ks(S){if(T.length===1)u.set(S.pageX,S.pageY);else{const I=Gt(S),j=.5*(S.pageX+I.x),$=.5*(S.pageY+I.y);u.set(j,$)}}function Tr(S){if(T.length===1)g.set(S.pageX,S.pageY);else{const I=Gt(S),j=.5*(S.pageX+I.x),$=.5*(S.pageY+I.y);g.set(j,$)}}function Er(S){const I=Gt(S),j=S.pageX-I.x,$=S.pageY-I.y,ye=Math.sqrt(j*j+$*$);m.set(0,ye)}function fl(S){s.enableZoom&&Er(S),s.enablePan&&Tr(S)}function pl(S){s.enableZoom&&Er(S),s.enableRotate&&Ks(S)}function Ar(S){if(T.length==1)d.set(S.pageX,S.pageY);else{const j=Gt(S),$=.5*(S.pageX+j.x),ye=.5*(S.pageY+j.y);d.set($,ye)}f.subVectors(d,u).multiplyScalar(s.rotateSpeed);const I=s.domElement;_(2*Math.PI*f.x/I.clientHeight),D(2*Math.PI*f.y/I.clientHeight),u.copy(d)}function Mr(S){if(T.length===1)v.set(S.pageX,S.pageY);else{const I=Gt(S),j=.5*(S.pageX+I.x),$=.5*(S.pageY+I.y);v.set(j,$)}p.subVectors(v,g).multiplyScalar(s.panSpeed),H(p.x,p.y),g.copy(v)}function Cr(S){const I=Gt(S),j=S.pageX-I.x,$=S.pageY-I.y,ye=Math.sqrt(j*j+$*$);y.set(0,ye),x.set(0,Math.pow(y.y/m.y,s.zoomSpeed)),J(x.y),m.copy(y);const ut=(S.pageX+I.x)*.5,Re=(S.pageY+I.y)*.5;pe(ut,Re)}function ml(S){s.enableZoom&&Cr(S),s.enablePan&&Mr(S)}function gl(S){s.enableZoom&&Cr(S),s.enableRotate&&Ar(S)}function _r(S){s.enabled!==!1&&(T.length===0&&(s.domElement.setPointerCapture(S.pointerId),s.domElement.addEventListener("pointermove",hn),s.domElement.addEventListener("pointerup",ws)),!Tl(S)&&(wl(S),S.pointerType==="touch"?Dr(S):vl(S)))}function hn(S){s.enabled!==!1&&(S.pointerType==="touch"?xl(S):yl(S))}function ws(S){switch(Sl(S),T.length){case 0:s.domElement.releasePointerCapture(S.pointerId),s.domElement.removeEventListener("pointermove",hn),s.domElement.removeEventListener("pointerup",ws),s.dispatchEvent(Xr),r=n.NONE;break;case 1:const I=T[0],j=A[I];Dr({pointerId:I,pageX:j.x,pageY:j.y});break}}function vl(S){let I;switch(S.button){case 0:I=s.mouseButtons.LEFT;break;case 1:I=s.mouseButtons.MIDDLE;break;case 2:I=s.mouseButtons.RIGHT;break;default:I=-1}switch(I){case jt.DOLLY:if(s.enableZoom===!1)return;ln(S),r=n.DOLLY;break;case jt.ROTATE:if(S.ctrlKey||S.metaKey||S.shiftKey){if(s.enablePan===!1)return;Ws(S),r=n.PAN}else{if(s.enableRotate===!1)return;ys(S),r=n.ROTATE}break;case jt.PAN:if(S.ctrlKey||S.metaKey||S.shiftKey){if(s.enableRotate===!1)return;ys(S),r=n.ROTATE}else{if(s.enablePan===!1)return;Ws(S),r=n.PAN}break;default:r=n.NONE}r!==n.NONE&&s.dispatchEvent(mn)}function yl(S){switch(r){case n.ROTATE:if(s.enableRotate===!1)return;bs(S);break;case n.DOLLY:if(s.enableDolly===!1)return;xs(S);break;case n.PAN:if(s.enablePan===!1)return;Pt(S);break}}function Pr(S){s.enabled===!1||s.enableZoom===!1||r!==n.NONE||(S.preventDefault(),s.dispatchEvent(mn),cn(bl(S)),s.dispatchEvent(Xr))}function bl(S){const I=S.deltaMode,j={clientX:S.clientX,clientY:S.clientY,deltaY:S.deltaY};switch(I){case 1:j.deltaY*=16;break;case 2:j.deltaY*=100;break}return S.ctrlKey&&!C&&(j.deltaY*=10),j}function Rr(S){S.key==="Control"&&(C=!0,s.domElement.getRootNode().addEventListener("keyup",Lr,{passive:!0,capture:!0}))}function Lr(S){S.key==="Control"&&(C=!1,s.domElement.getRootNode().removeEventListener("keyup",Lr,{passive:!0,capture:!0}))}function dn(S){s.enabled===!1||s.enablePan===!1||un(S)}function Dr(S){switch(Ir(S),T.length){case 1:switch(s.touches.ONE){case Vt.ROTATE:if(s.enableRotate===!1)return;Ks(S),r=n.TOUCH_ROTATE;break;case Vt.PAN:if(s.enablePan===!1)return;Tr(S),r=n.TOUCH_PAN;break;default:r=n.NONE}break;case 2:switch(s.touches.TWO){case Vt.DOLLY_PAN:if(s.enableZoom===!1&&s.enablePan===!1)return;fl(S),r=n.TOUCH_DOLLY_PAN;break;case Vt.DOLLY_ROTATE:if(s.enableZoom===!1&&s.enableRotate===!1)return;pl(S),r=n.TOUCH_DOLLY_ROTATE;break;default:r=n.NONE}break;default:r=n.NONE}r!==n.NONE&&s.dispatchEvent(mn)}function xl(S){switch(Ir(S),r){case n.TOUCH_ROTATE:if(s.enableRotate===!1)return;Ar(S),s.update();break;case n.TOUCH_PAN:if(s.enablePan===!1)return;Mr(S),s.update();break;case n.TOUCH_DOLLY_PAN:if(s.enableZoom===!1&&s.enablePan===!1)return;ml(S),s.update();break;case n.TOUCH_DOLLY_ROTATE:if(s.enableZoom===!1&&s.enableRotate===!1)return;gl(S),s.update();break;default:r=n.NONE}}function Br(S){s.enabled!==!1&&S.preventDefault()}function wl(S){T.push(S.pointerId)}function Sl(S){delete A[S.pointerId];for(let I=0;I<T.length;I++)if(T[I]==S.pointerId){T.splice(I,1);return}}function Tl(S){for(let I=0;I<T.length;I++)if(T[I]==S.pointerId)return!0;return!1}function Ir(S){let I=A[S.pointerId];I===void 0&&(I=new F,A[S.pointerId]=I),I.set(S.pageX,S.pageY)}function Gt(S){const I=S.pointerId===T[0]?T[1]:T[0];return A[I]}s.domElement.addEventListener("contextmenu",Br),s.domElement.addEventListener("pointerdown",_r),s.domElement.addEventListener("pointercancel",ws),s.domElement.addEventListener("wheel",Pr,{passive:!1}),s.domElement.getRootNode().addEventListener("keydown",Rr,{passive:!0,capture:!0}),this.update()}}/**
 * postprocessing v6.37.2 build Fri Mar 28 2025
 * https://github.com/pmndrs/postprocessing
 * Copyright 2015-2025 Raoul van Rüschen
 * @license Zlib
 */var gn=1/1e3,Hc=1e3,Gc=class{constructor(){this.startTime=performance.now(),this.previousTime=0,this.currentTime=0,this._delta=0,this._elapsed=0,this._fixedDelta=1e3/60,this.timescale=1,this.useFixedDelta=!1,this._autoReset=!1}get autoReset(){return this._autoReset}set autoReset(i){typeof document<"u"&&document.hidden!==void 0&&(i?document.addEventListener("visibilitychange",this):document.removeEventListener("visibilitychange",this),this._autoReset=i)}get delta(){return this._delta*gn}get fixedDelta(){return this._fixedDelta*gn}set fixedDelta(i){this._fixedDelta=i*Hc}get elapsed(){return this._elapsed*gn}update(i){this.useFixedDelta?this._delta=this.fixedDelta:(this.previousTime=this.currentTime,this.currentTime=(i!==void 0?i:performance.now())-this.startTime,this._delta=this.currentTime-this.previousTime),this._delta*=this.timescale,this._elapsed+=this._delta}reset(){this._delta=0,this._elapsed=0,this.currentTime=performance.now()-this.startTime}getDelta(){return this.delta}getElapsed(){return this.elapsed}handleEvent(i){document.hidden||(this.currentTime=performance.now()-this.startTime)}dispose(){this.autoReset=!1}},jc=(()=>{const i=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),t=new Float32Array([0,0,2,0,0,2]),e=new Ht;return e.setAttribute("position",new oe(i,3)),e.setAttribute("uv",new oe(t,2)),e})(),Pe=class Yn{static get fullscreenGeometry(){return jc}constructor(t="Pass",e=new hs,s=new ua){this.name=t,this.renderer=null,this.scene=e,this.camera=s,this.screen=null,this.rtt=!0,this.needsSwap=!0,this.needsDepthTexture=!1,this.enabled=!0}get renderToScreen(){return!this.rtt}set renderToScreen(t){if(this.rtt===t){const e=this.fullscreenMaterial;e!==null&&(e.needsUpdate=!0),this.rtt=!t}}set mainScene(t){}set mainCamera(t){}setRenderer(t){this.renderer=t}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}get fullscreenMaterial(){return this.screen!==null?this.screen.material:null}set fullscreenMaterial(t){let e=this.screen;e!==null?e.material=t:(e=new de(Yn.fullscreenGeometry,t),e.frustumCulled=!1,this.scene===null&&(this.scene=new hs),this.scene.add(e),this.screen=e)}getFullscreenMaterial(){return this.fullscreenMaterial}setFullscreenMaterial(t){this.fullscreenMaterial=t}getDepthTexture(){return null}setDepthTexture(t,e=zt){}render(t,e,s,n,r){throw new Error("Render method not implemented!")}setSize(t,e){}initialize(t,e,s){}dispose(){for(const t of Object.keys(this)){const e=this[t];(e instanceof Ue||e instanceof ns||e instanceof fs||e instanceof Yn)&&this[t].dispose()}this.fullscreenMaterial!==null&&this.fullscreenMaterial.dispose()}},Vc=class extends Pe{constructor(){super("ClearMaskPass",null,null),this.needsSwap=!1}render(i,t,e,s,n){const r=i.state.buffers.stencil;r.setLocked(!1),r.setTest(!1)}},qc=`#include <common>
#include <dithering_pars_fragment>
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
uniform float opacity;varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);gl_FragColor=opacity*texel;
#include <colorspace_fragment>
#include <dithering_fragment>
}`,gr="varying vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}",Ma=class extends Ee{constructor(){super({name:"CopyMaterial",uniforms:{inputBuffer:new k(null),opacity:new k(1)},blending:lt,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:qc,vertexShader:gr})}set inputBuffer(i){this.uniforms.inputBuffer.value=i}setInputBuffer(i){this.uniforms.inputBuffer.value=i}getOpacity(i){return this.uniforms.opacity.value}setOpacity(i){this.uniforms.opacity.value=i}},Wc=class extends Pe{constructor(i,t=!0){super("CopyPass"),this.fullscreenMaterial=new Ma,this.needsSwap=!1,this.renderTarget=i,i===void 0&&(this.renderTarget=new Ue(1,1,{minFilter:ds,magFilter:ds,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="CopyPass.Target"),this.autoResize=t}get resize(){return this.autoResize}set resize(i){this.autoResize=i}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}setAutoResizeEnabled(i){this.autoResize=i}render(i,t,e,s,n){this.fullscreenMaterial.inputBuffer=t.texture,i.setRenderTarget(this.renderToScreen?null:this.renderTarget),i.render(this.scene,this.camera)}setSize(i,t){this.autoResize&&this.renderTarget.setSize(i,t)}initialize(i,t,e){e!==void 0&&(this.renderTarget.texture.type=e,e!==ot?this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1":i!==null&&i.outputColorSpace===Z&&(this.renderTarget.texture.colorSpace=Z))}},$r=new U,tn=class extends Pe{constructor(i=!0,t=!0,e=!1){super("ClearPass",null,null),this.needsSwap=!1,this.color=i,this.depth=t,this.stencil=e,this.overrideClearColor=null,this.overrideClearAlpha=-1}setClearFlags(i,t,e){this.color=i,this.depth=t,this.stencil=e}getOverrideClearColor(){return this.overrideClearColor}setOverrideClearColor(i){this.overrideClearColor=i}getOverrideClearAlpha(){return this.overrideClearAlpha}setOverrideClearAlpha(i){this.overrideClearAlpha=i}render(i,t,e,s,n){const r=this.overrideClearColor,o=this.overrideClearAlpha,a=i.getClearAlpha(),l=r!==null,c=o>=0;l?(i.getClearColor($r),i.setClearColor(r,c?o:a)):c&&i.setClearAlpha(o),i.setRenderTarget(this.renderToScreen?null:t),i.clear(this.color,this.depth,this.stencil),l?i.setClearColor($r,a):c&&i.setClearAlpha(a)}},Kc=class extends Pe{constructor(i,t){super("MaskPass",i,t),this.needsSwap=!1,this.clearPass=new tn(!1,!1,!0),this.inverse=!1}set mainScene(i){this.scene=i}set mainCamera(i){this.camera=i}get inverted(){return this.inverse}set inverted(i){this.inverse=i}get clear(){return this.clearPass.enabled}set clear(i){this.clearPass.enabled=i}getClearPass(){return this.clearPass}isInverted(){return this.inverted}setInverted(i){this.inverted=i}render(i,t,e,s,n){const r=i.getContext(),o=i.state.buffers,a=this.scene,l=this.camera,c=this.clearPass,h=this.inverted?0:1,u=1-h;o.color.setMask(!1),o.depth.setMask(!1),o.color.setLocked(!0),o.depth.setLocked(!0),o.stencil.setTest(!0),o.stencil.setOp(r.REPLACE,r.REPLACE,r.REPLACE),o.stencil.setFunc(r.ALWAYS,h,4294967295),o.stencil.setClear(u),o.stencil.setLocked(!0),this.clearPass.enabled&&(this.renderToScreen?c.render(i,null):(c.render(i,t),c.render(i,e))),this.renderToScreen?(i.setRenderTarget(null),i.render(a,l)):(i.setRenderTarget(t),i.render(a,l),i.setRenderTarget(e),i.render(a,l)),o.color.setLocked(!1),o.depth.setLocked(!1),o.stencil.setLocked(!1),o.stencil.setFunc(r.EQUAL,1,4294967295),o.stencil.setOp(r.KEEP,r.KEEP,r.KEEP),o.stencil.setLocked(!0)}},Xc=class{constructor(i=null,{depthBuffer:t=!0,stencilBuffer:e=!1,multisampling:s=0,frameBufferType:n}={}){this.renderer=null,this.inputBuffer=this.createBuffer(t,e,n,s),this.outputBuffer=this.inputBuffer.clone(),this.copyPass=new Wc,this.depthTexture=null,this.passes=[],this.timer=new Gc,this.autoRenderToScreen=!0,this.setRenderer(i)}get multisampling(){return this.inputBuffer.samples||0}set multisampling(i){const t=this.inputBuffer,e=this.multisampling;e>0&&i>0?(this.inputBuffer.samples=i,this.outputBuffer.samples=i,this.inputBuffer.dispose(),this.outputBuffer.dispose()):e!==i&&(this.inputBuffer.dispose(),this.outputBuffer.dispose(),this.inputBuffer=this.createBuffer(t.depthBuffer,t.stencilBuffer,t.texture.type,i),this.inputBuffer.depthTexture=this.depthTexture,this.outputBuffer=this.inputBuffer.clone())}getTimer(){return this.timer}getRenderer(){return this.renderer}setRenderer(i){if(this.renderer=i,i!==null){const t=i.getSize(new F),e=i.getContext().getContextAttributes().alpha,s=this.inputBuffer.texture.type;s===ot&&i.outputColorSpace===Z&&(this.inputBuffer.texture.colorSpace=Z,this.outputBuffer.texture.colorSpace=Z,this.inputBuffer.dispose(),this.outputBuffer.dispose()),i.autoClear=!1,this.setSize(t.width,t.height);for(const n of this.passes)n.initialize(i,e,s)}}replaceRenderer(i,t=!0){const e=this.renderer,s=e.domElement.parentNode;return this.setRenderer(i),t&&s!==null&&(s.removeChild(e.domElement),s.appendChild(i.domElement)),e}createDepthTexture(){const i=this.depthTexture=new Cl;return this.inputBuffer.depthTexture=i,this.inputBuffer.dispose(),this.inputBuffer.stencilBuffer?(i.format=_l,i.type=Pl):i.type=Rl,i}deleteDepthTexture(){if(this.depthTexture!==null){this.depthTexture.dispose(),this.depthTexture=null,this.inputBuffer.depthTexture=null,this.inputBuffer.dispose();for(const i of this.passes)i.setDepthTexture(null)}}createBuffer(i,t,e,s){const n=this.renderer,r=n===null?new F:n.getDrawingBufferSize(new F),o={minFilter:ds,magFilter:ds,stencilBuffer:t,depthBuffer:i,type:e},a=new Ue(r.width,r.height,o);return s>0&&(a.ignoreDepthForMultisampleCopy=!1,a.samples=s),e===ot&&n!==null&&n.outputColorSpace===Z&&(a.texture.colorSpace=Z),a.texture.name="EffectComposer.Buffer",a.texture.generateMipmaps=!1,a}setMainScene(i){for(const t of this.passes)t.mainScene=i}setMainCamera(i){for(const t of this.passes)t.mainCamera=i}addPass(i,t){const e=this.passes,s=this.renderer,n=s.getDrawingBufferSize(new F),r=s.getContext().getContextAttributes().alpha,o=this.inputBuffer.texture.type;if(i.setRenderer(s),i.setSize(n.width,n.height),i.initialize(s,r,o),this.autoRenderToScreen&&(e.length>0&&(e[e.length-1].renderToScreen=!1),i.renderToScreen&&(this.autoRenderToScreen=!1)),t!==void 0?e.splice(t,0,i):e.push(i),this.autoRenderToScreen&&(e[e.length-1].renderToScreen=!0),i.needsDepthTexture||this.depthTexture!==null)if(this.depthTexture===null){const a=this.createDepthTexture();for(i of e)i.setDepthTexture(a)}else i.setDepthTexture(this.depthTexture)}removePass(i){const t=this.passes,e=t.indexOf(i);if(e!==-1&&t.splice(e,1).length>0){if(this.depthTexture!==null){const r=(a,l)=>a||l.needsDepthTexture;t.reduce(r,!1)||(i.getDepthTexture()===this.depthTexture&&i.setDepthTexture(null),this.deleteDepthTexture())}this.autoRenderToScreen&&e===t.length&&(i.renderToScreen=!1,t.length>0&&(t[t.length-1].renderToScreen=!0))}}removeAllPasses(){const i=this.passes;this.deleteDepthTexture(),i.length>0&&(this.autoRenderToScreen&&(i[i.length-1].renderToScreen=!1),this.passes=[])}render(i){const t=this.renderer,e=this.copyPass;let s=this.inputBuffer,n=this.outputBuffer,r=!1,o,a,l;i===void 0&&(this.timer.update(),i=this.timer.getDelta());for(const c of this.passes)c.enabled&&(c.render(t,s,n,i,r),c.needsSwap&&(r&&(e.renderToScreen=c.renderToScreen,o=t.getContext(),a=t.state.buffers.stencil,a.setFunc(o.NOTEQUAL,1,4294967295),e.render(t,s,n,i,r),a.setFunc(o.EQUAL,1,4294967295)),l=s,s=n,n=l),c instanceof Kc?r=!0:c instanceof Vc&&(r=!1))}setSize(i,t,e){const s=this.renderer,n=s.getSize(new F);(i===void 0||t===void 0)&&(i=n.width,t=n.height),(n.width!==i||n.height!==t)&&s.setSize(i,t,e);const r=s.getDrawingBufferSize(new F);this.inputBuffer.setSize(r.width,r.height),this.outputBuffer.setSize(r.width,r.height);for(const o of this.passes)o.setSize(r.width,r.height)}reset(){this.dispose(),this.autoRenderToScreen=!0}dispose(){for(const i of this.passes)i.dispose();this.passes=[],this.inputBuffer!==null&&this.inputBuffer.dispose(),this.outputBuffer!==null&&this.outputBuffer.dispose(),this.deleteDepthTexture(),this.copyPass.dispose(),this.timer.dispose(),Pe.fullscreenGeometry.dispose()}},Et={NONE:0,DEPTH:1,CONVOLUTION:2},W={FRAGMENT_HEAD:"FRAGMENT_HEAD",FRAGMENT_MAIN_UV:"FRAGMENT_MAIN_UV",FRAGMENT_MAIN_IMAGE:"FRAGMENT_MAIN_IMAGE",VERTEX_HEAD:"VERTEX_HEAD",VERTEX_MAIN_SUPPORT:"VERTEX_MAIN_SUPPORT"},Yc=class{constructor(){this.shaderParts=new Map([[W.FRAGMENT_HEAD,null],[W.FRAGMENT_MAIN_UV,null],[W.FRAGMENT_MAIN_IMAGE,null],[W.VERTEX_HEAD,null],[W.VERTEX_MAIN_SUPPORT,null]]),this.defines=new Map,this.uniforms=new Map,this.blendModes=new Map,this.extensions=new Set,this.attributes=Et.NONE,this.varyings=new Set,this.uvTransformation=!1,this.readDepth=!1,this.colorSpace=Ze}},vn=!1,Zr=class{constructor(i=null){this.originalMaterials=new Map,this.material=null,this.materials=null,this.materialsBackSide=null,this.materialsDoubleSide=null,this.materialsFlatShaded=null,this.materialsFlatShadedBackSide=null,this.materialsFlatShadedDoubleSide=null,this.setMaterial(i),this.meshCount=0,this.replaceMaterial=t=>{if(t.isMesh){let e;if(t.material.flatShading)switch(t.material.side){case ze:e=this.materialsFlatShadedDoubleSide;break;case Ds:e=this.materialsFlatShadedBackSide;break;default:e=this.materialsFlatShaded;break}else switch(t.material.side){case ze:e=this.materialsDoubleSide;break;case Ds:e=this.materialsBackSide;break;default:e=this.materials;break}this.originalMaterials.set(t,t.material),t.isSkinnedMesh?t.material=e[2]:t.isInstancedMesh?t.material=e[1]:t.material=e[0],++this.meshCount}}}cloneMaterial(i){if(!(i instanceof Ee))return i.clone();const t=i.uniforms,e=new Map;for(const n in t){const r=t[n].value;r.isRenderTargetTexture&&(t[n].value=null,e.set(n,r))}const s=i.clone();for(const n of e)t[n[0]].value=n[1],s.uniforms[n[0]].value=n[1];return s}setMaterial(i){if(this.disposeMaterials(),this.material=i,i!==null){const t=this.materials=[this.cloneMaterial(i),this.cloneMaterial(i),this.cloneMaterial(i)];for(const e of t)e.uniforms=Object.assign({},i.uniforms),e.side=Ai;t[2].skinning=!0,this.materialsBackSide=t.map(e=>{const s=this.cloneMaterial(e);return s.uniforms=Object.assign({},i.uniforms),s.side=Ds,s}),this.materialsDoubleSide=t.map(e=>{const s=this.cloneMaterial(e);return s.uniforms=Object.assign({},i.uniforms),s.side=ze,s}),this.materialsFlatShaded=t.map(e=>{const s=this.cloneMaterial(e);return s.uniforms=Object.assign({},i.uniforms),s.flatShading=!0,s}),this.materialsFlatShadedBackSide=t.map(e=>{const s=this.cloneMaterial(e);return s.uniforms=Object.assign({},i.uniforms),s.flatShading=!0,s.side=Ds,s}),this.materialsFlatShadedDoubleSide=t.map(e=>{const s=this.cloneMaterial(e);return s.uniforms=Object.assign({},i.uniforms),s.flatShading=!0,s.side=ze,s})}}render(i,t,e){const s=i.shadowMap.enabled;if(i.shadowMap.enabled=!1,vn){const n=this.originalMaterials;this.meshCount=0,t.traverse(this.replaceMaterial),i.render(t,e);for(const r of n)r[0].material=r[1];this.meshCount!==n.size&&n.clear()}else{const n=t.overrideMaterial;t.overrideMaterial=this.material,i.render(t,e),t.overrideMaterial=n}i.shadowMap.enabled=s}disposeMaterials(){if(this.material!==null){const i=this.materials.concat(this.materialsBackSide).concat(this.materialsDoubleSide).concat(this.materialsFlatShaded).concat(this.materialsFlatShadedBackSide).concat(this.materialsFlatShadedDoubleSide);for(const t of i)t.dispose()}}dispose(){this.originalMaterials.clear(),this.disposeMaterials()}static get workaroundEnabled(){return vn}static set workaroundEnabled(i){vn=i}},ht=-1,we=class extends Ji{constructor(i,t=ht,e=ht,s=1){super(),this.resizable=i,this.baseSize=new F(1,1),this.preferredSize=new F(t,e),this.target=this.preferredSize,this.s=s,this.effectiveSize=new F,this.addEventListener("change",()=>this.updateEffectiveSize()),this.updateEffectiveSize()}updateEffectiveSize(){const i=this.baseSize,t=this.preferredSize,e=this.effectiveSize,s=this.scale;t.width!==ht?e.width=t.width:t.height!==ht?e.width=Math.round(t.height*(i.width/Math.max(i.height,1))):e.width=Math.round(i.width*s),t.height!==ht?e.height=t.height:t.width!==ht?e.height=Math.round(t.width/Math.max(i.width/Math.max(i.height,1),1)):e.height=Math.round(i.height*s)}get width(){return this.effectiveSize.width}set width(i){this.preferredWidth=i}get height(){return this.effectiveSize.height}set height(i){this.preferredHeight=i}getWidth(){return this.width}getHeight(){return this.height}get scale(){return this.s}set scale(i){this.s!==i&&(this.s=i,this.preferredSize.setScalar(ht),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getScale(){return this.scale}setScale(i){this.scale=i}get baseWidth(){return this.baseSize.width}set baseWidth(i){this.baseSize.width!==i&&(this.baseSize.width=i,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseWidth(){return this.baseWidth}setBaseWidth(i){this.baseWidth=i}get baseHeight(){return this.baseSize.height}set baseHeight(i){this.baseSize.height!==i&&(this.baseSize.height=i,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseHeight(){return this.baseHeight}setBaseHeight(i){this.baseHeight=i}setBaseSize(i,t){(this.baseSize.width!==i||this.baseSize.height!==t)&&(this.baseSize.set(i,t),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}get preferredWidth(){return this.preferredSize.width}set preferredWidth(i){this.preferredSize.width!==i&&(this.preferredSize.width=i,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredWidth(){return this.preferredWidth}setPreferredWidth(i){this.preferredWidth=i}get preferredHeight(){return this.preferredSize.height}set preferredHeight(i){this.preferredSize.height!==i&&(this.preferredSize.height=i,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredHeight(){return this.preferredHeight}setPreferredHeight(i){this.preferredHeight=i}setPreferredSize(i,t){(this.preferredSize.width!==i||this.preferredSize.height!==t)&&(this.preferredSize.set(i,t),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}copy(i){this.s=i.scale,this.baseSize.set(i.baseWidth,i.baseHeight),this.preferredSize.set(i.preferredWidth,i.preferredHeight),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height)}static get AUTO_SIZE(){return ht}},$c=class{constructor(i=0){this.nextId=i}getNextId(){return this.nextId++}reset(i=0){return this.nextId=i,this}},yn=new $c(2),Ca=class extends Set{constructor(i,t=yn.getNextId()){super(),this.exclusive=!1,this._layer=t,(this._layer<1||this._layer>31)&&(console.warn("Layer out of range, resetting to 2"),yn.reset(2),this._layer=yn.getNextId()),i!==void 0&&this.set(i)}get layer(){return this._layer}set layer(i){const t=this._layer;for(const e of this)e.layers.disable(t),e.layers.enable(i);this._layer=i}getLayer(){return this.layer}setLayer(i){this.layer=i}isExclusive(){return this.exclusive}setExclusive(i){this.exclusive=i}clear(){const i=this.layer;for(const t of this)t.layers.disable(i);return super.clear()}set(i){this.clear();for(const t of i)this.add(t);return this}indexOf(i){return this.has(i)?0:-1}add(i){return this.exclusive?i.layers.set(this.layer):i.layers.enable(this.layer),super.add(i)}delete(i){return this.has(i)&&i.layers.disable(this.layer),super.delete(i)}toggle(i){let t;return this.has(i)?(this.delete(i),t=!1):(this.add(i),t=!0),t}setVisible(i){for(const t of this)i?t.layers.enable(0):t.layers.disable(0);return this}},G={SKIP:9,SET:30,ADD:0,ALPHA:1,AVERAGE:2,COLOR:3,COLOR_BURN:4,COLOR_DODGE:5,DARKEN:6,DIFFERENCE:7,DIVIDE:8,DST:9,EXCLUSION:10,HARD_LIGHT:11,HARD_MIX:12,HUE:13,INVERT:14,INVERT_RGB:15,LIGHTEN:16,LINEAR_BURN:17,LINEAR_DODGE:18,LINEAR_LIGHT:19,LUMINOSITY:20,MULTIPLY:21,NEGATION:22,NORMAL:23,OVERLAY:24,PIN_LIGHT:25,REFLECT:26,SATURATION:27,SCREEN:28,SOFT_LIGHT:29,SRC:30,SUBTRACT:31,VIVID_LIGHT:32},Zc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x+y,opacity);}",Qc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y,min(y.a,opacity));}",Jc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,(x+y)*0.5,opacity);}",eu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(yHSL.rg,xHSL.b));return vec4(mix(x.rgb,z,opacity),y.a);}",tu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(step(0.0,y)*(1.0-min(vec4(1.0),(1.0-x)/y)),vec4(1.0),step(1.0,x));return mix(x,z,opacity);}",su="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=step(0.0,x)*mix(min(vec4(1.0),x/max(1.0-y,1e-9)),vec4(1.0),step(1.0,y));return mix(x,z,opacity);}",iu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,min(x,y),opacity);}",nu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,abs(x-y),opacity);}",ru="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x/max(y,1e-12),opacity);}",ou="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,(x+y-2.0*x*y),opacity);}",au="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 a=min(x,1.0),b=min(y,1.0);vec4 z=mix(2.0*a*b,1.0-2.0*(1.0-a)*(1.0-b),step(0.5,y));return mix(x,z,opacity);}",lu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,step(1.0,x+y),opacity);}",cu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(yHSL.r,xHSL.gb));return vec4(mix(x.rgb,z,opacity),y.a);}",uu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,1.0-y,opacity);}",hu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y*(1.0-x),opacity);}",du="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,max(x,y),opacity);}",fu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,clamp(y+x-1.0,0.0,1.0),opacity);}",pu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,min(x+y,1.0),opacity);}",mu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,clamp(2.0*y+x-1.0,0.0,1.0),opacity);}",gu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(xHSL.rg,yHSL.b));return vec4(mix(x.rgb,z,opacity),y.a);}",vu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x*y,opacity);}",yu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,1.0-abs(1.0-x-y),opacity);}",bu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y,opacity);}",xu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(2.0*y*x,1.0-2.0*(1.0-y)*(1.0-x),step(0.5,x));return mix(x,z,opacity);}",wu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 y2=2.0*y;vec4 z=mix(mix(y2,x,step(0.5*x,y)),max(vec4(0.0),y2-1.0),step(x,(y2-1.0)));return mix(x,z,opacity);}",Su="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(min(x*x/max(1.0-y,1e-12),1.0),y,step(1.0,y));return mix(x,z,opacity);}",Tu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(xHSL.r,yHSL.g,xHSL.b));return vec4(mix(x.rgb,z,opacity),y.a);}",Eu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x+y-min(x*y,1.0),opacity);}",Au="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 y2=2.0*y;vec4 w=step(0.5,y);vec4 z=mix(x-(1.0-y2)*x*(1.0-x),mix(x+(y2-1.0)*(sqrt(x)-x),x+(y2-1.0)*x*((16.0*x-12.0)*x+3.0),w*(1.0-step(0.25,x))),w);return mix(x,z,opacity);}",Mu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return y;}",Cu="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,max(x+y-1.0,0.0),opacity);}",_u="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(max(1.0-min((1.0-x)/(2.0*y),1.0),0.0),min(x/(2.0*(1.0-y)),1.0),step(0.5,y));return mix(x,z,opacity);}",Pu=new Map([[G.ADD,Zc],[G.ALPHA,Qc],[G.AVERAGE,Jc],[G.COLOR,eu],[G.COLOR_BURN,tu],[G.COLOR_DODGE,su],[G.DARKEN,iu],[G.DIFFERENCE,nu],[G.DIVIDE,ru],[G.DST,null],[G.EXCLUSION,ou],[G.HARD_LIGHT,au],[G.HARD_MIX,lu],[G.HUE,cu],[G.INVERT,uu],[G.INVERT_RGB,hu],[G.LIGHTEN,du],[G.LINEAR_BURN,fu],[G.LINEAR_DODGE,pu],[G.LINEAR_LIGHT,mu],[G.LUMINOSITY,gu],[G.MULTIPLY,vu],[G.NEGATION,yu],[G.NORMAL,bu],[G.OVERLAY,xu],[G.PIN_LIGHT,wu],[G.REFLECT,Su],[G.SATURATION,Tu],[G.SCREEN,Eu],[G.SOFT_LIGHT,Au],[G.SRC,Mu],[G.SUBTRACT,Cu],[G.VIVID_LIGHT,_u]]),Ru=class extends Ji{constructor(i,t=1){super(),this._blendFunction=i,this.opacity=new k(t)}getOpacity(){return this.opacity.value}setOpacity(i){this.opacity.value=i}get blendFunction(){return this._blendFunction}set blendFunction(i){this._blendFunction=i,this.dispatchEvent({type:"change"})}getBlendFunction(){return this.blendFunction}setBlendFunction(i){this.blendFunction=i}getShaderCode(){return Pu.get(this.blendFunction)}},sn=class extends Ji{constructor(i,t,{attributes:e=Et.NONE,blendFunction:s=G.NORMAL,defines:n=new Map,uniforms:r=new Map,extensions:o=null,vertexShader:a=null}={}){super(),this.name=i,this.renderer=null,this.attributes=e,this.fragmentShader=t,this.vertexShader=a,this.defines=n,this.uniforms=r,this.extensions=o,this.blendMode=new Ru(s),this.blendMode.addEventListener("change",l=>this.setChanged()),this._inputColorSpace=Ze,this._outputColorSpace=ha}get inputColorSpace(){return this._inputColorSpace}set inputColorSpace(i){this._inputColorSpace=i,this.setChanged()}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(i){this._outputColorSpace=i,this.setChanged()}set mainScene(i){}set mainCamera(i){}getName(){return this.name}setRenderer(i){this.renderer=i}getDefines(){return this.defines}getUniforms(){return this.uniforms}getExtensions(){return this.extensions}getBlendMode(){return this.blendMode}getAttributes(){return this.attributes}setAttributes(i){this.attributes=i,this.setChanged()}getFragmentShader(){return this.fragmentShader}setFragmentShader(i){this.fragmentShader=i,this.setChanged()}getVertexShader(){return this.vertexShader}setVertexShader(i){this.vertexShader=i,this.setChanged()}setChanged(){this.dispatchEvent({type:"change"})}setDepthTexture(i,t=zt){}update(i,t,e){}setSize(i,t){}initialize(i,t,e){}dispose(){for(const i of Object.keys(this)){const t=this[i];(t instanceof Ue||t instanceof ns||t instanceof fs||t instanceof Pe)&&this[i].dispose()}}},nn={VERY_SMALL:0,SMALL:1,MEDIUM:2,LARGE:3,VERY_LARGE:4,HUGE:5},Lu=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec4 sum=texture2D(inputBuffer,vUv0);sum+=texture2D(inputBuffer,vUv1);sum+=texture2D(inputBuffer,vUv2);sum+=texture2D(inputBuffer,vUv3);gl_FragColor=sum*0.25;
#include <colorspace_fragment>
}`,Du="uniform vec4 texelSize;uniform float kernel;uniform float scale;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vec2 dUv=(texelSize.xy*vec2(kernel)+texelSize.zw)*scale;vUv0=vec2(uv.x-dUv.x,uv.y+dUv.y);vUv1=vec2(uv.x+dUv.x,uv.y+dUv.y);vUv2=vec2(uv.x+dUv.x,uv.y-dUv.y);vUv3=vec2(uv.x-dUv.x,uv.y-dUv.y);gl_Position=vec4(position.xy,1.0,1.0);}",Bu=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],Iu=class extends Ee{constructor(i=new At){super({name:"KawaseBlurMaterial",uniforms:{inputBuffer:new k(null),texelSize:new k(new At),scale:new k(1),kernel:new k(0)},blending:lt,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Lu,vertexShader:Du}),this.setTexelSize(i.x,i.y),this.kernelSize=nn.MEDIUM}set inputBuffer(i){this.uniforms.inputBuffer.value=i}setInputBuffer(i){this.inputBuffer=i}get kernelSequence(){return Bu[this.kernelSize]}get scale(){return this.uniforms.scale.value}set scale(i){this.uniforms.scale.value=i}getScale(){return this.uniforms.scale.value}setScale(i){this.uniforms.scale.value=i}getKernel(){return null}get kernel(){return this.uniforms.kernel.value}set kernel(i){this.uniforms.kernel.value=i}setKernel(i){this.kernel=i}setTexelSize(i,t){this.uniforms.texelSize.value.set(i,t,i*.5,t*.5)}setSize(i,t){const e=1/i,s=1/t;this.uniforms.texelSize.value.set(e,s,e*.5,s*.5)}},_a=class extends Pe{constructor({kernelSize:i=nn.MEDIUM,resolutionScale:t=.5,width:e=we.AUTO_SIZE,height:s=we.AUTO_SIZE,resolutionX:n=e,resolutionY:r=s}={}){super("KawaseBlurPass"),this.renderTargetA=new Ue(1,1,{depthBuffer:!1}),this.renderTargetA.texture.name="Blur.Target.A",this.renderTargetB=this.renderTargetA.clone(),this.renderTargetB.texture.name="Blur.Target.B";const o=this.resolution=new we(this,n,r,t);o.addEventListener("change",a=>this.setSize(o.baseWidth,o.baseHeight)),this._blurMaterial=new Iu,this._blurMaterial.kernelSize=i,this.copyMaterial=new Ma}getResolution(){return this.resolution}get blurMaterial(){return this._blurMaterial}set blurMaterial(i){this._blurMaterial=i}get dithering(){return this.copyMaterial.dithering}set dithering(i){this.copyMaterial.dithering=i}get kernelSize(){return this.blurMaterial.kernelSize}set kernelSize(i){this.blurMaterial.kernelSize=i}get width(){return this.resolution.width}set width(i){this.resolution.preferredWidth=i}get height(){return this.resolution.height}set height(i){this.resolution.preferredHeight=i}get scale(){return this.blurMaterial.scale}set scale(i){this.blurMaterial.scale=i}getScale(){return this.blurMaterial.scale}setScale(i){this.blurMaterial.scale=i}getKernelSize(){return this.kernelSize}setKernelSize(i){this.kernelSize=i}getResolutionScale(){return this.resolution.scale}setResolutionScale(i){this.resolution.scale=i}render(i,t,e,s,n){const r=this.scene,o=this.camera,a=this.renderTargetA,l=this.renderTargetB,c=this.blurMaterial,h=c.kernelSequence;let u=t;this.fullscreenMaterial=c;for(let d=0,f=h.length;d<f;++d){const g=d&1?l:a;c.kernel=h[d],c.inputBuffer=u.texture,i.setRenderTarget(g),i.render(r,o),u=g}this.fullscreenMaterial=this.copyMaterial,this.copyMaterial.inputBuffer=u.texture,i.setRenderTarget(this.renderToScreen?null:e),i.render(r,o)}setSize(i,t){const e=this.resolution;e.setBaseSize(i,t);const s=e.width,n=e.height;this.renderTargetA.setSize(s,n),this.renderTargetB.setSize(s,n),this.blurMaterial.setSize(i,t)}initialize(i,t,e){e!==void 0&&(this.renderTargetA.texture.type=e,this.renderTargetB.texture.type=e,e!==ot?(this.blurMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.copyMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1"):i!==null&&i.outputColorSpace===Z&&(this.renderTargetA.texture.colorSpace=Z,this.renderTargetB.texture.colorSpace=Z))}static get AUTO_SIZE(){return we.AUTO_SIZE}},Ou=`#include <common>
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#ifdef RANGE
uniform vec2 range;
#elif defined(THRESHOLD)
uniform float threshold;uniform float smoothing;
#endif
varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);float l=luminance(texel.rgb);
#ifdef RANGE
float low=step(range.x,l);float high=step(l,range.y);l*=low*high;
#elif defined(THRESHOLD)
l=smoothstep(threshold,threshold+smoothing,l)*l;
#endif
#ifdef COLOR
gl_FragColor=vec4(texel.rgb*clamp(l,0.0,1.0),l);
#else
gl_FragColor=vec4(l);
#endif
}`,Fu=class extends Ee{constructor(i=!1,t=null){super({name:"LuminanceMaterial",defines:{THREE_REVISION:da.replace(/\D+/g,"")},uniforms:{inputBuffer:new k(null),threshold:new k(0),smoothing:new k(1),range:new k(null)},blending:lt,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Ou,vertexShader:gr}),this.colorOutput=i,this.luminanceRange=t}set inputBuffer(i){this.uniforms.inputBuffer.value=i}setInputBuffer(i){this.uniforms.inputBuffer.value=i}get threshold(){return this.uniforms.threshold.value}set threshold(i){this.smoothing>0||i>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.threshold.value=i}getThreshold(){return this.threshold}setThreshold(i){this.threshold=i}get smoothing(){return this.uniforms.smoothing.value}set smoothing(i){this.threshold>0||i>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.smoothing.value=i}getSmoothingFactor(){return this.smoothing}setSmoothingFactor(i){this.smoothing=i}get useThreshold(){return this.threshold>0||this.smoothing>0}set useThreshold(i){}get colorOutput(){return this.defines.COLOR!==void 0}set colorOutput(i){i?this.defines.COLOR="1":delete this.defines.COLOR,this.needsUpdate=!0}isColorOutputEnabled(i){return this.colorOutput}setColorOutputEnabled(i){this.colorOutput=i}get useRange(){return this.luminanceRange!==null}set useRange(i){this.luminanceRange=null}get luminanceRange(){return this.uniforms.range.value}set luminanceRange(i){i!==null?this.defines.RANGE="1":delete this.defines.RANGE,this.uniforms.range.value=i,this.needsUpdate=!0}getLuminanceRange(){return this.luminanceRange}setLuminanceRange(i){this.luminanceRange=i}},Nu=class extends Pe{constructor({renderTarget:i,luminanceRange:t,colorOutput:e,resolutionScale:s=1,width:n=we.AUTO_SIZE,height:r=we.AUTO_SIZE,resolutionX:o=n,resolutionY:a=r}={}){super("LuminancePass"),this.fullscreenMaterial=new Fu(e,t),this.needsSwap=!1,this.renderTarget=i,this.renderTarget===void 0&&(this.renderTarget=new Ue(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="LuminancePass.Target");const l=this.resolution=new we(this,o,a,s);l.addEventListener("change",c=>this.setSize(l.baseWidth,l.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}render(i,t,e,s,n){const r=this.fullscreenMaterial;r.inputBuffer=t.texture,i.setRenderTarget(this.renderToScreen?null:this.renderTarget),i.render(this.scene,this.camera)}setSize(i,t){const e=this.resolution;e.setBaseSize(i,t),this.renderTarget.setSize(e.width,e.height)}initialize(i,t,e){e!==void 0&&e!==ot&&(this.renderTarget.texture.type=e,this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}},Uu=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#define WEIGHT_INNER 0.125
#define WEIGHT_OUTER 0.0555555
varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;float clampToBorder(const in vec2 uv){return float(uv.s>=0.0&&uv.s<=1.0&&uv.t>=0.0&&uv.t<=1.0);}void main(){vec4 c=vec4(0.0);vec4 w=WEIGHT_INNER*vec4(clampToBorder(vUv00),clampToBorder(vUv01),clampToBorder(vUv02),clampToBorder(vUv03));c+=w.x*texture2D(inputBuffer,vUv00);c+=w.y*texture2D(inputBuffer,vUv01);c+=w.z*texture2D(inputBuffer,vUv02);c+=w.w*texture2D(inputBuffer,vUv03);w=WEIGHT_OUTER*vec4(clampToBorder(vUv04),clampToBorder(vUv05),clampToBorder(vUv06),clampToBorder(vUv07));c+=w.x*texture2D(inputBuffer,vUv04);c+=w.y*texture2D(inputBuffer,vUv05);c+=w.z*texture2D(inputBuffer,vUv06);c+=w.w*texture2D(inputBuffer,vUv07);w=WEIGHT_OUTER*vec4(clampToBorder(vUv08),clampToBorder(vUv09),clampToBorder(vUv10),clampToBorder(vUv11));c+=w.x*texture2D(inputBuffer,vUv08);c+=w.y*texture2D(inputBuffer,vUv09);c+=w.z*texture2D(inputBuffer,vUv10);c+=w.w*texture2D(inputBuffer,vUv11);c+=WEIGHT_OUTER*texture2D(inputBuffer,vUv);gl_FragColor=c;
#include <colorspace_fragment>
}`,ku="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;void main(){vUv=position.xy*0.5+0.5;vUv00=vUv+texelSize*vec2(-1.0,1.0);vUv01=vUv+texelSize*vec2(1.0,1.0);vUv02=vUv+texelSize*vec2(-1.0,-1.0);vUv03=vUv+texelSize*vec2(1.0,-1.0);vUv04=vUv+texelSize*vec2(-2.0,2.0);vUv05=vUv+texelSize*vec2(0.0,2.0);vUv06=vUv+texelSize*vec2(2.0,2.0);vUv07=vUv+texelSize*vec2(-2.0,0.0);vUv08=vUv+texelSize*vec2(2.0,0.0);vUv09=vUv+texelSize*vec2(-2.0,-2.0);vUv10=vUv+texelSize*vec2(0.0,-2.0);vUv11=vUv+texelSize*vec2(2.0,-2.0);gl_Position=vec4(position.xy,1.0,1.0);}",zu=class extends Ee{constructor(){super({name:"DownsamplingMaterial",uniforms:{inputBuffer:new k(null),texelSize:new k(new F)},blending:lt,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Uu,vertexShader:ku})}set inputBuffer(i){this.uniforms.inputBuffer.value=i}setSize(i,t){this.uniforms.texelSize.value.set(1/i,1/t)}},Hu=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;uniform mediump sampler2D supportBuffer;
#else
uniform lowp sampler2D inputBuffer;uniform lowp sampler2D supportBuffer;
#endif
uniform float radius;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vec4 c=vec4(0.0);c+=texture2D(inputBuffer,vUv0)*0.0625;c+=texture2D(inputBuffer,vUv1)*0.125;c+=texture2D(inputBuffer,vUv2)*0.0625;c+=texture2D(inputBuffer,vUv3)*0.125;c+=texture2D(inputBuffer,vUv)*0.25;c+=texture2D(inputBuffer,vUv4)*0.125;c+=texture2D(inputBuffer,vUv5)*0.0625;c+=texture2D(inputBuffer,vUv6)*0.125;c+=texture2D(inputBuffer,vUv7)*0.0625;vec4 baseColor=texture2D(supportBuffer,vUv);gl_FragColor=mix(baseColor,c,radius);
#include <colorspace_fragment>
}`,Gu="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vUv=position.xy*0.5+0.5;vUv0=vUv+texelSize*vec2(-1.0,1.0);vUv1=vUv+texelSize*vec2(0.0,1.0);vUv2=vUv+texelSize*vec2(1.0,1.0);vUv3=vUv+texelSize*vec2(-1.0,0.0);vUv4=vUv+texelSize*vec2(1.0,0.0);vUv5=vUv+texelSize*vec2(-1.0,-1.0);vUv6=vUv+texelSize*vec2(0.0,-1.0);vUv7=vUv+texelSize*vec2(1.0,-1.0);gl_Position=vec4(position.xy,1.0,1.0);}",ju=class extends Ee{constructor(){super({name:"UpsamplingMaterial",uniforms:{inputBuffer:new k(null),supportBuffer:new k(null),texelSize:new k(new F),radius:new k(.85)},blending:lt,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Hu,vertexShader:Gu})}set inputBuffer(i){this.uniforms.inputBuffer.value=i}set supportBuffer(i){this.uniforms.supportBuffer.value=i}get radius(){return this.uniforms.radius.value}set radius(i){this.uniforms.radius.value=i}setSize(i,t){this.uniforms.texelSize.value.set(1/i,1/t)}},Vu=class extends Pe{constructor(){super("MipmapBlurPass"),this.needsSwap=!1,this.renderTarget=new Ue(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Upsampling.Mipmap0",this.downsamplingMipmaps=[],this.upsamplingMipmaps=[],this.downsamplingMaterial=new zu,this.upsamplingMaterial=new ju,this.resolution=new F}get texture(){return this.renderTarget.texture}get levels(){return this.downsamplingMipmaps.length}set levels(i){if(this.levels!==i){const t=this.renderTarget;this.dispose(),this.downsamplingMipmaps=[],this.upsamplingMipmaps=[];for(let e=0;e<i;++e){const s=t.clone();s.texture.name="Downsampling.Mipmap"+e,this.downsamplingMipmaps.push(s)}this.upsamplingMipmaps.push(t);for(let e=1,s=i-1;e<s;++e){const n=t.clone();n.texture.name="Upsampling.Mipmap"+e,this.upsamplingMipmaps.push(n)}this.setSize(this.resolution.x,this.resolution.y)}}get radius(){return this.upsamplingMaterial.radius}set radius(i){this.upsamplingMaterial.radius=i}render(i,t,e,s,n){const{scene:r,camera:o}=this,{downsamplingMaterial:a,upsamplingMaterial:l}=this,{downsamplingMipmaps:c,upsamplingMipmaps:h}=this;let u=t;this.fullscreenMaterial=a;for(let d=0,f=c.length;d<f;++d){const g=c[d];a.setSize(u.width,u.height),a.inputBuffer=u.texture,i.setRenderTarget(g),i.render(r,o),u=g}this.fullscreenMaterial=l;for(let d=h.length-1;d>=0;--d){const f=h[d];l.setSize(u.width,u.height),l.inputBuffer=u.texture,l.supportBuffer=c[d].texture,i.setRenderTarget(f),i.render(r,o),u=f}}setSize(i,t){const e=this.resolution;e.set(i,t);let s=e.width,n=e.height;for(let r=0,o=this.downsamplingMipmaps.length;r<o;++r)s=Math.round(s*.5),n=Math.round(n*.5),this.downsamplingMipmaps[r].setSize(s,n),r<this.upsamplingMipmaps.length&&this.upsamplingMipmaps[r].setSize(s,n)}initialize(i,t,e){if(e!==void 0){const s=this.downsamplingMipmaps.concat(this.upsamplingMipmaps);for(const n of s)n.texture.type=e;if(e!==ot)this.downsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.upsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1";else if(i!==null&&i.outputColorSpace===Z)for(const n of s)n.texture.colorSpace=Z}}dispose(){super.dispose();for(const i of this.downsamplingMipmaps.concat(this.upsamplingMipmaps))i.dispose()}},qu=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D map;
#else
uniform lowp sampler2D map;
#endif
uniform float intensity;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec4 texel=texture2D(map,uv);outputColor=vec4(texel.rgb*intensity,texel.a);}`,Wu=class extends sn{constructor({blendFunction:i=G.SCREEN,luminanceThreshold:t=.9,luminanceSmoothing:e=.025,mipmapBlur:s=!1,intensity:n=1,radius:r=.85,levels:o=8,kernelSize:a=nn.LARGE,resolutionScale:l=.5,width:c=we.AUTO_SIZE,height:h=we.AUTO_SIZE,resolutionX:u=c,resolutionY:d=h}={}){super("BloomEffect",qu,{blendFunction:i,uniforms:new Map([["map",new k(null)],["intensity",new k(n)]])}),this.renderTarget=new Ue(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Bloom.Target",this.blurPass=new _a({kernelSize:a}),this.luminancePass=new Nu({colorOutput:!0}),this.luminanceMaterial.threshold=t,this.luminanceMaterial.smoothing=e,this.mipmapBlurPass=new Vu,this.mipmapBlurPass.enabled=s,this.mipmapBlurPass.radius=r,this.mipmapBlurPass.levels=o,this.uniforms.get("map").value=s?this.mipmapBlurPass.texture:this.renderTarget.texture;const f=this.resolution=new we(this,u,d,l);f.addEventListener("change",g=>this.setSize(f.baseWidth,f.baseHeight))}get texture(){return this.mipmapBlurPass.enabled?this.mipmapBlurPass.texture:this.renderTarget.texture}getTexture(){return this.texture}getResolution(){return this.resolution}getBlurPass(){return this.blurPass}getLuminancePass(){return this.luminancePass}get luminanceMaterial(){return this.luminancePass.fullscreenMaterial}getLuminanceMaterial(){return this.luminancePass.fullscreenMaterial}get width(){return this.resolution.width}set width(i){this.resolution.preferredWidth=i}get height(){return this.resolution.height}set height(i){this.resolution.preferredHeight=i}get dithering(){return this.blurPass.dithering}set dithering(i){this.blurPass.dithering=i}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(i){this.blurPass.kernelSize=i}get distinction(){return console.warn(this.name,"distinction was removed"),1}set distinction(i){console.warn(this.name,"distinction was removed")}get intensity(){return this.uniforms.get("intensity").value}set intensity(i){this.uniforms.get("intensity").value=i}getIntensity(){return this.intensity}setIntensity(i){this.intensity=i}getResolutionScale(){return this.resolution.scale}setResolutionScale(i){this.resolution.scale=i}update(i,t,e){const s=this.renderTarget,n=this.luminancePass;n.enabled?(n.render(i,t),this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(i,n.renderTarget):this.blurPass.render(i,n.renderTarget,s)):this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(i,t):this.blurPass.render(i,t,s)}setSize(i,t){const e=this.resolution;e.setBaseSize(i,t),this.renderTarget.setSize(e.width,e.height),this.blurPass.resolution.copy(e),this.luminancePass.setSize(i,t),this.mipmapBlurPass.setSize(i,t)}initialize(i,t,e){this.blurPass.initialize(i,t,e),this.luminancePass.initialize(i,t,e),this.mipmapBlurPass.initialize(i,t,e),e!==void 0&&(this.renderTarget.texture.type=e,i!==null&&i.outputColorSpace===Z&&(this.renderTarget.texture.colorSpace=Z))}},Ku="uniform float brightness;uniform float contrast;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 color=inputColor.rgb+vec3(brightness-0.5);if(contrast>0.0){color/=vec3(1.0-contrast);}else{color*=vec3(1.0+contrast);}outputColor=vec4(color+vec3(0.5),inputColor.a);}",Xu=class extends sn{constructor({blendFunction:i=G.SRC,brightness:t=0,contrast:e=0}={}){super("BrightnessContrastEffect",Ku,{blendFunction:i,uniforms:new Map([["brightness",new k(t)],["contrast",new k(e)]])}),this.inputColorSpace=Z}get brightness(){return this.uniforms.get("brightness").value}set brightness(i){this.uniforms.get("brightness").value=i}getBrightness(){return this.brightness}setBrightness(i){this.brightness=i}get contrast(){return this.uniforms.get("contrast").value}set contrast(i){this.uniforms.get("contrast").value=i}getContrast(){return this.contrast}setContrast(i){this.contrast=i}},Pa=class extends Pe{constructor(i,t="inputBuffer"){super("ShaderPass"),this.fullscreenMaterial=i,this.input=t}setInput(i){this.input=i}render(i,t,e,s,n){const r=this.fullscreenMaterial.uniforms;t!==null&&r!==void 0&&r[this.input]!==void 0&&(r[this.input].value=t.texture),i.setRenderTarget(this.renderToScreen?null:e),i.render(this.scene,this.camera)}initialize(i,t,e){e!==void 0&&e!==ot&&(this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}},Fs={DEFAULT:0,KEEP_MAX_DEPTH:1,DISCARD_MAX_DEPTH:2},Yu=`#include <common>
#include <packing>
#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer0;uniform highp sampler2D depthBuffer1;
#else
uniform mediump sampler2D depthBuffer0;uniform mediump sampler2D depthBuffer1;
#endif
uniform sampler2D inputBuffer;uniform vec2 cameraNearFar;float getViewZ(const in float depth){
#ifdef PERSPECTIVE_CAMERA
return perspectiveDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);
#else
return orthographicDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);
#endif
}varying vec2 vUv;void main(){vec2 depth;
#if DEPTH_PACKING_0 == 3201
depth.x=unpackRGBAToDepth(texture2D(depthBuffer0,vUv));
#else
depth.x=texture2D(depthBuffer0,vUv).r;
#ifdef LOG_DEPTH
float d=pow(2.0,depth.x*log2(cameraNearFar.y+1.0))-1.0;float a=cameraNearFar.y/(cameraNearFar.y-cameraNearFar.x);float b=cameraNearFar.y*cameraNearFar.x/(cameraNearFar.x-cameraNearFar.y);depth.x=a+b/d;
#endif
#endif
#if DEPTH_PACKING_1 == 3201
depth.y=unpackRGBAToDepth(texture2D(depthBuffer1,vUv));
#else
depth.y=texture2D(depthBuffer1,vUv).r;
#ifdef LOG_DEPTH
float d=pow(2.0,depth.y*log2(cameraNearFar.y+1.0))-1.0;float a=cameraNearFar.y/(cameraNearFar.y-cameraNearFar.x);float b=cameraNearFar.y*cameraNearFar.x/(cameraNearFar.x-cameraNearFar.y);depth.y=a+b/d;
#endif
#endif
bool isMaxDepth=(depth.x==1.0);
#ifdef PERSPECTIVE_CAMERA
depth.x=viewZToOrthographicDepth(getViewZ(depth.x),cameraNearFar.x,cameraNearFar.y);depth.y=viewZToOrthographicDepth(getViewZ(depth.y),cameraNearFar.x,cameraNearFar.y);
#endif
#if DEPTH_TEST_STRATEGY == 0
bool keep=depthTest(depth.x,depth.y);
#elif DEPTH_TEST_STRATEGY == 1
bool keep=isMaxDepth||depthTest(depth.x,depth.y);
#else
bool keep=!isMaxDepth&&depthTest(depth.x,depth.y);
#endif
if(keep){gl_FragColor=texture2D(inputBuffer,vUv);}else{discard;}}`,$u=class extends Ee{constructor(){super({name:"DepthMaskMaterial",defines:{DEPTH_EPSILON:"0.0001",DEPTH_PACKING_0:"0",DEPTH_PACKING_1:"0",DEPTH_TEST_STRATEGY:Fs.KEEP_MAX_DEPTH},uniforms:{inputBuffer:new k(null),depthBuffer0:new k(null),depthBuffer1:new k(null),cameraNearFar:new k(new F(1,1))},blending:lt,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Yu,vertexShader:gr}),this.depthMode=Ur}set depthBuffer0(i){this.uniforms.depthBuffer0.value=i}set depthPacking0(i){this.defines.DEPTH_PACKING_0=i.toFixed(0),this.needsUpdate=!0}setDepthBuffer0(i,t=zt){this.depthBuffer0=i,this.depthPacking0=t}set depthBuffer1(i){this.uniforms.depthBuffer1.value=i}set depthPacking1(i){this.defines.DEPTH_PACKING_1=i.toFixed(0),this.needsUpdate=!0}setDepthBuffer1(i,t=zt){this.depthBuffer1=i,this.depthPacking1=t}get maxDepthStrategy(){return Number(this.defines.DEPTH_TEST_STRATEGY)}set maxDepthStrategy(i){this.defines.DEPTH_TEST_STRATEGY=i.toFixed(0),this.needsUpdate=!0}get keepFar(){return this.maxDepthStrategy}set keepFar(i){this.maxDepthStrategy=i?Fs.KEEP_MAX_DEPTH:Fs.DISCARD_MAX_DEPTH}getMaxDepthStrategy(){return this.maxDepthStrategy}setMaxDepthStrategy(i){this.maxDepthStrategy=i}get epsilon(){return Number(this.defines.DEPTH_EPSILON)}set epsilon(i){this.defines.DEPTH_EPSILON=i.toFixed(16),this.needsUpdate=!0}getEpsilon(){return this.epsilon}setEpsilon(i){this.epsilon=i}get depthMode(){return Number(this.defines.DEPTH_MODE)}set depthMode(i){let t;switch(i){case Fl:t="false";break;case Ol:t="true";break;case Vn:t="abs(d1 - d0) <= DEPTH_EPSILON";break;case ca:t="abs(d1 - d0) > DEPTH_EPSILON";break;case Ur:t="d0 > d1";break;case Il:t="d0 >= d1";break;case Bl:t="d0 <= d1";break;case Dl:default:t="d0 < d1";break}this.defines.DEPTH_MODE=i.toFixed(0),this.defines["depthTest(d0, d1)"]=t,this.needsUpdate=!0}getDepthMode(){return this.depthMode}setDepthMode(i){this.depthMode=i}adoptCameraSettings(i){this.copyCameraSettings(i)}copyCameraSettings(i){i&&(this.uniforms.cameraNearFar.value.set(i.near,i.far),i instanceof ms?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}},vr=class extends Pe{constructor(i,t,e=null){super("RenderPass",i,t),this.needsSwap=!1,this.clearPass=new tn,this.overrideMaterialManager=e===null?null:new Zr(e),this.ignoreBackground=!1,this.skipShadowMapUpdate=!1,this.selection=null}set mainScene(i){this.scene=i}set mainCamera(i){this.camera=i}get renderToScreen(){return super.renderToScreen}set renderToScreen(i){super.renderToScreen=i,this.clearPass.renderToScreen=i}get overrideMaterial(){const i=this.overrideMaterialManager;return i!==null?i.material:null}set overrideMaterial(i){const t=this.overrideMaterialManager;i!==null?t!==null?t.setMaterial(i):this.overrideMaterialManager=new Zr(i):t!==null&&(t.dispose(),this.overrideMaterialManager=null)}getOverrideMaterial(){return this.overrideMaterial}setOverrideMaterial(i){this.overrideMaterial=i}get clear(){return this.clearPass.enabled}set clear(i){this.clearPass.enabled=i}getSelection(){return this.selection}setSelection(i){this.selection=i}isBackgroundDisabled(){return this.ignoreBackground}setBackgroundDisabled(i){this.ignoreBackground=i}isShadowMapDisabled(){return this.skipShadowMapUpdate}setShadowMapDisabled(i){this.skipShadowMapUpdate=i}getClearPass(){return this.clearPass}render(i,t,e,s,n){const r=this.scene,o=this.camera,a=this.selection,l=o.layers.mask,c=r.background,h=i.shadowMap.autoUpdate,u=this.renderToScreen?null:t;a!==null&&o.layers.set(a.getLayer()),this.skipShadowMapUpdate&&(i.shadowMap.autoUpdate=!1),(this.ignoreBackground||this.clearPass.overrideClearColor!==null)&&(r.background=null),this.clearPass.enabled&&this.clearPass.render(i,t),i.setRenderTarget(u),this.overrideMaterialManager!==null?this.overrideMaterialManager.render(i,r,o):i.render(r,o),o.layers.mask=l,r.background=c,i.shadowMap.autoUpdate=h}},Zu="uniform vec3 hue;uniform float saturation;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 color=vec3(dot(inputColor.rgb,hue.xyz),dot(inputColor.rgb,hue.zxy),dot(inputColor.rgb,hue.yzx));float average=(color.r+color.g+color.b)/3.0;vec3 diff=average-color;if(saturation>0.0){color+=diff*(1.0-1.0/(1.001-saturation));}else{color+=diff*-saturation;}outputColor=vec4(min(color,1.0),inputColor.a);}",Qu=class extends sn{constructor({blendFunction:i=G.SRC,hue:t=0,saturation:e=0}={}){super("HueSaturationEffect",Zu,{blendFunction:i,uniforms:new Map([["hue",new k(new M)],["saturation",new k(e)]])}),this.hue=t}get saturation(){return this.uniforms.get("saturation").value}set saturation(i){this.uniforms.get("saturation").value=i}getSaturation(){return this.saturation}setSaturation(i){this.saturation=i}get hue(){const i=this.uniforms.get("hue").value;return Math.acos((i.x*3-1)/2)}set hue(i){const t=Math.sin(i),e=Math.cos(i);this.uniforms.get("hue").value.set((2*e+1)/3,(-Math.sqrt(3)*t-e+1)/3,(Math.sqrt(3)*t-e+1)/3)}getHue(){return this.hue}setHue(i){this.hue=i}},Ju=`#include <packing>
#include <clipping_planes_pars_fragment>
#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
uniform float cameraNear;uniform float cameraFar;centroid varying float vViewZ;centroid varying vec4 vProjTexCoord;void main(){
#include <clipping_planes_fragment>
vec2 projTexCoord=(vProjTexCoord.xy/vProjTexCoord.w)*0.5+0.5;projTexCoord=clamp(projTexCoord,0.002,0.998);
#if DEPTH_PACKING == 3201
float fragCoordZ=unpackRGBAToDepth(texture2D(depthBuffer,projTexCoord));
#else
float fragCoordZ=texture2D(depthBuffer,projTexCoord).r;
#endif
#ifdef PERSPECTIVE_CAMERA
float viewZ=perspectiveDepthToViewZ(fragCoordZ,cameraNear,cameraFar);
#else
float viewZ=orthographicDepthToViewZ(fragCoordZ,cameraNear,cameraFar);
#endif
float depthTest=(-vViewZ>-viewZ)?1.0:0.0;gl_FragColor.rg=vec2(0.0,depthTest);}`,eh=`#include <common>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <clipping_planes_pars_vertex>
varying float vViewZ;varying vec4 vProjTexCoord;void main(){
#include <skinbase_vertex>
#include <begin_vertex>
#include <morphtarget_vertex>
#include <skinning_vertex>
#include <project_vertex>
vViewZ=mvPosition.z;vProjTexCoord=gl_Position;
#include <clipping_planes_vertex>
}`,th=class extends Ee{constructor(i=null,t){super({name:"DepthComparisonMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new k(null),cameraNear:new k(.3),cameraFar:new k(1e3)},blending:lt,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Ju,vertexShader:eh}),this.depthBuffer=i,this.depthPacking=Ei,this.copyCameraSettings(t)}set depthBuffer(i){this.uniforms.depthBuffer.value=i}set depthPacking(i){this.defines.DEPTH_PACKING=i.toFixed(0),this.needsUpdate=!0}setDepthBuffer(i,t=Ei){this.depthBuffer=i,this.depthPacking=t}adoptCameraSettings(i){this.copyCameraSettings(i)}copyCameraSettings(i){i&&(this.uniforms.cameraNear.value=i.near,this.uniforms.cameraFar.value=i.far,i instanceof ms?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}},sh="uniform lowp sampler2D inputBuffer;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 c0=texture2D(inputBuffer,vUv0).rg;vec2 c1=texture2D(inputBuffer,vUv1).rg;vec2 c2=texture2D(inputBuffer,vUv2).rg;vec2 c3=texture2D(inputBuffer,vUv3).rg;float d0=(c0.x-c1.x)*0.5;float d1=(c2.x-c3.x)*0.5;float d=length(vec2(d0,d1));float a0=min(c0.y,c1.y);float a1=min(c2.y,c3.y);float visibilityFactor=min(a0,a1);gl_FragColor.rg=(1.0-visibilityFactor>0.001)?vec2(d,0.0):vec2(0.0,d);}",ih="uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=vec2(uv.x+texelSize.x,uv.y);vUv1=vec2(uv.x-texelSize.x,uv.y);vUv2=vec2(uv.x,uv.y+texelSize.y);vUv3=vec2(uv.x,uv.y-texelSize.y);gl_Position=vec4(position.xy,1.0,1.0);}",nh=class extends Ee{constructor(i=new F){super({name:"OutlineMaterial",uniforms:{inputBuffer:new k(null),texelSize:new k(new F)},blending:lt,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:sh,vertexShader:ih}),this.uniforms.texelSize.value.set(i.x,i.y),this.uniforms.maskTexture=this.uniforms.inputBuffer}set inputBuffer(i){this.uniforms.inputBuffer.value=i}setInputBuffer(i){this.uniforms.inputBuffer.value=i}setTexelSize(i,t){this.uniforms.texelSize.value.set(i,t)}setSize(i,t){this.uniforms.texelSize.value.set(1/i,1/t)}},Ra=class extends Pe{constructor(i,t,{renderTarget:e,resolutionScale:s=1,width:n=we.AUTO_SIZE,height:r=we.AUTO_SIZE,resolutionX:o=n,resolutionY:a=r}={}){super("DepthPass"),this.needsSwap=!1,this.renderPass=new vr(i,t,new Ll({depthPacking:Ei}));const l=this.renderPass;l.skipShadowMapUpdate=!0,l.ignoreBackground=!0;const c=l.clearPass;c.overrideClearColor=new U(16777215),c.overrideClearAlpha=1,this.renderTarget=e,this.renderTarget===void 0&&(this.renderTarget=new Ue(1,1,{minFilter:qn,magFilter:qn}),this.renderTarget.texture.name="DepthPass.Target");const h=this.resolution=new we(this,o,a,s);h.addEventListener("change",u=>this.setSize(h.baseWidth,h.baseHeight))}set mainScene(i){this.renderPass.mainScene=i}set mainCamera(i){this.renderPass.mainCamera=i}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}getResolutionScale(){return this.resolution.scale}setResolutionScale(i){this.resolution.scale=i}render(i,t,e,s,n){const r=this.renderToScreen?null:this.renderTarget;this.renderPass.render(i,r)}setSize(i,t){const e=this.resolution;e.setBaseSize(i,t),this.renderTarget.setSize(e.width,e.height)}},rh=`uniform lowp sampler2D edgeTexture;uniform lowp sampler2D maskTexture;uniform vec3 visibleEdgeColor;uniform vec3 hiddenEdgeColor;uniform float pulse;uniform float edgeStrength;
#ifdef USE_PATTERN
uniform lowp sampler2D patternTexture;varying vec2 vUvPattern;
#endif
void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec2 edge=texture2D(edgeTexture,uv).rg;vec2 mask=texture2D(maskTexture,uv).rg;
#ifndef X_RAY
edge.y=0.0;
#endif
edge*=(edgeStrength*mask.x*pulse);vec3 color=edge.x*visibleEdgeColor+edge.y*hiddenEdgeColor;float visibilityFactor=0.0;
#ifdef USE_PATTERN
vec4 patternColor=texture2D(patternTexture,vUvPattern);
#ifdef X_RAY
float hiddenFactor=0.5;
#else
float hiddenFactor=0.0;
#endif
visibilityFactor=(1.0-mask.y>0.0)?1.0:hiddenFactor;visibilityFactor*=(1.0-mask.x)*patternColor.a;color+=visibilityFactor*patternColor.rgb;
#endif
float alpha=max(max(edge.x,edge.y),visibilityFactor);
#ifdef ALPHA
outputColor=vec4(color,alpha);
#else
outputColor=vec4(color,max(alpha,inputColor.a));
#endif
}`,oh="uniform float patternScale;varying vec2 vUvPattern;void mainSupport(const in vec2 uv){vUvPattern=uv*vec2(aspect,1.0)*patternScale;}",Qr=class extends sn{constructor(i,t,{blendFunction:e=G.SCREEN,patternTexture:s=null,patternScale:n=1,edgeStrength:r=1,pulseSpeed:o=0,visibleEdgeColor:a=16777215,hiddenEdgeColor:l=2230538,kernelSize:c=nn.VERY_SMALL,blur:h=!1,xRay:u=!0,multisampling:d=0,resolutionScale:f=.5,width:g=we.AUTO_SIZE,height:v=we.AUTO_SIZE,resolutionX:p=g,resolutionY:m=v}={}){super("OutlineEffect",rh,{uniforms:new Map([["maskTexture",new k(null)],["edgeTexture",new k(null)],["edgeStrength",new k(r)],["visibleEdgeColor",new k(new U(a))],["hiddenEdgeColor",new k(new U(l))],["pulse",new k(1)],["patternScale",new k(n)],["patternTexture",new k(null)]])}),this.blendMode.addEventListener("change",w=>{this.blendMode.blendFunction===G.ALPHA?this.defines.set("ALPHA","1"):this.defines.delete("ALPHA"),this.setChanged()}),this.blendMode.blendFunction=e,this.patternTexture=s,this.xRay=u,this.scene=i,this.camera=t,this.renderTargetMask=new Ue(1,1),this.renderTargetMask.samples=d,this.renderTargetMask.texture.name="Outline.Mask",this.uniforms.get("maskTexture").value=this.renderTargetMask.texture,this.renderTargetOutline=new Ue(1,1,{depthBuffer:!1}),this.renderTargetOutline.texture.name="Outline.Edges",this.uniforms.get("edgeTexture").value=this.renderTargetOutline.texture,this.clearPass=new tn,this.clearPass.overrideClearColor=new U(0),this.clearPass.overrideClearAlpha=1,this.depthPass=new Ra(i,t),this.maskPass=new vr(i,t,new th(this.depthPass.texture,t));const y=this.maskPass.clearPass;y.overrideClearColor=new U(16777215),y.overrideClearAlpha=1,this.blurPass=new _a({resolutionScale:f,resolutionX:p,resolutionY:m,kernelSize:c}),this.blurPass.enabled=h;const x=this.blurPass.resolution;x.addEventListener("change",w=>this.setSize(x.baseWidth,x.baseHeight)),this.outlinePass=new Pa(new nh);const b=this.outlinePass.fullscreenMaterial;b.inputBuffer=this.renderTargetMask.texture,this.time=0,this.forceUpdate=!0,this.selection=new Ca,this.pulseSpeed=o}set mainScene(i){this.scene=i,this.depthPass.mainScene=i,this.maskPass.mainScene=i}set mainCamera(i){this.camera=i,this.depthPass.mainCamera=i,this.maskPass.mainCamera=i,this.maskPass.overrideMaterial.copyCameraSettings(i)}get resolution(){return this.blurPass.resolution}getResolution(){return this.blurPass.getResolution()}get multisampling(){return this.renderTargetMask.samples}set multisampling(i){this.renderTargetMask.samples=i,this.renderTargetMask.dispose()}get patternScale(){return this.uniforms.get("patternScale").value}set patternScale(i){this.uniforms.get("patternScale").value=i}get edgeStrength(){return this.uniforms.get("edgeStrength").value}set edgeStrength(i){this.uniforms.get("edgeStrength").value=i}get visibleEdgeColor(){return this.uniforms.get("visibleEdgeColor").value}set visibleEdgeColor(i){this.uniforms.get("visibleEdgeColor").value=i}get hiddenEdgeColor(){return this.uniforms.get("hiddenEdgeColor").value}set hiddenEdgeColor(i){this.uniforms.get("hiddenEdgeColor").value=i}getBlurPass(){return this.blurPass}getSelection(){return this.selection}getPulseSpeed(){return this.pulseSpeed}setPulseSpeed(i){this.pulseSpeed=i}get width(){return this.resolution.width}set width(i){this.resolution.preferredWidth=i}get height(){return this.resolution.height}set height(i){this.resolution.preferredHeight=i}get selectionLayer(){return this.selection.layer}set selectionLayer(i){this.selection.layer=i}get dithering(){return this.blurPass.dithering}set dithering(i){this.blurPass.dithering=i}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(i){this.blurPass.kernelSize=i}get blur(){return this.blurPass.enabled}set blur(i){this.blurPass.enabled=i}get xRay(){return this.defines.has("X_RAY")}set xRay(i){this.xRay!==i&&(i?this.defines.set("X_RAY","1"):this.defines.delete("X_RAY"),this.setChanged())}isXRayEnabled(){return this.xRay}setXRayEnabled(i){this.xRay=i}get patternTexture(){return this.uniforms.get("patternTexture").value}set patternTexture(i){i!==null?(i.wrapS=i.wrapT=kt,this.defines.set("USE_PATTERN","1"),this.setVertexShader(oh)):(this.defines.delete("USE_PATTERN"),this.setVertexShader(null)),this.uniforms.get("patternTexture").value=i,this.setChanged()}setPatternTexture(i){this.patternTexture=i}getResolutionScale(){return this.resolution.scale}setResolutionScale(i){this.resolution.scale=i}setSelection(i){return this.selection.set(i),this}clearSelection(){return this.selection.clear(),this}selectObject(i){return this.selection.add(i),this}deselectObject(i){return this.selection.delete(i),this}update(i,t,e){const s=this.scene,n=this.camera,r=this.selection,a=this.uniforms.get("pulse"),l=s.background,c=n.layers.mask;(this.forceUpdate||r.size>0)&&(s.background=null,a.value=1,this.pulseSpeed>0&&(a.value=Math.cos(this.time*this.pulseSpeed*10)*.375+.625),this.time+=e,r.setVisible(!1),this.depthPass.render(i),r.setVisible(!0),n.layers.set(r.layer),this.maskPass.render(i,this.renderTargetMask),n.layers.mask=c,s.background=l,this.outlinePass.render(i,null,this.renderTargetOutline),this.blurPass.enabled&&this.blurPass.render(i,this.renderTargetOutline,this.renderTargetOutline)),this.forceUpdate=r.size>0}setSize(i,t){this.blurPass.setSize(i,t),this.renderTargetMask.setSize(i,t);const e=this.resolution;e.setBaseSize(i,t);const s=e.width,n=e.height;this.depthPass.setSize(s,n),this.renderTargetOutline.setSize(s,n),this.outlinePass.fullscreenMaterial.setSize(s,n)}initialize(i,t,e){this.blurPass.initialize(i,t,ot),e!==void 0&&(this.depthPass.initialize(i,t,e),this.maskPass.initialize(i,t,e),this.outlinePass.initialize(i,t,e))}},ah=class extends Wu{constructor(i,t,e){super(e),this.setAttributes(this.getAttributes()|Et.DEPTH),this.camera=t,this.depthPass=new Ra(i,t),this.clearPass=new tn(!0,!1,!1),this.clearPass.overrideClearColor=new U(0),this.depthMaskPass=new Pa(new $u);const s=this.depthMaskMaterial;s.copyCameraSettings(t),s.depthBuffer1=this.depthPass.texture,s.depthPacking1=Ei,s.depthMode=Vn,this.renderTargetMasked=new Ue(1,1,{depthBuffer:!1}),this.renderTargetMasked.texture.name="Bloom.Masked",this.selection=new Ca,this._inverted=!1,this._ignoreBackground=!1}set mainScene(i){this.depthPass.mainScene=i}set mainCamera(i){this.camera=i,this.depthPass.mainCamera=i,this.depthMaskMaterial.copyCameraSettings(i)}getSelection(){return this.selection}get depthMaskMaterial(){return this.depthMaskPass.fullscreenMaterial}get inverted(){return this._inverted}set inverted(i){this._inverted=i,this.depthMaskMaterial.depthMode=i?ca:Vn}isInverted(){return this.inverted}setInverted(i){this.inverted=i}get ignoreBackground(){return this._ignoreBackground}set ignoreBackground(i){this._ignoreBackground=i,this.depthMaskMaterial.maxDepthStrategy=i?Fs.DISCARD_MAX_DEPTH:Fs.KEEP_MAX_DEPTH}isBackgroundDisabled(){return this.ignoreBackground}setBackgroundDisabled(i){this.ignoreBackground=i}setDepthTexture(i,t=zt){this.depthMaskMaterial.depthBuffer0=i,this.depthMaskMaterial.depthPacking0=t}update(i,t,e){const s=this.camera,n=this.selection,r=this.inverted;let o=t;if(this.ignoreBackground||!r||n.size>0){const a=s.layers.mask;s.layers.set(n.layer),this.depthPass.render(i),s.layers.mask=a,o=this.renderTargetMasked,this.clearPass.render(i,o),this.depthMaskPass.render(i,t,o)}super.update(i,o,e)}setSize(i,t){super.setSize(i,t),this.renderTargetMasked.setSize(i,t),this.depthPass.setSize(i,t)}initialize(i,t,e){super.initialize(i,t,e),this.clearPass.initialize(i,t,e),this.depthPass.initialize(i,t,e),this.depthMaskPass.initialize(i,t,e),i!==null&&i.capabilities.logarithmicDepthBuffer&&(this.depthMaskPass.fullscreenMaterial.defines.LOG_DEPTH="1"),e!==void 0&&(this.renderTargetMasked.texture.type=e,i!==null&&i.outputColorSpace===Z&&(this.renderTargetMasked.texture.colorSpace=Z))}},lh=`#include <common>
#include <packing>
#include <dithering_pars_fragment>
#define packFloatToRGBA(v) packDepthToRGBA(v)
#define unpackRGBAToFloat(v) unpackRGBAToDepth(v)
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#if DEPTH_PACKING == 3201
uniform lowp sampler2D depthBuffer;
#elif defined(GL_FRAGMENT_PRECISION_HIGH)
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;vec4 sRGBToLinear(const in vec4 value){return vec4(mix(pow(value.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),value.rgb*0.0773993808,vec3(lessThanEqual(value.rgb,vec3(0.04045)))),value.a);}float readDepth(const in vec2 uv){
#if DEPTH_PACKING == 3201
return unpackRGBAToDepth(texture2D(depthBuffer,uv));
#else
return texture2D(depthBuffer,uv).r;
#endif
}float getViewZ(const in float depth){
#ifdef PERSPECTIVE_CAMERA
return perspectiveDepthToViewZ(depth,cameraNear,cameraFar);
#else
return orthographicDepthToViewZ(depth,cameraNear,cameraFar);
#endif
}vec3 RGBToHCV(const in vec3 RGB){vec4 P=mix(vec4(RGB.bg,-1.0,2.0/3.0),vec4(RGB.gb,0.0,-1.0/3.0),step(RGB.b,RGB.g));vec4 Q=mix(vec4(P.xyw,RGB.r),vec4(RGB.r,P.yzx),step(P.x,RGB.r));float C=Q.x-min(Q.w,Q.y);float H=abs((Q.w-Q.y)/(6.0*C+EPSILON)+Q.z);return vec3(H,C,Q.x);}vec3 RGBToHSL(const in vec3 RGB){vec3 HCV=RGBToHCV(RGB);float L=HCV.z-HCV.y*0.5;float S=HCV.y/(1.0-abs(L*2.0-1.0)+EPSILON);return vec3(HCV.x,S,L);}vec3 HueToRGB(const in float H){float R=abs(H*6.0-3.0)-1.0;float G=2.0-abs(H*6.0-2.0);float B=2.0-abs(H*6.0-4.0);return clamp(vec3(R,G,B),0.0,1.0);}vec3 HSLToRGB(const in vec3 HSL){vec3 RGB=HueToRGB(HSL.x);float C=(1.0-abs(2.0*HSL.z-1.0))*HSL.y;return(RGB-0.5)*C+HSL.z;}FRAGMENT_HEAD void main(){FRAGMENT_MAIN_UV vec4 color0=texture2D(inputBuffer,UV);vec4 color1=vec4(0.0);FRAGMENT_MAIN_IMAGE color0.a=clamp(color0.a,0.0,1.0);gl_FragColor=color0;
#ifdef ENCODE_OUTPUT
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
}`,ch="uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;VERTEX_HEAD void main(){vUv=position.xy*0.5+0.5;VERTEX_MAIN_SUPPORT gl_Position=vec4(position.xy,1.0,1.0);}",uh=class extends Ee{constructor(i,t,e,s,n=!1){super({name:"EffectMaterial",defines:{THREE_REVISION:da.replace(/\D+/g,""),DEPTH_PACKING:"0",ENCODE_OUTPUT:"1"},uniforms:{inputBuffer:new k(null),depthBuffer:new k(null),resolution:new k(new F),texelSize:new k(new F),cameraNear:new k(.3),cameraFar:new k(1e3),aspect:new k(1),time:new k(0)},blending:lt,toneMapped:!1,depthWrite:!1,depthTest:!1,dithering:n}),i&&this.setShaderParts(i),t&&this.setDefines(t),e&&this.setUniforms(e),this.copyCameraSettings(s)}set inputBuffer(i){this.uniforms.inputBuffer.value=i}setInputBuffer(i){this.uniforms.inputBuffer.value=i}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(i){this.uniforms.depthBuffer.value=i}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(i){this.defines.DEPTH_PACKING=i.toFixed(0),this.needsUpdate=!0}setDepthBuffer(i,t=zt){this.depthBuffer=i,this.depthPacking=t}setShaderData(i){this.setShaderParts(i.shaderParts),this.setDefines(i.defines),this.setUniforms(i.uniforms),this.setExtensions(i.extensions)}setShaderParts(i){return this.fragmentShader=lh.replace(W.FRAGMENT_HEAD,i.get(W.FRAGMENT_HEAD)||"").replace(W.FRAGMENT_MAIN_UV,i.get(W.FRAGMENT_MAIN_UV)||"").replace(W.FRAGMENT_MAIN_IMAGE,i.get(W.FRAGMENT_MAIN_IMAGE)||""),this.vertexShader=ch.replace(W.VERTEX_HEAD,i.get(W.VERTEX_HEAD)||"").replace(W.VERTEX_MAIN_SUPPORT,i.get(W.VERTEX_MAIN_SUPPORT)||""),this.needsUpdate=!0,this}setDefines(i){for(const t of i.entries())this.defines[t[0]]=t[1];return this.needsUpdate=!0,this}setUniforms(i){for(const t of i.entries())this.uniforms[t[0]]=t[1];return this}setExtensions(i){this.extensions={};for(const t of i)this.extensions[t]=!0;return this}get encodeOutput(){return this.defines.ENCODE_OUTPUT!==void 0}set encodeOutput(i){this.encodeOutput!==i&&(i?this.defines.ENCODE_OUTPUT="1":delete this.defines.ENCODE_OUTPUT,this.needsUpdate=!0)}isOutputEncodingEnabled(i){return this.encodeOutput}setOutputEncodingEnabled(i){this.encodeOutput=i}get time(){return this.uniforms.time.value}set time(i){this.uniforms.time.value=i}setDeltaTime(i){this.uniforms.time.value+=i}adoptCameraSettings(i){this.copyCameraSettings(i)}copyCameraSettings(i){i&&(this.uniforms.cameraNear.value=i.near,this.uniforms.cameraFar.value=i.far,i instanceof ms?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(i,t){const e=this.uniforms;e.resolution.value.set(i,t),e.texelSize.value.set(1/i,1/t),e.aspect.value=i/t}static get Section(){return W}};function Jr(i,t,e){for(const s of t){const n="$1"+i+s.charAt(0).toUpperCase()+s.slice(1),r=new RegExp("([^\\.])(\\b"+s+"\\b)","g");for(const o of e.entries())o[1]!==null&&e.set(o[0],o[1].replace(r,n))}}function hh(i,t,e){let s=t.getFragmentShader(),n=t.getVertexShader();const r=s!==void 0&&/mainImage/.test(s),o=s!==void 0&&/mainUv/.test(s);if(e.attributes|=t.getAttributes(),s===void 0)throw new Error(`Missing fragment shader (${t.name})`);if(o&&e.attributes&Et.CONVOLUTION)throw new Error(`Effects that transform UVs are incompatible with convolution effects (${t.name})`);if(!r&&!o)throw new Error(`Could not find mainImage or mainUv function (${t.name})`);{const a=/\w+\s+(\w+)\([\w\s,]*\)\s*{/g,l=e.shaderParts;let c=l.get(W.FRAGMENT_HEAD)||"",h=l.get(W.FRAGMENT_MAIN_UV)||"",u=l.get(W.FRAGMENT_MAIN_IMAGE)||"",d=l.get(W.VERTEX_HEAD)||"",f=l.get(W.VERTEX_MAIN_SUPPORT)||"";const g=new Set,v=new Set;if(o&&(h+=`	${i}MainUv(UV);
`,e.uvTransformation=!0),n!==null&&/mainSupport/.test(n)){const y=/mainSupport *\([\w\s]*?uv\s*?\)/.test(n);f+=`	${i}MainSupport(`,f+=y?`vUv);
`:`);
`;for(const x of n.matchAll(/(?:varying\s+\w+\s+([\S\s]*?);)/g))for(const b of x[1].split(/\s*,\s*/))e.varyings.add(b),g.add(b),v.add(b);for(const x of n.matchAll(a))v.add(x[1])}for(const y of s.matchAll(a))v.add(y[1]);for(const y of t.defines.keys())v.add(y.replace(/\([\w\s,]*\)/g,""));for(const y of t.uniforms.keys())v.add(y);v.delete("while"),v.delete("for"),v.delete("if"),t.uniforms.forEach((y,x)=>e.uniforms.set(i+x.charAt(0).toUpperCase()+x.slice(1),y)),t.defines.forEach((y,x)=>e.defines.set(i+x.charAt(0).toUpperCase()+x.slice(1),y));const p=new Map([["fragment",s],["vertex",n]]);Jr(i,v,e.defines),Jr(i,v,p),s=p.get("fragment"),n=p.get("vertex");const m=t.blendMode;if(e.blendModes.set(m.blendFunction,m),r){t.inputColorSpace!==null&&t.inputColorSpace!==e.colorSpace&&(u+=t.inputColorSpace===Z?`color0 = sRGBTransferOETF(color0);
	`:`color0 = sRGBToLinear(color0);
	`),t.outputColorSpace!==ha?e.colorSpace=t.outputColorSpace:t.inputColorSpace!==null&&(e.colorSpace=t.inputColorSpace);const y=/MainImage *\([\w\s,]*?depth[\w\s,]*?\)/;u+=`${i}MainImage(color0, UV, `,e.attributes&Et.DEPTH&&y.test(s)&&(u+="depth, ",e.readDepth=!0),u+=`color1);
	`;const x=i+"BlendOpacity";e.uniforms.set(x,m.opacity),u+=`color0 = blend${m.blendFunction}(color0, color1, ${x});

	`,c+=`uniform float ${x};

`}if(c+=s+`
`,n!==null&&(d+=n+`
`),l.set(W.FRAGMENT_HEAD,c),l.set(W.FRAGMENT_MAIN_UV,h),l.set(W.FRAGMENT_MAIN_IMAGE,u),l.set(W.VERTEX_HEAD,d),l.set(W.VERTEX_MAIN_SUPPORT,f),t.extensions!==null)for(const y of t.extensions)e.extensions.add(y)}}var dh=class extends Pe{constructor(i,...t){super("EffectPass"),this.fullscreenMaterial=new uh(null,null,null,i),this.listener=e=>this.handleEvent(e),this.effects=[],this.setEffects(t),this.skipRendering=!1,this.minTime=1,this.maxTime=Number.POSITIVE_INFINITY,this.timeScale=1}set mainScene(i){for(const t of this.effects)t.mainScene=i}set mainCamera(i){this.fullscreenMaterial.copyCameraSettings(i);for(const t of this.effects)t.mainCamera=i}get encodeOutput(){return this.fullscreenMaterial.encodeOutput}set encodeOutput(i){this.fullscreenMaterial.encodeOutput=i}get dithering(){return this.fullscreenMaterial.dithering}set dithering(i){const t=this.fullscreenMaterial;t.dithering=i,t.needsUpdate=!0}setEffects(i){for(const t of this.effects)t.removeEventListener("change",this.listener);this.effects=i.sort((t,e)=>e.attributes-t.attributes);for(const t of this.effects)t.addEventListener("change",this.listener)}updateMaterial(){const i=new Yc;let t=0;for(const o of this.effects)if(o.blendMode.blendFunction===G.DST)i.attributes|=o.getAttributes()&Et.DEPTH;else{if(i.attributes&o.getAttributes()&Et.CONVOLUTION)throw new Error(`Convolution effects cannot be merged (${o.name})`);hh("e"+t++,o,i)}let e=i.shaderParts.get(W.FRAGMENT_HEAD),s=i.shaderParts.get(W.FRAGMENT_MAIN_IMAGE),n=i.shaderParts.get(W.FRAGMENT_MAIN_UV);const r=/\bblend\b/g;for(const o of i.blendModes.values())e+=o.getShaderCode().replace(r,`blend${o.blendFunction}`)+`
`;i.attributes&Et.DEPTH?(i.readDepth&&(s=`float depth = readDepth(UV);

	`+s),this.needsDepthTexture=this.getDepthTexture()===null):this.needsDepthTexture=!1,i.colorSpace===Z&&(s+=`color0 = sRGBToLinear(color0);
	`),i.uvTransformation?(n=`vec2 transformedUv = vUv;
`+n,i.defines.set("UV","transformedUv")):i.defines.set("UV","vUv"),i.shaderParts.set(W.FRAGMENT_HEAD,e),i.shaderParts.set(W.FRAGMENT_MAIN_IMAGE,s),i.shaderParts.set(W.FRAGMENT_MAIN_UV,n);for(const[o,a]of i.shaderParts)a!==null&&i.shaderParts.set(o,a.trim().replace(/^#/,`
#`));this.skipRendering=t===0,this.needsSwap=!this.skipRendering,this.fullscreenMaterial.setShaderData(i)}recompile(){this.updateMaterial()}getDepthTexture(){return this.fullscreenMaterial.depthBuffer}setDepthTexture(i,t=zt){this.fullscreenMaterial.depthBuffer=i,this.fullscreenMaterial.depthPacking=t;for(const e of this.effects)e.setDepthTexture(i,t)}render(i,t,e,s,n){for(const r of this.effects)r.update(i,t,s);if(!this.skipRendering||this.renderToScreen){const r=this.fullscreenMaterial;r.inputBuffer=t.texture,r.time+=s*this.timeScale,i.setRenderTarget(this.renderToScreen?null:e),i.render(this.scene,this.camera)}}setSize(i,t){this.fullscreenMaterial.setSize(i,t);for(const e of this.effects)e.setSize(i,t)}initialize(i,t,e){this.renderer=i;for(const s of this.effects)s.initialize(i,t,e);this.updateMaterial(),e!==void 0&&e!==ot&&(this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}dispose(){super.dispose();for(const i of this.effects)i.removeEventListener("change",this.listener),i.dispose()}handleEvent(i){switch(i.type){case"change":this.recompile();break}}},os,vt,it,Li,La,Di,Da,Bi,Ba,Ii,Ia,Oi,Oa,Fi,Fa,Ni,Na;class fh{constructor(t,e,s){z(this,Li);z(this,Di);z(this,Bi);z(this,Ii);z(this,Oi);z(this,Fi);z(this,Ni);z(this,os,void 0);z(this,vt,void 0);z(this,it,void 0);O(this,"resize",(t,e)=>{this.composer.setSize(t,e,!0)});O(this,"addBloom",t=>{const e=this.bloomEffect.selection;t instanceof ve?e.add(t):Array.isArray(t)&&t.forEach(this.addBloom)});O(this,"clearBloom",t=>{const e=this.bloomEffect.selection;t instanceof ve?e.delete(t):Array.isArray(t)&&t.forEach(this.clearBloom)});O(this,"addOutline",(t,e=1)=>{let s=e===1?this.outlineEffect1:this.outlineEffect2;t instanceof ve?t.traverse(n=>{n.isMesh&&s.selection.add(n)}):Array.isArray(t)&&t.forEach(n=>this.addOutline(n,e))});O(this,"clearOutline",(t,e=1)=>{let s=e===1?this.outlineEffect1:this.outlineEffect2;t instanceof ve?t.traverse(n=>{n.isMesh&&s.selection.delete(n)}):Array.isArray(t)&&t.forEach(n=>this.clearOutline(n,e))});O(this,"setNoSelection",t=>{this.noSelection.push(t)});O(this,"clearNoSelection",()=>{this.noSelection=[]});K(this,os,t),K(this,vt,e),K(this,it,s),this.noSelection=[],Y(this,Li,La).call(this)}clearOutlineAll(t){(t===1?this.outlineEffect1:this.outlineEffect2).selection.set([]),this.noSelection.forEach(s=>{this.addOutline(s)})}}os=new WeakMap,vt=new WeakMap,it=new WeakMap,Li=new WeakSet,La=function(){Y(this,Di,Da).call(this),Y(this,Bi,Ba).call(this),Y(this,Ii,Ia).call(this),Y(this,Oi,Oa).call(this),Y(this,Fi,Fa).call(this),Y(this,Ni,Na).call(this)},Di=new WeakSet,Da=function(){const t=P(this,os).capabilities.maxSamples;this.composer=new Xc(P(this,os),{multisampling:t})},Bi=new WeakSet,Ba=function(){this.renderPass=new vr(P(this,vt),P(this,it)),this.composer.addPass(this.renderPass)},Ii=new WeakSet,Ia=function(){this.bloomEffect=new ah(P(this,vt),P(this,it),{blendFunction:G.ADD,luminanceThreshold:.01,luminanceSmoothing:.6,intensity:.9}),this.bloomEffect.inverted=!1,this.bloomEffect.ignoreBackground=!0,this.bloomEffect.selection.set([])},Oi=new WeakSet,Oa=function(){this.outlineEffect1=new Qr(P(this,vt),P(this,it),{blendFunction:G.ADD,edgeStrength:3,pulseSpeed:0,visibleEdgeColor:52945,hiddenEdgeColor:52945,blur:!1,xRay:!0,usePatternTexture:!1})},Fi=new WeakSet,Fa=function(){this.outlineEffect2=new Qr(P(this,vt),P(this,it),{blendFunction:G.ADD,edgeStrength:3,patternScale:5,visibleEdgeColor:52945,hiddenEdgeColor:52945,blur:!1,xRay:!0,usePatternTexture:!1})},Ni=new WeakSet,Na=function(){this.hueSaturationEffect=new Qu({saturation:.08}),this.brightnessContrastEffect=new Xu({contrast:.2});const t=new dh(P(this,it),this.bloomEffect,this.outlineEffect1,this.outlineEffect2,this.hueSaturationEffect,this.brightnessContrastEffect);this.composer.addPass(t)};const Us=class Us{constructor(){O(this,"resources");O(this,"track",t=>{if(!t)return t;if(Array.isArray(t))return t.forEach(this.track),t;if((mh(t,"dispose")||t instanceof ve)&&this.resources.add(t),t instanceof ve)t.traverse(e=>{this.resources.add(e),e.material&&this.track(e.material),e.geometry&&this.track(e.geometry),e.skeleton&&this.track(e.skeleton)});else if(t instanceof ns){for(const e of Object.values(t))e instanceof fs&&this.track(e);if("uniforms"in t){for(const e of Object.values(t.uniforms))if(e){const s=e.value;s instanceof fs&&this.track(s)}}}return t});this.resources=new Set}untrack(t){this.resources.delete(t)}dispose(t=!0){for(const e of this.resources)e instanceof ve&&t&&e.parent&&e.parent.remove(e),"dispose"in e&&e.dispose();this.clear()}clear(){this.resources.clear()}static dispose(t,e=!0){const s=Us.memory;return s.track(t),s.dispose(e),s.clear(),!0}};O(Us,"memory",new Us);let re=Us;function ph(i,t){return Reflect.has(i,t)}function mh(i,t){return ph(i,t)&&typeof i[t]=="function"}const eo=new ie;var as;class gh{constructor(t){z(this,as,void 0);O(this,"resize",(t,e)=>{const s=this.radius;this.upViewport.set(t*.65,e*.94-s,s,s),this.saveViewport.set(0,0,t,e)});this.renderer=t.renderer;const e=new Ke().load("./textures/compass.png");e.colorSpace=Z;const s=new fa(10,10),n=new Dt({transparent:!0,side:ze,map:e}),r=new de(s,n);r.rotateX(-Math.PI/2),K(this,as,r);const o=new ms(45,1,1,20);o.updateProjectionMatrix(),this.camera=o;const a=new hs;a.add(r),this.scene=a;const l=this.radius=120,c=window.innerWidth,h=window.innerHeight;this.upViewport=new At(c*.65,h*.94-l,l,l),this.saveViewport=new At(0,0,c,h)}get theta(){return P(this,as).rotation.z}set theta(t){P(this,as).rotation.z=-t/180*Math.PI}update(t){const e=t.renderer,s=t.camera,n=this.camera,{upViewport:r,saveViewport:o}=this;n.position.set(0,0,12),eo.extractRotation(s.matrix),n.position.applyMatrix4(eo),n.lookAt(0,0,0),n.updateProjectionMatrix(),e.setViewport(r),e.setScissor(r),e.render(this.scene,n),e.setViewport(o),e.setScissor(o)}}as=new WeakMap;const to=new re;ve.prototype.deleteSelf=function(i){to.track(this),to.dispose(i)};const bn=new M;M.prototype.clampSphere=function(i){this.distanceTo(i.center)>i.radius&&(bn.subVectors(this,i.center).normalize(),bn.setLength(i.radius),this.addVectors(i.center,bn))};const{innerWidth:so,innerHeight:io,devicePixelRatio:vh}=window;var xe,se,Te,Gs,qe,It,De,yt,Ot,Ft,ls,bt,xt,Nt,cs,Ui,Ua;class yh{constructor(t){z(this,Ui);z(this,xe,void 0);z(this,se,void 0);z(this,Te,void 0);z(this,Gs,void 0);z(this,qe,void 0);z(this,It,void 0);z(this,De,void 0);O(this,"clock");z(this,yt,void 0);z(this,Ot,void 0);z(this,Ft,void 0);z(this,ls,void 0);z(this,bt,void 0);z(this,xt,void 0);z(this,Nt,void 0);z(this,cs,void 0);K(this,cs,null),this.clock=new pa,this.delta=0,this.elapsedTime=0,K(this,bt,new Map),K(this,xt,new Map),K(this,It,t),K(this,yt,!1),K(this,xe,new hs),this.baseScene=P(this,xe),K(this,Te,new ms(50,so/io,.01,2e4)),K(this,Gs,P(this,Te)),P(this,Te).position.set(0,100,100),P(this,Te).lookAt(0,0,0),K(this,Nt,new gh(this)),P(this,Nt).theta=27.6,P(this,bt).set("compass",P(this,Nt).resize);const e={logarithmicDepthBuffer:!0,powerPreference:"high-performance"};if(t instanceof HTMLCanvasElement)e.canvas=t;else if(t instanceof HTMLElement){const s=document.createElement("canvas");e.canvas=s,t.appendChild(this.renderer.domElement)}else{const s=document.createElement("canvas");e.canvas=s,document.body.appendChild(s),console.log("create canvas")}K(this,It,e.canvas),P(this,It).oncontextmenu=s=>!1,K(this,se,new Ul(e)),P(this,se).setSize(so,io),P(this,se).outputColorSpace=Z,P(this,se).toneMapping=kl,P(this,se).shadowMap.enabled=!0,P(this,se).shadowMap.type=zl,P(this,se).setPixelRatio(vh),P(this,se).domElement.removeAttribute("data-engine"),P(this,se).info.autoReset=!1,K(this,qe,new zc(P(this,Te),P(this,se).domElement)),P(this,qe).target.set(0,0,0),P(this,qe).enableDamping=!0,P(this,qe).enableDolly=!1,P(this,qe).dampingFactor=.2,P(this,qe).data={},P(this,xt).set(Symbol(),s=>s.controls.update()),Y(this,Ui,Ua).call(this),document.oncontextmenu=()=>!1,window.addEventListener("resize",()=>{const{innerWidth:s,innerHeight:n}=window;P(this,Te).aspect=s/n,P(this,Te).updateProjectionMatrix(),P(this,se).setSize(s,n),P(this,se).setPixelRatio(window.devicePixelRatio),P(this,bt).forEach(r=>r(s,n))})}get onresizeQueue(){return P(this,bt)}get onRenderQueue(){return P(this,xt)}get scene(){return P(this,xe)}set scene(t){t instanceof hs&&(P(this,xe).dispose&&P(this,xe).dispose(),K(this,xe,t),P(this,De)&&P(this,De).composer.setMainScene(t))}get camera(){return P(this,Te)}get baseCamera(){return P(this,Gs)}set camera(t){t instanceof ua&&(K(this,Te,t),P(this,De)&&P(this,De).composer.setMainCamera(t))}get renderer(){return P(this,se)}get controls(){return P(this,qe)}get domElement(){return P(this,It)}get ambientLight(){return P(this,Ot)}get directionLight(){return P(this,Ft)}get postprocessing(){return P(this,De)}set cache(t){Nl.enabled=t}get renderEnabled(){return P(this,yt)}setDefaultLight(t){t._add(P(this,Ot).clone(),P(this,Ft).clone())}initComposer(){K(this,De,new fh(P(this,se),P(this,xe),P(this,Te))),this.postprocessing.hueSaturationEffect.saturation=.25,this.postprocessing.brightnessContrastEffect.contrast=.25,P(this,bt).set(Symbol(),P(this,De).resize)}initStats(){K(this,ls,new Uc),document.body.appendChild(P(this,ls).dom),P(this,xt).set(Symbol(),t=>P(t,ls).update())}initGridHelper(){const t=new ma(100);P(this,xe).add(t)}initAxesHelper(){const t=new ga(100);P(this,xe).add(t)}animate(){K(this,cs,requestAnimationFrame(this.animate.bind(this))),this.delta=this.clock.getDelta(),this.elapsedTime=this.clock.getElapsedTime(),P(this,xt).forEach(t=>t(this)),P(this,se).info.reset(),this.render()}logMemory(){console.log(P(this,se).info.memory.geometries,P(this,se).info.memory.textures)}render(){P(this,De)?P(this,De).composer.render():(P(this,se).autoClear=!0,P(this,se).render(P(this,xe),P(this,Te))),P(this,Nt).update(this)}stopRender(){cancelAnimationFrame(P(this,cs)),K(this,yt,!1),this.controls.enabled=!1}beginRender(){P(this,yt)||(this.animate(),this.controls.enabled=!0,K(this,yt,!0))}}xe=new WeakMap,se=new WeakMap,Te=new WeakMap,Gs=new WeakMap,qe=new WeakMap,It=new WeakMap,De=new WeakMap,yt=new WeakMap,Ot=new WeakMap,Ft=new WeakMap,ls=new WeakMap,bt=new WeakMap,xt=new WeakMap,Nt=new WeakMap,cs=new WeakMap,Ui=new WeakSet,Ua=function(){const t=new hr(16777215,.55),e=new Tt(16777215,3);e.shadow.camera.near=1,e.shadow.camera.far=1500,e.shadow.camera.right=500,e.shadow.camera.left=-500,e.shadow.camera.top=500,e.shadow.camera.bottom=-500,e.shadow.mapSize.width=Math.pow(2,13),e.shadow.mapSize.height=Math.pow(2,13),e.shadow.blurSamples=16,e.shadow.bias=-25e-5,e.position.set(30,385,585),e.castShadow=!0,K(this,Ot,t),P(this,xe).add(P(this,Ot)),new dr(e.shadow.camera),new fr(e),K(this,Ft,e),P(this,xe).add(P(this,Ft))};var wt;class bh extends yh{constructor(e){super(e);z(this,wt,void 0);K(this,wt,new Map)}addEventListener(e){const s=P(this,wt).get(e)||[],n=a=>{va().length>0||s.forEach(l=>l(a,this))},r=()=>{window.removeEventListener(e,n),s.length=0,P(this,wt).delete(e)},o=a=>s.indexOf(a)!==-1?()=>{const c=s.indexOf(a);s.splice(c,1)}:(s.push(a),()=>{const c=s.indexOf(a);s.splice(c,1),s.length===0&&r()});return P(this,wt).has(e)||(P(this,wt).set(e,s),window.addEventListener(e,n)),{add:o,clear:r}}}wt=new WeakMap;class yr extends ve{constructor(t=document.createElement("div")){super(),this.isCSS2DObject=!0,this.element=t,this.element.style.position="absolute",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.center=new F(.5,.5),this.addEventListener("removed",function(){this.traverse(function(e){e.element instanceof Element&&e.element.parentNode!==null&&e.element.parentNode.removeChild(e.element)})})}copy(t,e){return super.copy(t,e),this.element=t.element.cloneNode(!0),this.center=t.center,this}}const qt=new M,no=new ie,ro=new ie,oo=new M,ao=new M;class xh{constructor(t={}){const e=this;let s,n,r,o;const a={objects:new WeakMap},l=t.element!==void 0?t.element:document.createElement("div");l.style.overflow="hidden",this.domElement=l,this.getSize=function(){return{width:s,height:n}},this.render=function(f,g){f.matrixWorldAutoUpdate===!0&&f.updateMatrixWorld(),g.parent===null&&g.matrixWorldAutoUpdate===!0&&g.updateMatrixWorld(),no.copy(g.matrixWorldInverse),ro.multiplyMatrices(g.projectionMatrix,no),c(f,f,g),d(f)},this.setSize=function(f,g){s=f,n=g,r=s/2,o=n/2,l.style.width=f+"px",l.style.height=g+"px"};function c(f,g,v){if(f.isCSS2DObject){qt.setFromMatrixPosition(f.matrixWorld),qt.applyMatrix4(ro);const p=f.visible===!0&&qt.z>=-1&&qt.z<=1&&f.layers.test(v.layers)===!0;if(f.element.style.display=p===!0?"":"none",p===!0){f.onBeforeRender(e,g,v);const y=f.element;y.style.transform="translate("+-100*f.center.x+"%,"+-100*f.center.y+"%)translate("+(qt.x*r+r)+"px,"+(-qt.y*o+o)+"px)",y.parentNode!==l&&l.appendChild(y),f.onAfterRender(e,g,v)}const m={distanceToCameraSquared:h(v,f)};a.objects.set(f,m)}for(let p=0,m=f.children.length;p<m;p++)c(f.children[p],g,v)}function h(f,g){return oo.setFromMatrixPosition(f.matrixWorld),ao.setFromMatrixPosition(g.matrixWorld),oo.distanceToSquared(ao)}function u(f){const g=[];return f.traverse(function(v){v.isCSS2DObject&&g.push(v)}),g}function d(f){const g=u(f).sort(function(p,m){if(p.renderOrder!==m.renderOrder)return m.renderOrder-p.renderOrder;const y=a.objects.get(p).distanceToCameraSquared,x=a.objects.get(m).distanceToCameraSquared;return y-x}),v=g.length;for(let p=0,m=g.length;p<m;p++)g[p].element.style.zIndex=v-p}}}const lo=new M,wh=new zs,co=new M,Ge=new ie,Sh=new ie;class Th{constructor(t={}){const e=this;let s,n,r,o;const a={camera:{style:""},objects:new WeakMap},l=t.element!==void 0?t.element:document.createElement("div");l.style.overflow="hidden",this.domElement=l;const c=document.createElement("div");c.style.transformOrigin="0 0",c.style.pointerEvents="none",l.appendChild(c);const h=document.createElement("div");h.style.transformStyle="preserve-3d",c.appendChild(h),this.getSize=function(){return{width:s,height:n}},this.render=function(v,p){const m=p.projectionMatrix.elements[5]*o;p.view&&p.view.enabled?(c.style.transform=`translate( ${-p.view.offsetX*(s/p.view.width)}px, ${-p.view.offsetY*(n/p.view.height)}px )`,c.style.transform+=`scale( ${p.view.fullWidth/p.view.width}, ${p.view.fullHeight/p.view.height} )`):c.style.transform="",v.matrixWorldAutoUpdate===!0&&v.updateMatrixWorld(),p.parent===null&&p.matrixWorldAutoUpdate===!0&&p.updateMatrixWorld();let y,x;p.isOrthographicCamera&&(y=-(p.right+p.left)/2,x=(p.top+p.bottom)/2);const b=p.view&&p.view.enabled?p.view.height/p.view.fullHeight:1,w=p.isOrthographicCamera?`scale( ${b} )scale(`+m+")translate("+u(y)+"px,"+u(x)+"px)"+d(p.matrixWorldInverse):`scale( ${b} )translateZ(`+m+"px)"+d(p.matrixWorldInverse),T=(p.isPerspectiveCamera?"perspective("+m+"px) ":"")+w+"translate("+r+"px,"+o+"px)";a.camera.style!==T&&(h.style.transform=T,a.camera.style=T),g(v,v,p)},this.setSize=function(v,p){s=v,n=p,r=s/2,o=n/2,l.style.width=v+"px",l.style.height=p+"px",c.style.width=v+"px",c.style.height=p+"px",h.style.width=v+"px",h.style.height=p+"px"};function u(v){return Math.abs(v)<1e-10?0:v}function d(v){const p=v.elements;return"matrix3d("+u(p[0])+","+u(-p[1])+","+u(p[2])+","+u(p[3])+","+u(p[4])+","+u(-p[5])+","+u(p[6])+","+u(p[7])+","+u(p[8])+","+u(-p[9])+","+u(p[10])+","+u(p[11])+","+u(p[12])+","+u(-p[13])+","+u(p[14])+","+u(p[15])+")"}function f(v){const p=v.elements;return"translate(-50%,-50%)"+("matrix3d("+u(p[0])+","+u(p[1])+","+u(p[2])+","+u(p[3])+","+u(-p[4])+","+u(-p[5])+","+u(-p[6])+","+u(-p[7])+","+u(p[8])+","+u(p[9])+","+u(p[10])+","+u(p[11])+","+u(p[12])+","+u(p[13])+","+u(p[14])+","+u(p[15])+")")}function g(v,p,m,y){if(v.isCSS3DObject){const x=v.visible===!0&&v.layers.test(m.layers)===!0;if(v.element.style.display=x===!0?"":"none",x===!0){v.onBeforeRender(e,p,m);let b;v.isCSS3DSprite?(Ge.copy(m.matrixWorldInverse),Ge.transpose(),v.rotation2D!==0&&Ge.multiply(Sh.makeRotationZ(v.rotation2D)),v.matrixWorld.decompose(lo,wh,co),Ge.setPosition(lo),Ge.scale(co),Ge.elements[3]=0,Ge.elements[7]=0,Ge.elements[11]=0,Ge.elements[15]=1,b=f(Ge)):b=f(v.matrixWorld);const w=v.element,E=a.objects.get(v);if(E===void 0||E.style!==b){w.style.transform=b;const T={style:b};a.objects.set(v,T)}w.parentNode!==h&&h.appendChild(w),v.onAfterRender(e,p,m)}}for(let x=0,b=v.children.length;x<b;x++)g(v.children[x],p,m)}}}class Eh{constructor(t,e){O(this,"raycaster");O(this,"camera");O(this,"element");O(this,"mouse");O(this,"intersects");O(this,"callbackMap");O(this,"getIntersects",(t,e,s)=>{if(va().length>0||!this.getState(s))return;this.intersects.length=0;const{left:n,top:r,width:o,height:a}=this.element.getBoundingClientRect();this.mouse.x=(t.clientX-n)/o*2-1,this.mouse.y=-((t.clientY-r)/a)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera),Array.isArray(e)?this.raycaster.intersectObjects(e,!0,this.intersects):this.raycaster.intersectObject(e,!0,this.intersects);const l=this.intersects.filter(c=>c.object.visible);this.callbackMap.get(e)[s].forEach(c=>c(l,t))});this.raycaster=new Mi,this.mouse=new F,this.camera=t,this.element=e,this.intersects=[],this.callbackMap=new Map,this._eventListeners=new Map,this.stateMap=new Map}set(t,e){this.camera=t,this.element=e}raycast(t,e,s){if(s){if(this.exist(e,t)){const n=this.callbackMap.get(e)[t];n.indexOf(s)===-1&&n.push(s)}else if(this.handleEvent(e,t,s),this.callbackMap.has(e)){const n=this.callbackMap.get(e);n[t]=n[t]||[],n[t].push(s)}else this.callbackMap.set(e,{[t]:[s]});return{clear:()=>this.clear(e,t,s),intersects:this.intersects}}}exist(t,e){return!!(this.callbackMap.has(t)&&this.callbackMap.get(t)[e])}handleEvent(t,e){const s=r=>this.getIntersects(r,t,e),n=()=>{this.element.removeEventListener(e,s)};if(this._eventListeners.has(t)){const r=this._eventListeners.get(t);r[e]=n}else this._eventListeners.set(t,{[e]:n});this.element.addEventListener(e,s)}clear(t,e,s){if(this.callbackMap.has(t)){const r=this.callbackMap.get(t),o=r[e],a=o.indexOf(s);if(a===-1)return;o.splice(a,1),o.length===0&&delete r[e],Reflect.ownKeys(r).length===0&&this.callbackMap.delete(t),this.intersects.length=0}const n=this._eventListeners.get(t);this.exist(t,e)||(n[e](),delete n[e]),Reflect.ownKeys(n).length===0&&this._eventListeners.delete(t)}setState(t,e){this.stateMap.set(t,e)}getState(t){return this.stateMap.has(t)?this.stateMap.get(t):!0}}const ka=0,Ah=1,Mh=2,uo=2,xn=1.25,ho=1,bi=6*4+4+4,rn=65535,Ch=Math.pow(2,-24),wn=Symbol("SKIP_GENERATION");function _h(i){return i.index?i.index.count:i.attributes.position.count}function gs(i){return _h(i)/3}function Ph(i,t=ArrayBuffer){return i>65535?new Uint32Array(new t(4*i)):new Uint16Array(new t(2*i))}function Rh(i,t){if(!i.index){const e=i.attributes.position.count,s=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,n=Ph(e,s);i.setIndex(new oe(n,1));for(let r=0;r<e;r++)n[r]=r}}function za(i){const t=gs(i),e=i.drawRange,s=e.start/3,n=(e.start+e.count)/3,r=Math.max(0,s),o=Math.min(t,n)-r;return[{offset:Math.floor(r),count:Math.floor(o)}]}function Ha(i){if(!i.groups||!i.groups.length)return za(i);const t=[],e=new Set,s=i.drawRange,n=s.start/3,r=(s.start+s.count)/3;for(const a of i.groups){const l=a.start/3,c=(a.start+a.count)/3;e.add(Math.max(n,l)),e.add(Math.min(r,c))}const o=Array.from(e.values()).sort((a,l)=>a-l);for(let a=0;a<o.length-1;a++){const l=o[a],c=o[a+1];t.push({offset:Math.floor(l),count:Math.floor(c-l)})}return t}function Lh(i){if(i.groups.length===0)return!1;const t=gs(i),e=Ha(i).sort((r,o)=>r.offset-o.offset),s=e[e.length-1];s.count=Math.min(t-s.offset,s.count);let n=0;return e.forEach(({count:r})=>n+=r),t!==n}function te(i,t,e){return e.min.x=t[i],e.min.y=t[i+1],e.min.z=t[i+2],e.max.x=t[i+3],e.max.y=t[i+4],e.max.z=t[i+5],e}function Dh(i){i[0]=i[1]=i[2]=1/0,i[3]=i[4]=i[5]=-1/0}function fo(i){let t=-1,e=-1/0;for(let s=0;s<3;s++){const n=i[s+3]-i[s];n>e&&(e=n,t=s)}return t}function po(i,t){t.set(i)}function mo(i,t,e){let s,n;for(let r=0;r<3;r++){const o=r+3;s=i[r],n=t[r],e[r]=s<n?s:n,s=i[o],n=t[o],e[o]=s>n?s:n}}function Js(i,t,e){for(let s=0;s<3;s++){const n=t[i+2*s],r=t[i+2*s+1],o=n-r,a=n+r;o<e[s]&&(e[s]=o),a>e[s+3]&&(e[s+3]=a)}}function Es(i){const t=i[3]-i[0],e=i[4]-i[1],s=i[5]-i[2];return 2*(t*e+e*s+s*t)}function Sn(i,t,e,s,n=null){let r=1/0,o=1/0,a=1/0,l=-1/0,c=-1/0,h=-1/0,u=1/0,d=1/0,f=1/0,g=-1/0,v=-1/0,p=-1/0;const m=n!==null;for(let y=t*6,x=(t+e)*6;y<x;y+=6){const b=i[y+0],w=i[y+1],E=b-w,T=b+w;E<r&&(r=E),T>l&&(l=T),m&&b<u&&(u=b),m&&b>g&&(g=b);const A=i[y+2],C=i[y+3],R=A-C,L=A+C;R<o&&(o=R),L>c&&(c=L),m&&A<d&&(d=A),m&&A>v&&(v=A);const _=i[y+4],D=i[y+5],B=_-D,N=_+D;B<a&&(a=B),N>h&&(h=N),m&&_<f&&(f=_),m&&_>p&&(p=_)}s[0]=r,s[1]=o,s[2]=a,s[3]=l,s[4]=c,s[5]=h,m&&(n[0]=u,n[1]=d,n[2]=f,n[3]=g,n[4]=v,n[5]=p)}function Bh(i,t,e,s){let n=1/0,r=1/0,o=1/0,a=-1/0,l=-1/0,c=-1/0;for(let h=t*6,u=(t+e)*6;h<u;h+=6){const d=i[h+0];d<n&&(n=d),d>a&&(a=d);const f=i[h+2];f<r&&(r=f),f>l&&(l=f);const g=i[h+4];g<o&&(o=g),g>c&&(c=g)}s[0]=n,s[1]=r,s[2]=o,s[3]=a,s[4]=l,s[5]=c}function Ih(i,t){Dh(t);const e=i.attributes.position,s=i.index?i.index.array:null,n=gs(i),r=new Float32Array(n*6),o=e.normalized,a=e.array,l=e.offset||0;let c=3;e.isInterleavedBufferAttribute&&(c=e.data.stride);const h=["getX","getY","getZ"];for(let u=0;u<n;u++){const d=u*3,f=u*6;let g=d+0,v=d+1,p=d+2;s&&(g=s[g],v=s[v],p=s[p]),o||(g=g*c+l,v=v*c+l,p=p*c+l);for(let m=0;m<3;m++){let y,x,b;o?(y=e[h[m]](g),x=e[h[m]](v),b=e[h[m]](p)):(y=a[g+m],x=a[v+m],b=a[p+m]);let w=y;x<w&&(w=x),b<w&&(w=b);let E=y;x>E&&(E=x),b>E&&(E=b);const T=(E-w)/2,A=m*2;r[f+A+0]=w+T,r[f+A+1]=T+(Math.abs(w)+T)*Ch,w<t[m]&&(t[m]=w),E>t[m+3]&&(t[m+3]=E)}}return r}const tt=32,Oh=(i,t)=>i.candidate-t.candidate,dt=new Array(tt).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),ei=new Float32Array(6);function Fh(i,t,e,s,n,r){let o=-1,a=0;if(r===ka)o=fo(t),o!==-1&&(a=(t[o]+t[o+3])/2);else if(r===Ah)o=fo(i),o!==-1&&(a=Nh(e,s,n,o));else if(r===Mh){const l=Es(i);let c=xn*n;const h=s*6,u=(s+n)*6;for(let d=0;d<3;d++){const f=t[d],p=(t[d+3]-f)/tt;if(n<tt/4){const m=[...dt];m.length=n;let y=0;for(let b=h;b<u;b+=6,y++){const w=m[y];w.candidate=e[b+2*d],w.count=0;const{bounds:E,leftCacheBounds:T,rightCacheBounds:A}=w;for(let C=0;C<3;C++)A[C]=1/0,A[C+3]=-1/0,T[C]=1/0,T[C+3]=-1/0,E[C]=1/0,E[C+3]=-1/0;Js(b,e,E)}m.sort(Oh);let x=n;for(let b=0;b<x;b++){const w=m[b];for(;b+1<x&&m[b+1].candidate===w.candidate;)m.splice(b+1,1),x--}for(let b=h;b<u;b+=6){const w=e[b+2*d];for(let E=0;E<x;E++){const T=m[E];w>=T.candidate?Js(b,e,T.rightCacheBounds):(Js(b,e,T.leftCacheBounds),T.count++)}}for(let b=0;b<x;b++){const w=m[b],E=w.count,T=n-w.count,A=w.leftCacheBounds,C=w.rightCacheBounds;let R=0;E!==0&&(R=Es(A)/l);let L=0;T!==0&&(L=Es(C)/l);const _=ho+xn*(R*E+L*T);_<c&&(o=d,c=_,a=w.candidate)}}else{for(let x=0;x<tt;x++){const b=dt[x];b.count=0,b.candidate=f+p+x*p;const w=b.bounds;for(let E=0;E<3;E++)w[E]=1/0,w[E+3]=-1/0}for(let x=h;x<u;x+=6){let E=~~((e[x+2*d]-f)/p);E>=tt&&(E=tt-1);const T=dt[E];T.count++,Js(x,e,T.bounds)}const m=dt[tt-1];po(m.bounds,m.rightCacheBounds);for(let x=tt-2;x>=0;x--){const b=dt[x],w=dt[x+1];mo(b.bounds,w.rightCacheBounds,b.rightCacheBounds)}let y=0;for(let x=0;x<tt-1;x++){const b=dt[x],w=b.count,E=b.bounds,A=dt[x+1].rightCacheBounds;w!==0&&(y===0?po(E,ei):mo(E,ei,ei)),y+=w;let C=0,R=0;y!==0&&(C=Es(ei)/l);const L=n-y;L!==0&&(R=Es(A)/l);const _=ho+xn*(C*y+R*L);_<c&&(o=d,c=_,a=b.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${r} used.`);return{axis:o,pos:a}}function Nh(i,t,e,s){let n=0;for(let r=t,o=t+e;r<o;r++)n+=i[r*6+s*2];return n/e}class ti{constructor(){}}function Uh(i,t,e,s,n,r){let o=s,a=s+n-1;const l=r.pos,c=r.axis*2;for(;;){for(;o<=a&&e[o*6+c]<l;)o++;for(;o<=a&&e[a*6+c]>=l;)a--;if(o<a){for(let h=0;h<3;h++){let u=t[o*3+h];t[o*3+h]=t[a*3+h],t[a*3+h]=u}for(let h=0;h<6;h++){let u=e[o*6+h];e[o*6+h]=e[a*6+h],e[a*6+h]=u}o++,a--}else return o}}function kh(i,t,e,s,n,r){let o=s,a=s+n-1;const l=r.pos,c=r.axis*2;for(;;){for(;o<=a&&e[o*6+c]<l;)o++;for(;o<=a&&e[a*6+c]>=l;)a--;if(o<a){let h=i[o];i[o]=i[a],i[a]=h;for(let u=0;u<6;u++){let d=e[o*6+u];e[o*6+u]=e[a*6+u],e[a*6+u]=d}o++,a--}else return o}}function zh(i,t){const e=(i.index?i.index.count:i.attributes.position.count)/3,s=e>2**16,n=s?4:2,r=t?new SharedArrayBuffer(e*n):new ArrayBuffer(e*n),o=s?new Uint32Array(r):new Uint16Array(r);for(let a=0,l=o.length;a<l;a++)o[a]=a;return o}function Hh(i,t){const e=i.geometry,s=e.index?e.index.array:null,n=t.maxDepth,r=t.verbose,o=t.maxLeafTris,a=t.strategy,l=t.onProgress,c=gs(e),h=i._indirectBuffer;let u=!1;const d=new Float32Array(6),f=new Float32Array(6),g=Ih(e,d),v=t.indirect?kh:Uh,p=[],m=t.indirect?za(e):Ha(e);if(m.length===1){const b=m[0],w=new ti;w.boundingData=d,Bh(g,b.offset,b.count,f),x(w,b.offset,b.count,f),p.push(w)}else for(let b of m){const w=new ti;w.boundingData=new Float32Array(6),Sn(g,b.offset,b.count,w.boundingData,f),x(w,b.offset,b.count,f),p.push(w)}return p;function y(b){l&&l(b/c)}function x(b,w,E,T=null,A=0){if(!u&&A>=n&&(u=!0,r&&(console.warn(`MeshBVH: Max depth of ${n} reached when generating BVH. Consider increasing maxDepth.`),console.warn(e))),E<=o||A>=n)return y(w+E),b.offset=w,b.count=E,b;const C=Fh(b.boundingData,T,g,w,E,a);if(C.axis===-1)return y(w+E),b.offset=w,b.count=E,b;const R=v(h,s,g,w,E,C);if(R===w||R===w+E)y(w+E),b.offset=w,b.count=E;else{b.splitAxis=C.axis;const L=new ti,_=w,D=R-w;b.left=L,L.boundingData=new Float32Array(6),Sn(g,_,D,L.boundingData,f),x(L,_,D,f,A+1);const B=new ti,N=R,H=E-D;b.right=B,B.boundingData=new Float32Array(6),Sn(g,N,H,B.boundingData,f),x(B,N,H,f,A+1)}return b}}function Gh(i,t){const e=i.geometry;t.indirect&&(i._indirectBuffer=zh(e,t.useSharedArrayBuffer),Lh(e)&&!t.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),i._indirectBuffer||Rh(e,t);const s=Hh(i,t);let n,r,o;const a=[],l=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let u=0;u<s.length;u++){const d=s[u];let f=c(d);const g=new l(bi*f);n=new Float32Array(g),r=new Uint32Array(g),o=new Uint16Array(g),h(0,d),a.push(g)}i._roots=a;return;function c(u){return u.count?1:1+c(u.left)+c(u.right)}function h(u,d){const f=u/4,g=u/2,v=!!d.count,p=d.boundingData;for(let m=0;m<6;m++)n[f+m]=p[m];if(v){const m=d.offset,y=d.count;return r[f+6]=m,o[g+14]=y,o[g+15]=rn,u+bi}else{const m=d.left,y=d.right,x=d.splitAxis;let b;if(b=h(u+bi,m),b/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return r[f+6]=b/4,b=h(b,y),r[f+7]=x,b}}}class at{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,e){let s=1/0,n=-1/0;for(let r=0,o=t.length;r<o;r++){const l=t[r][e];s=l<s?l:s,n=l>n?l:n}this.min=s,this.max=n}setFromPoints(t,e){let s=1/0,n=-1/0;for(let r=0,o=e.length;r<o;r++){const a=e[r],l=t.dot(a);s=l<s?l:s,n=l>n?l:n}this.min=s,this.max=n}isSeparated(t){return this.min>t.max||t.min>this.max}}at.prototype.setFromBox=function(){const i=new M;return function(e,s){const n=s.min,r=s.max;let o=1/0,a=-1/0;for(let l=0;l<=1;l++)for(let c=0;c<=1;c++)for(let h=0;h<=1;h++){i.x=n.x*l+r.x*(1-l),i.y=n.y*c+r.y*(1-c),i.z=n.z*h+r.z*(1-h);const u=e.dot(i);o=Math.min(u,o),a=Math.max(u,a)}this.min=o,this.max=a}}();const jh=function(){const i=new M,t=new M,e=new M;return function(n,r,o){const a=n.start,l=i,c=r.start,h=t;e.subVectors(a,c),i.subVectors(n.end,n.start),t.subVectors(r.end,r.start);const u=e.dot(h),d=h.dot(l),f=h.dot(h),g=e.dot(l),p=l.dot(l)*f-d*d;let m,y;p!==0?m=(u*d-g*f)/p:m=0,y=(u+m*d)/f,o.x=m,o.y=y}}(),br=function(){const i=new F,t=new M,e=new M;return function(n,r,o,a){jh(n,r,i);let l=i.x,c=i.y;if(l>=0&&l<=1&&c>=0&&c<=1){n.at(l,o),r.at(c,a);return}else if(l>=0&&l<=1){c<0?r.at(0,a):r.at(1,a),n.closestPointToPoint(a,!0,o);return}else if(c>=0&&c<=1){l<0?n.at(0,o):n.at(1,o),r.closestPointToPoint(o,!0,a);return}else{let h;l<0?h=n.start:h=n.end;let u;c<0?u=r.start:u=r.end;const d=t,f=e;if(n.closestPointToPoint(u,!0,t),r.closestPointToPoint(h,!0,e),d.distanceToSquared(u)<=f.distanceToSquared(h)){o.copy(d),a.copy(u);return}else{o.copy(h),a.copy(f);return}}}}(),Vh=function(){const i=new M,t=new M,e=new cr,s=new Ye;return function(r,o){const{radius:a,center:l}=r,{a:c,b:h,c:u}=o;if(s.start=c,s.end=h,s.closestPointToPoint(l,!0,i).distanceTo(l)<=a||(s.start=c,s.end=u,s.closestPointToPoint(l,!0,i).distanceTo(l)<=a)||(s.start=h,s.end=u,s.closestPointToPoint(l,!0,i).distanceTo(l)<=a))return!0;const v=o.getPlane(e);if(Math.abs(v.distanceToPoint(l))<=a){const m=v.projectPoint(l,t);if(o.containsPoint(m))return!0}return!1}}(),qh=1e-15;function Tn(i){return Math.abs(i)<qh}class He extends Bs{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new M),this.satBounds=new Array(4).fill().map(()=>new at),this.points=[this.a,this.b,this.c],this.sphere=new Ct,this.plane=new cr,this.needsUpdate=!0}intersectsSphere(t){return Vh(t,this)}update(){const t=this.a,e=this.b,s=this.c,n=this.points,r=this.satAxes,o=this.satBounds,a=r[0],l=o[0];this.getNormal(a),l.setFromPoints(a,n);const c=r[1],h=o[1];c.subVectors(t,e),h.setFromPoints(c,n);const u=r[2],d=o[2];u.subVectors(e,s),d.setFromPoints(u,n);const f=r[3],g=o[3];f.subVectors(s,t),g.setFromPoints(f,n),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(a,t),this.needsUpdate=!1}}He.prototype.closestPointToSegment=function(){const i=new M,t=new M,e=new Ye;return function(n,r=null,o=null){const{start:a,end:l}=n,c=this.points;let h,u=1/0;for(let d=0;d<3;d++){const f=(d+1)%3;e.start.copy(c[d]),e.end.copy(c[f]),br(e,n,i,t),h=i.distanceToSquared(t),h<u&&(u=h,r&&r.copy(i),o&&o.copy(t))}return this.closestPointToPoint(a,i),h=a.distanceToSquared(i),h<u&&(u=h,r&&r.copy(i),o&&o.copy(a)),this.closestPointToPoint(l,i),h=l.distanceToSquared(i),h<u&&(u=h,r&&r.copy(i),o&&o.copy(l)),Math.sqrt(u)}}();He.prototype.intersectsTriangle=function(){const i=new He,t=new Array(3),e=new Array(3),s=new at,n=new at,r=new M,o=new M,a=new M,l=new M,c=new M,h=new Ye,u=new Ye,d=new Ye,f=new M;function g(v,p,m){const y=v.points;let x=0,b=-1;for(let w=0;w<3;w++){const{start:E,end:T}=h;E.copy(y[w]),T.copy(y[(w+1)%3]),h.delta(o);const A=Tn(p.distanceToPoint(E));if(Tn(p.normal.dot(o))&&A){m.copy(h),x=2;break}const C=p.intersectLine(h,f);if(!C&&A&&f.copy(E),(C||A)&&!Tn(f.distanceTo(T))){if(x<=1)(x===1?m.start:m.end).copy(f),A&&(b=x);else if(x>=2){(b===1?m.start:m.end).copy(f),x=2;break}if(x++,x===2&&b===-1)break}}return x}return function(p,m=null,y=!1){this.needsUpdate&&this.update(),p.isExtendedTriangle?p.needsUpdate&&p.update():(i.copy(p),i.update(),p=i);const x=this.plane,b=p.plane;if(Math.abs(x.normal.dot(b.normal))>1-1e-10){const w=this.satBounds,E=this.satAxes;e[0]=p.a,e[1]=p.b,e[2]=p.c;for(let C=0;C<4;C++){const R=w[C],L=E[C];if(s.setFromPoints(L,e),R.isSeparated(s))return!1}const T=p.satBounds,A=p.satAxes;t[0]=this.a,t[1]=this.b,t[2]=this.c;for(let C=0;C<4;C++){const R=T[C],L=A[C];if(s.setFromPoints(L,t),R.isSeparated(s))return!1}for(let C=0;C<4;C++){const R=E[C];for(let L=0;L<4;L++){const _=A[L];if(r.crossVectors(R,_),s.setFromPoints(r,t),n.setFromPoints(r,e),s.isSeparated(n))return!1}}return m&&(y||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),m.start.set(0,0,0),m.end.set(0,0,0)),!0}else{const w=g(this,b,u);if(w===1&&p.containsPoint(u.end))return m&&(m.start.copy(u.end),m.end.copy(u.end)),!0;if(w!==2)return!1;const E=g(p,x,d);if(E===1&&this.containsPoint(d.end))return m&&(m.start.copy(d.end),m.end.copy(d.end)),!0;if(E!==2)return!1;if(u.delta(a),d.delta(l),a.dot(l)<0){let D=d.start;d.start=d.end,d.end=D}const T=u.start.dot(a),A=u.end.dot(a),C=d.start.dot(a),R=d.end.dot(a),L=A<C,_=T<R;return T!==R&&C!==A&&L===_?!1:(m&&(c.subVectors(u.start,d.start),c.dot(a)>0?m.start.copy(u.start):m.start.copy(d.start),c.subVectors(u.end,d.end),c.dot(a)<0?m.end.copy(u.end):m.end.copy(d.end)),!0)}}}();He.prototype.distanceToPoint=function(){const i=new M;return function(e){return this.closestPointToPoint(e,i),e.distanceTo(i)}}();He.prototype.distanceToTriangle=function(){const i=new M,t=new M,e=["a","b","c"],s=new Ye,n=new Ye;return function(o,a=null,l=null){const c=a||l?s:null;if(this.intersectsTriangle(o,c))return(a||l)&&(a&&c.getCenter(a),l&&c.getCenter(l)),0;let h=1/0;for(let u=0;u<3;u++){let d;const f=e[u],g=o[f];this.closestPointToPoint(g,i),d=g.distanceToSquared(i),d<h&&(h=d,a&&a.copy(i),l&&l.copy(g));const v=this[f];o.closestPointToPoint(v,i),d=v.distanceToSquared(i),d<h&&(h=d,a&&a.copy(v),l&&l.copy(i))}for(let u=0;u<3;u++){const d=e[u],f=e[(u+1)%3];s.set(this[d],this[f]);for(let g=0;g<3;g++){const v=e[g],p=e[(g+1)%3];n.set(o[v],o[p]),br(s,n,i,t);const m=i.distanceToSquared(t);m<h&&(h=m,a&&a.copy(i),l&&l.copy(t))}}return Math.sqrt(h)}}();class Se{constructor(t,e,s){this.isOrientedBox=!0,this.min=new M,this.max=new M,this.matrix=new ie,this.invMatrix=new ie,this.points=new Array(8).fill().map(()=>new M),this.satAxes=new Array(3).fill().map(()=>new M),this.satBounds=new Array(3).fill().map(()=>new at),this.alignedSatBounds=new Array(3).fill().map(()=>new at),this.needsUpdate=!1,t&&this.min.copy(t),e&&this.max.copy(e),s&&this.matrix.copy(s)}set(t,e,s){this.min.copy(t),this.max.copy(e),this.matrix.copy(s),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}Se.prototype.update=function(){return function(){const t=this.matrix,e=this.min,s=this.max,n=this.points;for(let c=0;c<=1;c++)for(let h=0;h<=1;h++)for(let u=0;u<=1;u++){const d=1*c|2*h|4*u,f=n[d];f.x=c?s.x:e.x,f.y=h?s.y:e.y,f.z=u?s.z:e.z,f.applyMatrix4(t)}const r=this.satBounds,o=this.satAxes,a=n[0];for(let c=0;c<3;c++){const h=o[c],u=r[c],d=1<<c,f=n[d];h.subVectors(a,f),u.setFromPoints(h,n)}const l=this.alignedSatBounds;l[0].setFromPointsField(n,"x"),l[1].setFromPointsField(n,"y"),l[2].setFromPointsField(n,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}();Se.prototype.intersectsBox=function(){const i=new at;return function(e){this.needsUpdate&&this.update();const s=e.min,n=e.max,r=this.satBounds,o=this.satAxes,a=this.alignedSatBounds;if(i.min=s.x,i.max=n.x,a[0].isSeparated(i)||(i.min=s.y,i.max=n.y,a[1].isSeparated(i))||(i.min=s.z,i.max=n.z,a[2].isSeparated(i)))return!1;for(let l=0;l<3;l++){const c=o[l],h=r[l];if(i.setFromBox(c,e),h.isSeparated(i))return!1}return!0}}();Se.prototype.intersectsTriangle=function(){const i=new He,t=new Array(3),e=new at,s=new at,n=new M;return function(o){this.needsUpdate&&this.update(),o.isExtendedTriangle?o.needsUpdate&&o.update():(i.copy(o),i.update(),o=i);const a=this.satBounds,l=this.satAxes;t[0]=o.a,t[1]=o.b,t[2]=o.c;for(let d=0;d<3;d++){const f=a[d],g=l[d];if(e.setFromPoints(g,t),f.isSeparated(e))return!1}const c=o.satBounds,h=o.satAxes,u=this.points;for(let d=0;d<3;d++){const f=c[d],g=h[d];if(e.setFromPoints(g,u),f.isSeparated(e))return!1}for(let d=0;d<3;d++){const f=l[d];for(let g=0;g<4;g++){const v=h[g];if(n.crossVectors(f,v),e.setFromPoints(n,t),s.setFromPoints(n,u),e.isSeparated(s))return!1}}return!0}}();Se.prototype.closestPointToPoint=function(){return function(t,e){return this.needsUpdate&&this.update(),e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e}}();Se.prototype.distanceToPoint=function(){const i=new M;return function(e){return this.closestPointToPoint(e,i),e.distanceTo(i)}}();Se.prototype.distanceToBox=function(){const i=["x","y","z"],t=new Array(12).fill().map(()=>new Ye),e=new Array(12).fill().map(()=>new Ye),s=new M,n=new M;return function(o,a=0,l=null,c=null){if(this.needsUpdate&&this.update(),this.intersectsBox(o))return(l||c)&&(o.getCenter(n),this.closestPointToPoint(n,s),o.closestPointToPoint(s,n),l&&l.copy(s),c&&c.copy(n)),0;const h=a*a,u=o.min,d=o.max,f=this.points;let g=1/0;for(let p=0;p<8;p++){const m=f[p];n.copy(m).clamp(u,d);const y=m.distanceToSquared(n);if(y<g&&(g=y,l&&l.copy(m),c&&c.copy(n),y<h))return Math.sqrt(y)}let v=0;for(let p=0;p<3;p++)for(let m=0;m<=1;m++)for(let y=0;y<=1;y++){const x=(p+1)%3,b=(p+2)%3,w=m<<x|y<<b,E=1<<p|m<<x|y<<b,T=f[w],A=f[E];t[v].set(T,A);const R=i[p],L=i[x],_=i[b],D=e[v],B=D.start,N=D.end;B[R]=u[R],B[L]=m?u[L]:d[L],B[_]=y?u[_]:d[L],N[R]=d[R],N[L]=m?u[L]:d[L],N[_]=y?u[_]:d[L],v++}for(let p=0;p<=1;p++)for(let m=0;m<=1;m++)for(let y=0;y<=1;y++){n.x=p?d.x:u.x,n.y=m?d.y:u.y,n.z=y?d.z:u.z,this.closestPointToPoint(n,s);const x=n.distanceToSquared(s);if(x<g&&(g=x,l&&l.copy(s),c&&c.copy(n),x<h))return Math.sqrt(x)}for(let p=0;p<12;p++){const m=t[p];for(let y=0;y<12;y++){const x=e[y];br(m,x,s,n);const b=s.distanceToSquared(n);if(b<g&&(g=b,l&&l.copy(s),c&&c.copy(n),b<h))return Math.sqrt(b)}}return Math.sqrt(g)}}();class xr{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){const t=this._primitives;return t.length===0?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}class Wh extends xr{constructor(){super(()=>new He)}}const Ie=new Wh;function Ae(i,t){return t[i+15]===65535}function Me(i,t){return t[i+6]}function Oe(i,t){return t[i+14]}function Fe(i){return i+8}function Ne(i,t){return t[i+6]}function Ga(i,t){return t[i+7]}class Kh{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const t=[];let e=null;this.setBuffer=s=>{e&&t.push(e),e=s,this.float32Array=new Float32Array(s),this.uint16Array=new Uint16Array(s),this.uint32Array=new Uint32Array(s)},this.clearBuffer=()=>{e=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,t.length!==0&&this.setBuffer(t.pop())}}}const ee=new Kh;let St,is;const Wt=[],si=new xr(()=>new le);function Xh(i,t,e,s,n,r){St=si.getPrimitive(),is=si.getPrimitive(),Wt.push(St,is),ee.setBuffer(i._roots[t]);const o=$n(0,i.geometry,e,s,n,r);ee.clearBuffer(),si.releasePrimitive(St),si.releasePrimitive(is),Wt.pop(),Wt.pop();const a=Wt.length;return a>0&&(is=Wt[a-1],St=Wt[a-2]),o}function $n(i,t,e,s,n=null,r=0,o=0){const{float32Array:a,uint16Array:l,uint32Array:c}=ee;let h=i*2;if(Ae(h,l)){const d=Me(i,c),f=Oe(h,l);return te(i,a,St),s(d,f,!1,o,r+i,St)}else{let R=function(_){const{uint16Array:D,uint32Array:B}=ee;let N=_*2;for(;!Ae(N,D);)_=Fe(_),N=_*2;return Me(_,B)},L=function(_){const{uint16Array:D,uint32Array:B}=ee;let N=_*2;for(;!Ae(N,D);)_=Ne(_,B),N=_*2;return Me(_,B)+Oe(N,D)};const d=Fe(i),f=Ne(i,c);let g=d,v=f,p,m,y,x;if(n&&(y=St,x=is,te(g,a,y),te(v,a,x),p=n(y),m=n(x),m<p)){g=f,v=d;const _=p;p=m,m=_,y=x}y||(y=St,te(g,a,y));const b=Ae(g*2,l),w=e(y,b,p,o+1,r+g);let E;if(w===uo){const _=R(g),B=L(g)-_;E=s(_,B,!0,o+1,r+g,y)}else E=w&&$n(g,t,e,s,n,r,o+1);if(E)return!0;x=is,te(v,a,x);const T=Ae(v*2,l),A=e(x,T,m,o+1,r+v);let C;if(A===uo){const _=R(v),B=L(v)-_;C=s(_,B,!0,o+1,r+v,x)}else C=A&&$n(v,t,e,s,n,r,o+1);return!!C}}const As=new M,En=new M;function Yh(i,t,e={},s=0,n=1/0){const r=s*s,o=n*n;let a=1/0,l=null;if(i.shapecast({boundsTraverseOrder:h=>(As.copy(t).clamp(h.min,h.max),As.distanceToSquared(t)),intersectsBounds:(h,u,d)=>d<a&&d<o,intersectsTriangle:(h,u)=>{h.closestPointToPoint(t,As);const d=t.distanceToSquared(As);return d<a&&(En.copy(As),a=d,l=u),d<r}}),a===1/0)return null;const c=Math.sqrt(a);return e.point?e.point.copy(En):e.point=En.clone(),e.distance=c,e.faceIndex=l,e}const Kt=new M,Xt=new M,Yt=new M,ii=new F,ni=new F,ri=new F,go=new M,vo=new M,yo=new M,oi=new M;function $h(i,t,e,s,n,r){let o;return r===Ds?o=i.intersectTriangle(s,e,t,!0,n):o=i.intersectTriangle(t,e,s,r!==ze,n),o===null?null:{distance:i.origin.distanceTo(n),point:n.clone()}}function Zh(i,t,e,s,n,r,o,a,l){Kt.fromBufferAttribute(t,r),Xt.fromBufferAttribute(t,o),Yt.fromBufferAttribute(t,a);const c=$h(i,Kt,Xt,Yt,oi,l);if(c){s&&(ii.fromBufferAttribute(s,r),ni.fromBufferAttribute(s,o),ri.fromBufferAttribute(s,a),c.uv=Bs.getInterpolation(oi,Kt,Xt,Yt,ii,ni,ri,new F)),n&&(ii.fromBufferAttribute(n,r),ni.fromBufferAttribute(n,o),ri.fromBufferAttribute(n,a),c.uv1=Bs.getInterpolation(oi,Kt,Xt,Yt,ii,ni,ri,new F)),e&&(go.fromBufferAttribute(e,r),vo.fromBufferAttribute(e,o),yo.fromBufferAttribute(e,a),c.normal=Bs.getInterpolation(oi,Kt,Xt,Yt,go,vo,yo,new M),c.normal.dot(i.direction)>0&&c.normal.multiplyScalar(-1));const h={a:r,b:o,c:a,normal:new M,materialIndex:0};Bs.getNormal(Kt,Xt,Yt,h.normal),c.face=h,c.faceIndex=r}return c}function on(i,t,e,s,n){const r=s*3;let o=r+0,a=r+1,l=r+2;const c=i.index;i.index&&(o=c.getX(o),a=c.getX(a),l=c.getX(l));const{position:h,normal:u,uv:d,uv1:f}=i.attributes,g=Zh(e,h,u,d,f,o,a,l,t);return g?(g.faceIndex=s,n&&n.push(g),g):null}function ae(i,t,e,s){const n=i.a,r=i.b,o=i.c;let a=t,l=t+1,c=t+2;e&&(a=e.getX(a),l=e.getX(l),c=e.getX(c)),n.x=s.getX(a),n.y=s.getY(a),n.z=s.getZ(a),r.x=s.getX(l),r.y=s.getY(l),r.z=s.getZ(l),o.x=s.getX(c),o.y=s.getY(c),o.z=s.getZ(c)}function Qh(i,t,e,s,n,r){const{geometry:o,_indirectBuffer:a}=i;for(let l=s,c=s+n;l<c;l++)on(o,t,e,l,r)}function Jh(i,t,e,s,n){const{geometry:r,_indirectBuffer:o}=i;let a=1/0,l=null;for(let c=s,h=s+n;c<h;c++){let u;u=on(r,t,e,c),u&&u.distance<a&&(l=u,a=u.distance)}return l}function ed(i,t,e,s,n,r,o){const{geometry:a}=e,{index:l}=a,c=a.attributes.position;for(let h=i,u=t+i;h<u;h++){let d;if(d=h,ae(o,d*3,l,c),o.needsUpdate=!0,s(o,d,n,r))return!0}return!1}function td(i,t=null){t&&Array.isArray(t)&&(t=new Set(t));const e=i.geometry,s=e.index?e.index.array:null,n=e.attributes.position;let r,o,a,l,c=0;const h=i._roots;for(let d=0,f=h.length;d<f;d++)r=h[d],o=new Uint32Array(r),a=new Uint16Array(r),l=new Float32Array(r),u(0,c),c+=r.byteLength;function u(d,f,g=!1){const v=d*2;if(a[v+15]===rn){const m=o[d+6],y=a[v+14];let x=1/0,b=1/0,w=1/0,E=-1/0,T=-1/0,A=-1/0;for(let C=3*m,R=3*(m+y);C<R;C++){let L=s[C];const _=n.getX(L),D=n.getY(L),B=n.getZ(L);_<x&&(x=_),_>E&&(E=_),D<b&&(b=D),D>T&&(T=D),B<w&&(w=B),B>A&&(A=B)}return l[d+0]!==x||l[d+1]!==b||l[d+2]!==w||l[d+3]!==E||l[d+4]!==T||l[d+5]!==A?(l[d+0]=x,l[d+1]=b,l[d+2]=w,l[d+3]=E,l[d+4]=T,l[d+5]=A,!0):!1}else{const m=d+8,y=o[d+6],x=m+f,b=y+f;let w=g,E=!1,T=!1;t?w||(E=t.has(x),T=t.has(b),w=!E&&!T):(E=!0,T=!0);const A=w||E,C=w||T;let R=!1;A&&(R=u(m,f,w));let L=!1;C&&(L=u(y,f,w));const _=R||L;if(_)for(let D=0;D<3;D++){const B=m+D,N=y+D,H=l[B],J=l[B+3],ne=l[N],pe=l[N+3];l[d+D]=H<ne?H:ne,l[d+D+3]=J>pe?J:pe}return _}}}const bo=new le;function Mt(i,t,e,s){return te(i,t,bo),e.intersectBox(bo,s)}function sd(i,t,e,s,n,r){const{geometry:o,_indirectBuffer:a}=i;for(let l=s,c=s+n;l<c;l++){let h=a?a[l]:l;on(o,t,e,h,r)}}function id(i,t,e,s,n){const{geometry:r,_indirectBuffer:o}=i;let a=1/0,l=null;for(let c=s,h=s+n;c<h;c++){let u;u=on(r,t,e,o?o[c]:c),u&&u.distance<a&&(l=u,a=u.distance)}return l}function nd(i,t,e,s,n,r,o){const{geometry:a}=e,{index:l}=a,c=a.attributes.position;for(let h=i,u=t+i;h<u;h++){let d;if(d=e.resolveTriangleIndex(h),ae(o,d*3,l,c),o.needsUpdate=!0,s(o,d,n,r))return!0}return!1}const xo=new M;function rd(i,t,e,s,n){ee.setBuffer(i._roots[t]),Zn(0,i,e,s,n),ee.clearBuffer()}function Zn(i,t,e,s,n){const{float32Array:r,uint16Array:o,uint32Array:a}=ee,l=i*2;if(Ae(l,o)){const h=Me(i,a),u=Oe(l,o);Qh(t,e,s,h,u,n)}else{const h=Fe(i);Mt(h,r,s,xo)&&Zn(h,t,e,s,n);const u=Ne(i,a);Mt(u,r,s,xo)&&Zn(u,t,e,s,n)}}const wo=new M,od=["x","y","z"];function ad(i,t,e,s){ee.setBuffer(i._roots[t]);const n=Qn(0,i,e,s);return ee.clearBuffer(),n}function Qn(i,t,e,s){const{float32Array:n,uint16Array:r,uint32Array:o}=ee;let a=i*2;if(Ae(a,r)){const c=Me(i,o),h=Oe(a,r);return Jh(t,e,s,c,h)}else{const c=Ga(i,o),h=od[c],d=s.direction[h]>=0;let f,g;d?(f=Fe(i),g=Ne(i,o)):(f=Ne(i,o),g=Fe(i));const p=Mt(f,n,s,wo)?Qn(f,t,e,s):null;if(p){const x=p.point[h];if(d?x<=n[g+c]:x>=n[g+c+3])return p}const y=Mt(g,n,s,wo)?Qn(g,t,e,s):null;return p&&y?p.distance<=y.distance?p:y:p||y||null}}const ai=new le,$t=new He,Zt=new He,Ms=new ie,So=new Se,li=new Se;function ld(i,t,e,s){ee.setBuffer(i._roots[t]);const n=Jn(0,i,e,s);return ee.clearBuffer(),n}function Jn(i,t,e,s,n=null){const{float32Array:r,uint16Array:o,uint32Array:a}=ee;let l=i*2;if(n===null&&(e.boundingBox||e.computeBoundingBox(),So.set(e.boundingBox.min,e.boundingBox.max,s),n=So),Ae(l,o)){const h=t.geometry,u=h.index,d=h.attributes.position,f=e.index,g=e.attributes.position,v=Me(i,a),p=Oe(l,o);if(Ms.copy(s).invert(),e.boundsTree)return te(i,r,li),li.matrix.copy(Ms),li.needsUpdate=!0,e.boundsTree.shapecast({intersectsBounds:y=>li.intersectsBox(y),intersectsTriangle:y=>{y.a.applyMatrix4(s),y.b.applyMatrix4(s),y.c.applyMatrix4(s),y.needsUpdate=!0;for(let x=v*3,b=(p+v)*3;x<b;x+=3)if(ae(Zt,x,u,d),Zt.needsUpdate=!0,y.intersectsTriangle(Zt))return!0;return!1}});for(let m=v*3,y=(p+v)*3;m<y;m+=3){ae($t,m,u,d),$t.a.applyMatrix4(Ms),$t.b.applyMatrix4(Ms),$t.c.applyMatrix4(Ms),$t.needsUpdate=!0;for(let x=0,b=f.count;x<b;x+=3)if(ae(Zt,x,f,g),Zt.needsUpdate=!0,$t.intersectsTriangle(Zt))return!0}}else{const h=i+8,u=a[i+6];return te(h,r,ai),!!(n.intersectsBox(ai)&&Jn(h,t,e,s,n)||(te(u,r,ai),n.intersectsBox(ai)&&Jn(u,t,e,s,n)))}}const ci=new ie,An=new Se,Cs=new Se,cd=new M,ud=new M,hd=new M,dd=new M;function fd(i,t,e,s={},n={},r=0,o=1/0){t.boundingBox||t.computeBoundingBox(),An.set(t.boundingBox.min,t.boundingBox.max,e),An.needsUpdate=!0;const a=i.geometry,l=a.attributes.position,c=a.index,h=t.attributes.position,u=t.index,d=Ie.getPrimitive(),f=Ie.getPrimitive();let g=cd,v=ud,p=null,m=null;n&&(p=hd,m=dd);let y=1/0,x=null,b=null;return ci.copy(e).invert(),Cs.matrix.copy(ci),i.shapecast({boundsTraverseOrder:w=>An.distanceToBox(w),intersectsBounds:(w,E,T)=>T<y&&T<o?(E&&(Cs.min.copy(w.min),Cs.max.copy(w.max),Cs.needsUpdate=!0),!0):!1,intersectsRange:(w,E)=>{if(t.boundsTree)return t.boundsTree.shapecast({boundsTraverseOrder:A=>Cs.distanceToBox(A),intersectsBounds:(A,C,R)=>R<y&&R<o,intersectsRange:(A,C)=>{for(let R=A,L=A+C;R<L;R++){ae(f,3*R,u,h),f.a.applyMatrix4(e),f.b.applyMatrix4(e),f.c.applyMatrix4(e),f.needsUpdate=!0;for(let _=w,D=w+E;_<D;_++){ae(d,3*_,c,l),d.needsUpdate=!0;const B=d.distanceToTriangle(f,g,p);if(B<y&&(v.copy(g),m&&m.copy(p),y=B,x=_,b=R),B<r)return!0}}}});{const T=gs(t);for(let A=0,C=T;A<C;A++){ae(f,3*A,u,h),f.a.applyMatrix4(e),f.b.applyMatrix4(e),f.c.applyMatrix4(e),f.needsUpdate=!0;for(let R=w,L=w+E;R<L;R++){ae(d,3*R,c,l),d.needsUpdate=!0;const _=d.distanceToTriangle(f,g,p);if(_<y&&(v.copy(g),m&&m.copy(p),y=_,x=R,b=A),_<r)return!0}}}}}),Ie.releasePrimitive(d),Ie.releasePrimitive(f),y===1/0?null:(s.point?s.point.copy(v):s.point=v.clone(),s.distance=y,s.faceIndex=x,n&&(n.point?n.point.copy(m):n.point=m.clone(),n.point.applyMatrix4(ci),v.applyMatrix4(ci),n.distance=v.sub(n.point).length(),n.faceIndex=b),s)}function pd(i,t=null){t&&Array.isArray(t)&&(t=new Set(t));const e=i.geometry,s=e.index?e.index.array:null,n=e.attributes.position;let r,o,a,l,c=0;const h=i._roots;for(let d=0,f=h.length;d<f;d++)r=h[d],o=new Uint32Array(r),a=new Uint16Array(r),l=new Float32Array(r),u(0,c),c+=r.byteLength;function u(d,f,g=!1){const v=d*2;if(a[v+15]===rn){const m=o[d+6],y=a[v+14];let x=1/0,b=1/0,w=1/0,E=-1/0,T=-1/0,A=-1/0;for(let C=m,R=m+y;C<R;C++){const L=3*i.resolveTriangleIndex(C);for(let _=0;_<3;_++){let D=L+_;D=s?s[D]:D;const B=n.getX(D),N=n.getY(D),H=n.getZ(D);B<x&&(x=B),B>E&&(E=B),N<b&&(b=N),N>T&&(T=N),H<w&&(w=H),H>A&&(A=H)}}return l[d+0]!==x||l[d+1]!==b||l[d+2]!==w||l[d+3]!==E||l[d+4]!==T||l[d+5]!==A?(l[d+0]=x,l[d+1]=b,l[d+2]=w,l[d+3]=E,l[d+4]=T,l[d+5]=A,!0):!1}else{const m=d+8,y=o[d+6],x=m+f,b=y+f;let w=g,E=!1,T=!1;t?w||(E=t.has(x),T=t.has(b),w=!E&&!T):(E=!0,T=!0);const A=w||E,C=w||T;let R=!1;A&&(R=u(m,f,w));let L=!1;C&&(L=u(y,f,w));const _=R||L;if(_)for(let D=0;D<3;D++){const B=m+D,N=y+D,H=l[B],J=l[B+3],ne=l[N],pe=l[N+3];l[d+D]=H<ne?H:ne,l[d+D+3]=J>pe?J:pe}return _}}}const To=new M;function md(i,t,e,s,n){ee.setBuffer(i._roots[t]),er(0,i,e,s,n),ee.clearBuffer()}function er(i,t,e,s,n){const{float32Array:r,uint16Array:o,uint32Array:a}=ee,l=i*2;if(Ae(l,o)){const h=Me(i,a),u=Oe(l,o);sd(t,e,s,h,u,n)}else{const h=Fe(i);Mt(h,r,s,To)&&er(h,t,e,s,n);const u=Ne(i,a);Mt(u,r,s,To)&&er(u,t,e,s,n)}}const Eo=new M,gd=["x","y","z"];function vd(i,t,e,s){ee.setBuffer(i._roots[t]);const n=tr(0,i,e,s);return ee.clearBuffer(),n}function tr(i,t,e,s){const{float32Array:n,uint16Array:r,uint32Array:o}=ee;let a=i*2;if(Ae(a,r)){const c=Me(i,o),h=Oe(a,r);return id(t,e,s,c,h)}else{const c=Ga(i,o),h=gd[c],d=s.direction[h]>=0;let f,g;d?(f=Fe(i),g=Ne(i,o)):(f=Ne(i,o),g=Fe(i));const p=Mt(f,n,s,Eo)?tr(f,t,e,s):null;if(p){const x=p.point[h];if(d?x<=n[g+c]:x>=n[g+c+3])return p}const y=Mt(g,n,s,Eo)?tr(g,t,e,s):null;return p&&y?p.distance<=y.distance?p:y:p||y||null}}const ui=new le,Qt=new He,Jt=new He,_s=new ie,Ao=new Se,hi=new Se;function yd(i,t,e,s){ee.setBuffer(i._roots[t]);const n=sr(0,i,e,s);return ee.clearBuffer(),n}function sr(i,t,e,s,n=null){const{float32Array:r,uint16Array:o,uint32Array:a}=ee;let l=i*2;if(n===null&&(e.boundingBox||e.computeBoundingBox(),Ao.set(e.boundingBox.min,e.boundingBox.max,s),n=Ao),Ae(l,o)){const h=t.geometry,u=h.index,d=h.attributes.position,f=e.index,g=e.attributes.position,v=Me(i,a),p=Oe(l,o);if(_s.copy(s).invert(),e.boundsTree)return te(i,r,hi),hi.matrix.copy(_s),hi.needsUpdate=!0,e.boundsTree.shapecast({intersectsBounds:y=>hi.intersectsBox(y),intersectsTriangle:y=>{y.a.applyMatrix4(s),y.b.applyMatrix4(s),y.c.applyMatrix4(s),y.needsUpdate=!0;for(let x=v,b=p+v;x<b;x++)if(ae(Jt,3*t.resolveTriangleIndex(x),u,d),Jt.needsUpdate=!0,y.intersectsTriangle(Jt))return!0;return!1}});for(let m=v,y=p+v;m<y;m++){const x=t.resolveTriangleIndex(m);ae(Qt,3*x,u,d),Qt.a.applyMatrix4(_s),Qt.b.applyMatrix4(_s),Qt.c.applyMatrix4(_s),Qt.needsUpdate=!0;for(let b=0,w=f.count;b<w;b+=3)if(ae(Jt,b,f,g),Jt.needsUpdate=!0,Qt.intersectsTriangle(Jt))return!0}}else{const h=i+8,u=a[i+6];return te(h,r,ui),!!(n.intersectsBox(ui)&&sr(h,t,e,s,n)||(te(u,r,ui),n.intersectsBox(ui)&&sr(u,t,e,s,n)))}}const di=new ie,Mn=new Se,Ps=new Se,bd=new M,xd=new M,wd=new M,Sd=new M;function Td(i,t,e,s={},n={},r=0,o=1/0){t.boundingBox||t.computeBoundingBox(),Mn.set(t.boundingBox.min,t.boundingBox.max,e),Mn.needsUpdate=!0;const a=i.geometry,l=a.attributes.position,c=a.index,h=t.attributes.position,u=t.index,d=Ie.getPrimitive(),f=Ie.getPrimitive();let g=bd,v=xd,p=null,m=null;n&&(p=wd,m=Sd);let y=1/0,x=null,b=null;return di.copy(e).invert(),Ps.matrix.copy(di),i.shapecast({boundsTraverseOrder:w=>Mn.distanceToBox(w),intersectsBounds:(w,E,T)=>T<y&&T<o?(E&&(Ps.min.copy(w.min),Ps.max.copy(w.max),Ps.needsUpdate=!0),!0):!1,intersectsRange:(w,E)=>{if(t.boundsTree){const T=t.boundsTree;return T.shapecast({boundsTraverseOrder:A=>Ps.distanceToBox(A),intersectsBounds:(A,C,R)=>R<y&&R<o,intersectsRange:(A,C)=>{for(let R=A,L=A+C;R<L;R++){const _=T.resolveTriangleIndex(R);ae(f,3*_,u,h),f.a.applyMatrix4(e),f.b.applyMatrix4(e),f.c.applyMatrix4(e),f.needsUpdate=!0;for(let D=w,B=w+E;D<B;D++){const N=i.resolveTriangleIndex(D);ae(d,3*N,c,l),d.needsUpdate=!0;const H=d.distanceToTriangle(f,g,p);if(H<y&&(v.copy(g),m&&m.copy(p),y=H,x=D,b=R),H<r)return!0}}}})}else{const T=gs(t);for(let A=0,C=T;A<C;A++){ae(f,3*A,u,h),f.a.applyMatrix4(e),f.b.applyMatrix4(e),f.c.applyMatrix4(e),f.needsUpdate=!0;for(let R=w,L=w+E;R<L;R++){const _=i.resolveTriangleIndex(R);ae(d,3*_,c,l),d.needsUpdate=!0;const D=d.distanceToTriangle(f,g,p);if(D<y&&(v.copy(g),m&&m.copy(p),y=D,x=R,b=A),D<r)return!0}}}}}),Ie.releasePrimitive(d),Ie.releasePrimitive(f),y===1/0?null:(s.point?s.point.copy(v):s.point=v.clone(),s.distance=y,s.faceIndex=x,n&&(n.point?n.point.copy(m):n.point=m.clone(),n.point.applyMatrix4(di),v.applyMatrix4(di),n.distance=v.sub(n.point).length(),n.faceIndex=b),s)}function Ed(){return typeof SharedArrayBuffer<"u"}const Ns=new ee.constructor,_i=new ee.constructor,mt=new xr(()=>new le),es=new le,ts=new le,Cn=new le,_n=new le;let Pn=!1;function Ad(i,t,e,s){if(Pn)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");Pn=!0;const n=i._roots,r=t._roots;let o,a=0,l=0;const c=new ie().copy(e).invert();for(let h=0,u=n.length;h<u;h++){Ns.setBuffer(n[h]),l=0;const d=mt.getPrimitive();te(0,Ns.float32Array,d),d.applyMatrix4(c);for(let f=0,g=r.length;f<g&&(_i.setBuffer(r[h]),o=ke(0,0,e,c,s,a,l,0,0,d),_i.clearBuffer(),l+=r[f].length,!o);f++);if(mt.releasePrimitive(d),Ns.clearBuffer(),a+=n[h].length,o)break}return Pn=!1,o}function ke(i,t,e,s,n,r=0,o=0,a=0,l=0,c=null,h=!1){let u,d;h?(u=_i,d=Ns):(u=Ns,d=_i);const f=u.float32Array,g=u.uint32Array,v=u.uint16Array,p=d.float32Array,m=d.uint32Array,y=d.uint16Array,x=i*2,b=t*2,w=Ae(x,v),E=Ae(b,y);let T=!1;if(E&&w)h?T=n(Me(t,m),Oe(t*2,y),Me(i,g),Oe(i*2,v),l,o+t,a,r+i):T=n(Me(i,g),Oe(i*2,v),Me(t,m),Oe(t*2,y),a,r+i,l,o+t);else if(E){const A=mt.getPrimitive();te(t,p,A),A.applyMatrix4(e);const C=Fe(i),R=Ne(i,g);te(C,f,es),te(R,f,ts);const L=A.intersectsBox(es),_=A.intersectsBox(ts);T=L&&ke(t,C,s,e,n,o,r,l,a+1,A,!h)||_&&ke(t,R,s,e,n,o,r,l,a+1,A,!h),mt.releasePrimitive(A)}else{const A=Fe(t),C=Ne(t,m);te(A,p,Cn),te(C,p,_n);const R=c.intersectsBox(Cn),L=c.intersectsBox(_n);if(R&&L)T=ke(i,A,e,s,n,r,o,a,l+1,c,h)||ke(i,C,e,s,n,r,o,a,l+1,c,h);else if(R)if(w)T=ke(i,A,e,s,n,r,o,a,l+1,c,h);else{const _=mt.getPrimitive();_.copy(Cn).applyMatrix4(e);const D=Fe(i),B=Ne(i,g);te(D,f,es),te(B,f,ts);const N=_.intersectsBox(es),H=_.intersectsBox(ts);T=N&&ke(A,D,s,e,n,o,r,l,a+1,_,!h)||H&&ke(A,B,s,e,n,o,r,l,a+1,_,!h),mt.releasePrimitive(_)}else if(L)if(w)T=ke(i,C,e,s,n,r,o,a,l+1,c,h);else{const _=mt.getPrimitive();_.copy(_n).applyMatrix4(e);const D=Fe(i),B=Ne(i,g);te(D,f,es),te(B,f,ts);const N=_.intersectsBox(es),H=_.intersectsBox(ts);T=N&&ke(C,D,s,e,n,o,r,l,a+1,_,!h)||H&&ke(C,B,s,e,n,o,r,l,a+1,_,!h),mt.releasePrimitive(_)}}return T}const fi=new Se,Mo=new le;class wr{static serialize(t,e={}){e={cloneBuffers:!0,...e};const s=t.geometry,n=t._roots,r=t._indirectBuffer,o=s.getIndex();let a;return e.cloneBuffers?a={roots:n.map(l=>l.slice()),index:o.array.slice(),indirectBuffer:r?r.slice():null}:a={roots:n,index:o.array,indirectBuffer:r},a}static deserialize(t,e,s={}){s={setIndex:!0,indirect:!!t.indirectBuffer,...s};const{index:n,roots:r,indirectBuffer:o}=t,a=new wr(e,{...s,[wn]:!0});if(a._roots=r,a._indirectBuffer=o||null,s.setIndex){const l=e.getIndex();if(l===null){const c=new oe(t.index,1,!1);e.setIndex(c)}else l.array!==n&&(l.array.set(n),l.needsUpdate=!0)}return a}get indirect(){return!!this._indirectBuffer}constructor(t,e={}){if(t.isBufferGeometry){if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(e=Object.assign({strategy:ka,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,[wn]:!1},e),e.useSharedArrayBuffer&&!Ed())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=t,this._roots=null,this._indirectBuffer=null,e[wn]||(Gh(this,e),!t.boundingBox&&e.setBoundingBox&&(t.boundingBox=this.getBoundingBox(new le)));const{_indirectBuffer:s}=this;this.resolveTriangleIndex=e.indirect?n=>s[n]:n=>n}refit(t=null){return(this.indirect?pd:td)(this,t)}traverse(t,e=0){const s=this._roots[e],n=new Uint32Array(s),r=new Uint16Array(s);o(0);function o(a,l=0){const c=a*2,h=r[c+15]===rn;if(h){const u=n[a+6],d=r[c+14];t(l,h,new Float32Array(s,a*4,6),u,d)}else{const u=a+bi/4,d=n[a+6],f=n[a+7];t(l,h,new Float32Array(s,a*4,6),f)||(o(u,l+1),o(d,l+1))}}}raycast(t,e=Ai){const s=this._roots,n=this.geometry,r=[],o=e.isMaterial,a=Array.isArray(e),l=n.groups,c=o?e.side:e,h=this.indirect?md:rd;for(let u=0,d=s.length;u<d;u++){const f=a?e[l[u].materialIndex].side:c,g=r.length;if(h(this,u,f,t,r),a){const v=l[u].materialIndex;for(let p=g,m=r.length;p<m;p++)r[p].face.materialIndex=v}}return r}raycastFirst(t,e=Ai){const s=this._roots,n=this.geometry,r=e.isMaterial,o=Array.isArray(e);let a=null;const l=n.groups,c=r?e.side:e,h=this.indirect?vd:ad;for(let u=0,d=s.length;u<d;u++){const f=o?e[l[u].materialIndex].side:c,g=h(this,u,f,t);g!=null&&(a==null||g.distance<a.distance)&&(a=g,o&&(g.face.materialIndex=l[u].materialIndex))}return a}intersectsGeometry(t,e){let s=!1;const n=this._roots,r=this.indirect?yd:ld;for(let o=0,a=n.length;o<a&&(s=r(this,o,t,e),!s);o++);return s}shapecast(t){const e=Ie.getPrimitive(),s=this.indirect?nd:ed;let{boundsTraverseOrder:n,intersectsBounds:r,intersectsRange:o,intersectsTriangle:a}=t;if(o&&a){const u=o;o=(d,f,g,v,p)=>u(d,f,g,v,p)?!0:s(d,f,this,a,g,v,e)}else o||(a?o=(u,d,f,g)=>s(u,d,this,a,f,g,e):o=(u,d,f)=>f);let l=!1,c=0;const h=this._roots;for(let u=0,d=h.length;u<d;u++){const f=h[u];if(l=Xh(this,u,r,o,n,c),l)break;c+=f.byteLength}return Ie.releasePrimitive(e),l}bvhcast(t,e,s){let{intersectsRanges:n,intersectsTriangles:r}=s;const o=Ie.getPrimitive(),a=this.geometry.index,l=this.geometry.attributes.position,c=this.indirect?g=>{const v=this.resolveTriangleIndex(g);ae(o,v*3,a,l)}:g=>{ae(o,g*3,a,l)},h=Ie.getPrimitive(),u=t.geometry.index,d=t.geometry.attributes.position,f=t.indirect?g=>{const v=t.resolveTriangleIndex(g);ae(h,v*3,u,d)}:g=>{ae(h,g*3,u,d)};if(r){const g=(v,p,m,y,x,b,w,E)=>{for(let T=m,A=m+y;T<A;T++){f(T),h.a.applyMatrix4(e),h.b.applyMatrix4(e),h.c.applyMatrix4(e),h.needsUpdate=!0;for(let C=v,R=v+p;C<R;C++)if(c(C),o.needsUpdate=!0,r(o,h,C,T,x,b,w,E))return!0}return!1};if(n){const v=n;n=function(p,m,y,x,b,w,E,T){return v(p,m,y,x,b,w,E,T)?!0:g(p,m,y,x,b,w,E,T)}}else n=g}return Ad(this,t,e,n)}intersectsBox(t,e){return fi.set(t.min,t.max,e),fi.needsUpdate=!0,this.shapecast({intersectsBounds:s=>fi.intersectsBox(s),intersectsTriangle:s=>fi.intersectsTriangle(s)})}intersectsSphere(t){return this.shapecast({intersectsBounds:e=>t.intersectsBox(e),intersectsTriangle:e=>e.intersectsSphere(t)})}closestPointToGeometry(t,e,s={},n={},r=0,o=1/0){return(this.indirect?Td:fd)(this,t,e,s,n,r,o)}closestPointToPoint(t,e={},s=0,n=1/0){return Yh(this,t,e,s,n)}getBoundingBox(t){return t.makeEmpty(),this._roots.forEach(s=>{te(0,new Float32Array(s),Mo),t.union(Mo)}),t}}function Co(i,t,e){return i===null||(i.point.applyMatrix4(t.matrixWorld),i.distance=i.point.distanceTo(e.ray.origin),i.object=t,i.distance<e.near||i.distance>e.far)?null:i}const Rn=new la,_o=new ie,Md=de.prototype.raycast;function Cd(i,t){if(this.geometry.boundsTree){if(this.material===void 0)return;_o.copy(this.matrixWorld).invert(),Rn.copy(i.ray).applyMatrix4(_o);const e=this.geometry.boundsTree;if(i.firstHitOnly===!0){const s=Co(e.raycastFirst(Rn,this.material),this,i);s&&t.push(s)}else{const s=e.raycast(Rn,this.material);for(let n=0,r=s.length;n<r;n++){const o=Co(s[n],this,i);o&&t.push(o)}}}else Md.call(this,i,t)}function _d(i){return this.boundsTree=new wr(this,i),this.boundsTree}function Pd(){this.boundsTree=null}class Rd extends bh{constructor(e){super(e);O(this,"raycaster");this.initMeshBVH(),this.initTWEEN()}use(e){return e.register(this),e}memoryTrack(e){return e}initCSS2DRenderer(){const e=Symbol(),s=new xh;s.setSize(window.innerWidth,window.innerHeight),s.domElement.id="css2dRenderer",this.onRenderQueue.set(e,()=>s.render(this.scene,this.camera)),this.onresizeQueue.set(e,s.setSize),document.body.appendChild(s.domElement),this.initCSS2DRenderer=()=>{}}initCSS3DRenderer(){const e=Symbol(),s=new Th;s.setSize(window.innerWidth,window.innerHeight),s.domElement.id="css3dRenderer",this.onRenderQueue.set(e,()=>s.render(this.scene,this.camera)),this.onresizeQueue.set(e,s.setSize),document.body.appendChild(s.domElement),this.initCSS3DRenderer=()=>{}}initTWEEN(){this.onRenderQueue.set(Symbol(),()=>Hl())}initMeshBVH(){Ht.prototype.computeBoundsTree=_d,Ht.prototype.disposeBoundsTree=Pd,de.prototype.raycast=Cd,Mi.prototype.firstHitOnly=!0}initRaycaster(){this.raycaster=new Eh(this.camera,this.domElement),this.initRaycaster=()=>{}}raycast(e,s,n){return this.raycaster||this.initRaycaster(),this.raycaster.raycast(e,s,n)}setRaycasterState(e,s){this.raycaster||this.initRaycaster(),this.raycaster.setState(e,s)}}class Ld extends hs{constructor(){super();const t=new Q;t.name="extra",this._add(t),this.extra=t}_add(t){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this._add(arguments[e]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(t.parent!==null&&t.parent.remove(t),t.parent=this,this.children.push(t)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)}add(t){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(t.parent!==null&&t.parent.remove(t),t.parent=this.extra,this.extra.children.push(t)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)}dispose(){for(;this.extra.children.length;)this.extra.children.pop().deleteSelf()}}class Dd{constructor(t){this.core=t,this.scene=new Ld}init(){}onEnter(){}onLeave(){}onLoaded(){}update(){}updateOrientation(){this.core.orientation.updateModules()}addEventListener(){}removeEventListener(){}changeWeather(){console.log("当前子系统未调用天气模块")}changeLighting(){console.log("当前子系统未调用天气模块")}setCameraState(){console.log("当前子系统没有相机漫游功能")}beginWander(){console.log("当前子系统没有第一人称漫游功能")}endWander(){console.log("当前子系统没有第一人称漫游功能")}initGridHelper(t=100){const e=new ma(t);this.scene.add(e)}initAxesHelper(t=100){const e=new ga(t);this.scene.add(e)}add(){this.scene.add(...arguments)}_add(){this.scene._add(...arguments)}dispose(){this.scene.dispose()}}function $e(i={},t,e){const{innerText:s,className:n,id:r,children:o=[]}=i,a=document.createElement("div");return s&&(a.innerText=s),n&&(a.className=n),r&&(a.id=r),a.title=s||"",o.forEach(l=>{a.appendChild(l)}),a.oncontextmenu=()=>!1,t&&e&&a.addEventListener(t,e),a}function Ce(i,t){const e=new yr(i);return e.name=t,e}const Bd=()=>{window.parent.postMessage({cmd:"onLoading"},"*")},Id=()=>{window.parent.postMessage({cmd:"onLoaded"},"*")},Od=i=>{window.parent.postMessage({cmd:"inspectionId",param:i},"*")},Fd=i=>{window.parent.postMessage({cmd:"personDetail",param:i},"*")},ja=()=>{window.parent.postMessage({cmd:"closeDomDialog"},"*")},Nd=i=>{window.parent.postMessage({cmd:"gatherCallBack",param:i},"*")},Va=i=>{window.parent.postMessage({cmd:"web3dChangeIndoor",param:i},"*")},Ud=i=>{window.parent.postMessage({cmd:"buildingDetail",param:{id:i}},"*")},kd=i=>{window.parent.postMessage({cmd:"dbClickBuilding",param:i},"*")},zd=i=>{window.parent.postMessage({cmd:"cameraVideoId",param:i},"*")},Hd=i=>{window.parent.postMessage({cmd:"switchByBuildingId",param:i},"*")},Gd=i=>{window.parent.postMessage({cmd:"clickUnion",param:i},"*")};class jd{constructor(){this.scene=null,this.core=null,this.main=null,this.camera=null,this.controls=null,this.searchCameraId=null,this.cameraEquipSprite=null,this.inspectionEquipSprite=null,this.beaconEquipSprite=null,this.inspectionSystemEquipSprite=null,this.searchInspection=null,this.searchCameraIdNeed=null,this.searchInspectionSystemNeed=null,this.cherryArray=[]}onLoad(t,e){this.controls=t.controls,this.camera=t.camera,this.core=t,this.main=e,this.scene=t.scene,this.tweenControl=t.tweenControl,this.equipGroup=new Q,this.equipGroup.name="equip",this.scene.add(this.equipGroup),this.equip={camera:{},inspection:{},beacon:{},inspectionSystem:{}},this.cameraEquipSprite=this.generateLabel("/equip/camera.png"),this.inspectionEquipSprite=this.generateLabel("/equip/inspection.png"),this.beaconEquipSprite=this.generateLabel("/equip/beacon.png",.018),this.inspectionSystemEquipSprite=this.generateLabel("/equip/xunjianListOff.png",.04),this.chooseEquip={camera:this.cameraEquipSprite,inspection:this.inspectionEquipSprite,beacon:this.beaconEquipSprite,inspectionSystem:this.inspectionSystemEquipSprite}}has(t,e){return this.equip[e][t]}get(t,e){return this.equip[e][t]}del(t,e){this.get(t,e).deleteSelf(),delete this.equip[e][t]}searchEquip(t,e){if(!this.has(t,e))return!1;let s=this.has(t,e).position;if(this.core.tweenControl.lerpTo(s,50,1e3,new M(0,10,0)),e==="camera"&&(zd(t),this.searchCameraId=t),e==="inspectionSystem"){let n=new Ke().load("/equip/xunjianListOff.png"),r=new Ke().load("/equip/xunjianListOn.png");Object.entries(this.equip[e]).forEach(([o,a])=>{o==t?(a.children[0].material.map=r,a.children[0].visible=!0):a.children[0].material.map=n}),Od(t)}e!=="inspectionSystem"&&this.boardVisibleSingle(t,!0,e)}hideInspectionSystemIcon(t){const{visible:e,id:s}=t;if(this.has(s,"inspectionSystem")){let n=new Ke().load("/equip/xunjianListOff.png");this.get(s,"inspectionSystem").children[0].material.map=n,this.get(s,"inspectionSystem").children[0].visible=e,this.core.core.resetCamera()}}setSearchInspection(t){const{id:e,name:s,position:n}=t;this.searchInspection={id:e,name:s,position:n}}boardVisibleSingle(t,e,s){Object.entries(this.equip[s]).forEach(([n,r])=>{n==t?(r.children[0].visible=e,r.children[1].visible=e):r.children[1].visible=!e})}closeCameraDialog(t){this.equip.camera[t].children[1].visible=!1,this.searchCameraId=null}setCherryArray(t){this.cherryArray=t}cherryPick(){Object.values(this.equip.camera).map(t=>{this.cherryArray.includes("camera")?t.children[0].visible=!0:(t.children[0].visible=!1,t.children[1].visible=!1)}),Object.values(this.equip.beacon).map(t=>{this.cherryArray.includes("beacon")?t.children[0].visible=!0:(t.children[0].visible=!1,t.children[1].visible=!1)}),Object.values(this.equip.inspectionSystem).map(t=>{this.cherryArray.includes("inspectionSystem")?t.children[0].visible=!0:(t.children[0].visible=!1,t.children[1].visible=!1)})}clearEquipType(t){t.forEach(e=>{this.dispose(e)})}dataProcess(t,e){return new Promise(s=>{this.dispose(e),t.map((n,r)=>{const{position:o,id:a,name:l,originId:c,sceneType:h}=n;let u=new ve,d=this.chooseEquip[e].clone();e==="inspectionSystem"&&(d=this.generateLabel("/equip/xunjianListOff.png")),d.typeName=e,d.name=a;let f=this.setPersonBoard({name:l,id:a},!1,this.boardClick());u.add(d),u.add(f),u.position.set(o.x,o.y,o.z),this.equipGroup.add(u),this.core.orientation.orientation3D.pointerArr.push(u),this.equip[e][a]=u,r===t.length-1&&(this.cherryPick(),s(n))})})}setPersonBoard(t,e=!1,s){let n=document.createElement("div"),r=document.createElement("div"),o=document.createElement("div"),a=document.createElement("div"),l=document.createElement("div");l.append(n),l.append(r),l.append(o),l.append(a),l.draggable=!1,r.className="beilu_three_Board_text_person_top",o.className="beilu_three_Board_text_person_bottom",l.className="beilu_three_Board_text_person",a.className="beilu_three_Board_text_person_bottom_down",n.append(t.name),s&&(n.onclick=()=>{s()});let c=Ce(l,"board"+t.id);return c.visible=e,c}boardClick(){}generateLabel(t,e=.028){const s=new Ke().load(t),n=new pr({map:s,sizeAttenuation:!1,depthTest:!1,depthWrite:!1}),r=new Ci(n);return r.renderOrder=4,r.scale.set(e,e,e),r.center=new F(.5,0),r}hideCameraById(t){this.equip.camera[t].children[0].visible=!1,this.equip.camera[t].children[1].visible=!1}dispose(t){t==="camera"&&(this.searchCameraId=null);const e=Object.keys(this.equip[t]);for(let s=e.length-1;s>=0;s--)this.equip[t][e[s]].deleteSelf();this.equip[t]={}}disposeAll(){Object.values(this.equip.camera).forEach(t=>{t.deleteSelf()}),this.equip.camera={},Object.values(this.equip.inspection).forEach(t=>{t.deleteSelf()}),this.equip.inspection={},Object.values(this.equip.beacon).forEach(t=>{t.deleteSelf()}),this.equip.beacon={},Object.values(this.equip.inspectionSystem).forEach(t=>{t.deleteSelf()}),this.equip.inspectionSystem={}}}const q=new jd;function Vd(i){let t=i.length,e=0;for(let s=0;s<t;s++)e+=i[s].cross(i[(s+1)%t]);return Math.abs(e/2)}function qd(i,t,e,s){const n=t.clone().sub(i),r=e.clone().sub(i),o=s.clone().sub(i),a=s.clone().sub(e),l=i.clone().sub(e),c=t.clone().sub(e),h=n.cross(r),u=n.cross(o),d=a.cross(l),f=a.cross(c),g=h*u,v=d*f;return g<0&&v<0?!0:h===0&&u===0&&d===0&&f===0?!(e.x>=i.x&&e.x>=t.x&&s.x>=i.x&&s.y>=t.x||e.x<=i.x&&e.x<=t.x&&s.x<=i.x&&s.y<=t.x):!1}function Wd(i,t){let e=i.length;if(e===0)return!1;if(e===1)return i[0].equals(t);for(let s=0;s<e-1;s++)if(qd(i[s],i[s+1],i[e-1],t))return!0;return!1}function Kd(i){const t=[];for(let e=0;e<i.length;e++)t.push(i[e].x,i[e].y,i[e].z);return t}function xi(i,t="x",e="y"){if(Array.isArray(i)){const s=[];return i.forEach(n=>s.push(xi(n,t,e))),s}else{const s=new F;return s.x=i[t],s.y=i[e],s}}function Po(i){let t=0;for(let e=1;e<i.length;e++)t+=i[e].distanceTo(i[e-1]);return t}function Xd(i){let t=null;const e=new Proxy(i,{construct(s,n,r){return t||(t=Reflect.construct(s,n,r)),t}});return i.prototype.constructor=e,e}function Ln(i,t=new M(1,1,1),e=new F(.5,.5)){const s=new Ke().load(i),n=new pr({map:s,sizeAttenuation:!1}),r=new Ci(n);return r.scale.copy(t),r.center.copy(e),r}class Yd extends yr{constructor(){let t=document.createElement("div"),e=document.createElement("div"),s=document.createElement("div"),n=document.createElement("div"),r=document.createElement("div");r.append(t),r.append(e),r.append(s),r.append(n),r.draggable=!1,e.className="beilu_three_Board_text_person_top",s.className="beilu_three_Board_text_person_bottom",r.className="red_three_Board_text_person",n.className="beilu_three_Board_text_person_bottom_down",super(r)}setInnerText(t){this.element.innerText=t}}class $d extends yr{constructor(t,e){let s=document.createElement("div");s.className="ellipse-container",s.style.cursor="pointer",s.style.background="#3F35F2",s.draggable=!1,s.innerText=t.name,e&&(s.onclick=()=>{e(t.cluster)}),super(s),this.name="board"+t.id}}const Zd=Xd(Yd);class vs{constructor(){O(this,"order",2)}update(){console.log("构造函数缺少 update 方法")}}class Qd{constructor(t){this.person=null,this.object3d=new ve,this.object3d.name="personDanger",this.label=t.clone(),this.board=new Zd,this.dangerPersonInfo=null,this.object3d.add(this.label,this.board)}setAlarm(t){this.person=t,this.board.setInnerText(t.name);const e=t.position;this.object3d.position.copy(e),this.object3d.add(this.label,this.board)}clearAlarm(){this.object3d.removeFromParent(),this.board.element.parentNode.removeChild(this.board.element)}}const Dn=new M(.03,.03,.03),Ro={externalPerson:Ln("/person/externalPerson.png",Dn),insidePerson:Ln("/person/insidePerson.png",Dn),laborPerson:Ln("/person/laborPerson.png",Dn)};class Jd extends vs{constructor(e){super();O(this,"gatherClick",e=>{this.core.ground.boxSelectStatus!==!0&&Nd(e.map(s=>s.id)),this.clusterModule.disperseClusterOnEvent(e),this.update(this.orientation)});O(this,"disposeClusterGroup",()=>{re.dispose(this.clusterGroup.children),[...this.singleGroup.children].forEach(e=>{e.removeFromParent(),e.traverse(s=>{s.element&&s.element.parentNode&&s.element.parentNode.removeChild(s.element)})})});this.order=10,this.orientation=e,this.core=e.core,this.camera=e.core.camera,this.controls=e.core.controls,this.orientationLabels=new Q,this.orientationLabels.name="PersonLabel",this.labelSprite=null,this.warningPerson=null,this.personGroup={[Xe.SCENE_TYPE.INDOOR]:{},[Xe.SCENE_TYPE.OUTDOOR]:new Q},this.clusterModule=e.clusterModule,this.clusterGroup=new Q,this.clusterGroup.name="clusterGroup",this.singleGroup=new Q,this.singleGroup.name="singleGroup",this.pointerArr=[],this.personAlarm=new Qd(Ro.insidePerson),this.orientation.addUpdatable(this),this.personDangerData=null,this.hiddenAllPerson=!1}add(e){const s=this.personGroup[e.sceneType];if(e.sceneType===Xe.SCENE_TYPE.INDOOR){const n=e.originId.slice(0,-3);s[n]||(s[n]={}),s[n][e.originId]||(s[n][e.originId]=new Q),s[n][e.originId].add(e.object3d)}else s.add(e.object3d)}create(e,s){const n=new ve;n.name=e.id;const r=Ro[e.typeName].clone();r.center.set(.5,0),r.name=e.id,r.renderOrder=10,n.add(r);const o=$e({innerText:e.name,className:`person-sprite-${e.typeName}`}),a=$e({className:"person-sprite-container",children:[o]},"click"),l=Ce(a);return l.classTypeName=`person-sprite-${e.typeName}`,l.position.y=0,l.center.set(.5,.2),n.add(l),e.id===this.orientation.followId?(s?n.position.copy(e.position):n.position.copy(this.orientation.followModule.from),this.orientation.followModule.to.copy(e.position),l.position.y=1.8):n.position.copy(e.position),n}delete(e){const s=this.orientation.get(e.id);re.dispose(s.object3d,!0)}updateData(e){if(this.orientation.followId!==e.id)return e.object3d.position.copy(e.position);e.object3d.position.equals(e.position)||this.orientation.followModule.createPath(e)}update(e){const s=e.clusterModule.clusterMap,n=e.clusterModule.singleData;if([...this.clusterGroup.children].forEach(o=>re.dispose(o,!0)),[...this.singleGroup.children].forEach(o=>{o.removeFromParent()}),this.pointerArr.length=0,n.map(o=>{this.singleGroup.add(o.object3d)}),s.forEach((o,a)=>{if(o.length===1&&this.singleGroup.add(o[0].object3d),o.length>1){const l=new $d({name:o.length,id:a,cluster:o},this.gatherClick);l.position.copy(o.position),this.clusterGroup.add(l),this.pointerArr.push(l)}}),this.singleGroup.traverse(o=>{o.isPass||(o.visible=!0,o.element&&(o.element.style.display="block"))}),this.orientation.searchId){let o=this.orientation.get(this.orientation.searchId);const{originId:a,sceneType:l}=o,{sceneType:c,originId:h}=this.core.getCurrentOriginId();if(l!==c||l===0&&a!==h){if(this.orientation.followId)return this.orientation.search();this.orientation.clearSearch(),ja()}else this.orientation.search()}this.setPointerArr(),this.hiddenAllPerson===!0&&this.setAllPersonVisible(!1),this.core.scene.add(this.singleGroup),this.core.scene.add(this.clusterGroup)}setPointerArr(){this.singleGroup&&this.singleGroup.children.forEach(e=>{this.pointerArr.push(e)}),q.equipGroup&&q.equipGroup.children.forEach(e=>{this.pointerArr.push(e)}),this.core.sceneType===1&&this.core.ground.pointerArr.forEach(e=>{this.pointerArr.push(e)})}setAllPersonVisible(e){this.singleGroup.traverse(s=>{s.visible=e}),this.clusterGroup.traverse(s=>{s.visible=e})}disposeAlarm(){re.dispose(this.personAlarm.object3d)}onCameraChange(){this.clusterModule.onCameraChange()}getCurrentPersonGroup(e,s=""){if(e===Xe.SCENE_TYPE.OUTDOOR)return this.personGroup[e];{const n=s.slice(0,-3),r=this.personGroup[e][n];return r&&r[s]||null}}openDialog(e){}setDialogVisible(e){}closeDialog(){}setAlarmPerson(e){this.personDangerData=e}searchAlarmPerson(){this.personAlarm.setAlarm(this.personDangerData),this.core.scene._add(this.personAlarm.object3d),this.core.tweenControl.lerpTo(this.personAlarm.person.position,50,1e3,new M(0,10,0))}clearAlarmPerson(){this.personAlarm.clearAlarm(),this.personDangerData=null}}let Lo=3;const ef={S:80,M:160,L:240,XL:320,XXL:400};var us,ki,qa,zi,Wa;class tf extends vs{constructor(e){super();z(this,ki);z(this,zi);z(this,us,!1);O(this,"pullFromCluster",e=>{e.isSingle=!0;const s=e.clusterId;if(!this.clusterMap.has(s))return;const n=this.clusterMap.get(s);for(let r=0;r<n.length;r++)if(n[r].id===e.id){n.splice(r,1);break}return this.singleData.push(e),e});O(this,"pushToCluster",e=>{e.isSingle=!1;const s=Y(this,zi,Wa).call(this,e.position,ef[this.level]/Math.sqrt(Lo));let n=[];this.clusterMap.has(s)?n=this.clusterMap.get(s):this.clusterMap.set(s,n),n.push(e),e.clusterId=s;for(let r=0;r<this.singleData.length;r++)if(this.singleData[r]===e){this.singleData.splice(r,1);break}return e.object3d.traverse(r=>{r.element&&(r.element.style.display="none")}),e});this.order=1,this.level="X",this.nearestDistance=100,this.orientation=e,this.orientation.addUpdatable(this),this.core=e.core,this.clusterMap=new Map,this.singleData=[],this.core.controls.addEventListener("change",s=>{this.onCameraChange(this.core.camera),this.update(this.orientation),this.orientation.orientation3D.update(this.orientation)})}get isActive(){return P(this,us)}setActive(e){K(this,us,e),this.orientation.updateModules()}setLevel(e){Lo=e,this.orientation.updateModules()}update(e){this.clear();const{sceneType:s,originId:n}=this.core.getCurrentOriginId(),r=e.getCurrentSceneData(s,n);if(P(this,us)){let o=[];r.forEach(a=>{a.isSingle?this.singleData.push(a):o.push(a)}),Y(this,ki,qa).call(this,o)}else this.singleData=r;this.onCameraChange(this.core.camera)}onCameraChange(e){const s=e.position,n=s.y;let r;n<30?r="S":n<60?r="M":n<120?r="L":n<240?r="XL":r="XXL",this.level=r,this.clusterMap.forEach(a=>{s.distanceTo(a.position)<this.nearestDistance&&this.disperseClusterOnEvent(a)})}disperseClusterOnEvent(e){this.singleData.push(...e),e.length=0,e.position.set(0,0,0)}clear(){this.clusterMap.forEach(e=>{e.forEach(s=>s.clusterId=void 0)}),this.clusterMap.clear(),this.singleData=[]}}us=new WeakMap,ki=new WeakSet,qa=function(e){e.forEach(this.pushToCluster),this.clusterMap.forEach(s=>{const n=new M;s.position=n,s.forEach(r=>n.add(r.position)),n.divideScalar(s.length)})},zi=new WeakSet,Wa=function(e,s){const n=o(e.x),r=o(e.z);function o(a){let l=parseInt(a/s),c=a%s;return c<0&&(c=-1),c>0&&(c=1),l+=c,l}return`${n}_${r}`};const rt=11102230246251565e-32,me=134217729,sf=(3+8*rt)*rt;function Bn(i,t,e,s,n){let r,o,a,l,c=t[0],h=s[0],u=0,d=0;h>c==h>-c?(r=c,c=t[++u]):(r=h,h=s[++d]);let f=0;if(u<i&&d<e)for(h>c==h>-c?(o=c+r,a=r-(o-c),c=t[++u]):(o=h+r,a=r-(o-h),h=s[++d]),r=o,a!==0&&(n[f++]=a);u<i&&d<e;)h>c==h>-c?(o=r+c,l=o-r,a=r-(o-l)+(c-l),c=t[++u]):(o=r+h,l=o-r,a=r-(o-l)+(h-l),h=s[++d]),r=o,a!==0&&(n[f++]=a);for(;u<i;)o=r+c,l=o-r,a=r-(o-l)+(c-l),c=t[++u],r=o,a!==0&&(n[f++]=a);for(;d<e;)o=r+h,l=o-r,a=r-(o-l)+(h-l),h=s[++d],r=o,a!==0&&(n[f++]=a);return(r!==0||f===0)&&(n[f++]=r),f}function nf(i,t){let e=t[0];for(let s=1;s<i;s++)e+=t[s];return e}function qs(i){return new Float64Array(i)}const rf=(3+16*rt)*rt,of=(2+12*rt)*rt,af=(9+64*rt)*rt*rt,ss=qs(4),Do=qs(8),Bo=qs(12),Io=qs(16),be=qs(4);function lf(i,t,e,s,n,r,o){let a,l,c,h,u,d,f,g,v,p,m,y,x,b,w,E,T,A;const C=i-n,R=e-n,L=t-r,_=s-r;b=C*_,d=me*C,f=d-(d-C),g=C-f,d=me*_,v=d-(d-_),p=_-v,w=g*p-(b-f*v-g*v-f*p),E=L*R,d=me*L,f=d-(d-L),g=L-f,d=me*R,v=d-(d-R),p=R-v,T=g*p-(E-f*v-g*v-f*p),m=w-T,u=w-m,ss[0]=w-(m+u)+(u-T),y=b+m,u=y-b,x=b-(y-u)+(m-u),m=x-E,u=x-m,ss[1]=x-(m+u)+(u-E),A=y+m,u=A-y,ss[2]=y-(A-u)+(m-u),ss[3]=A;let D=nf(4,ss),B=of*o;if(D>=B||-D>=B||(u=i-C,a=i-(C+u)+(u-n),u=e-R,c=e-(R+u)+(u-n),u=t-L,l=t-(L+u)+(u-r),u=s-_,h=s-(_+u)+(u-r),a===0&&l===0&&c===0&&h===0)||(B=af*o+sf*Math.abs(D),D+=C*h+_*a-(L*c+R*l),D>=B||-D>=B))return D;b=a*_,d=me*a,f=d-(d-a),g=a-f,d=me*_,v=d-(d-_),p=_-v,w=g*p-(b-f*v-g*v-f*p),E=l*R,d=me*l,f=d-(d-l),g=l-f,d=me*R,v=d-(d-R),p=R-v,T=g*p-(E-f*v-g*v-f*p),m=w-T,u=w-m,be[0]=w-(m+u)+(u-T),y=b+m,u=y-b,x=b-(y-u)+(m-u),m=x-E,u=x-m,be[1]=x-(m+u)+(u-E),A=y+m,u=A-y,be[2]=y-(A-u)+(m-u),be[3]=A;const N=Bn(4,ss,4,be,Do);b=C*h,d=me*C,f=d-(d-C),g=C-f,d=me*h,v=d-(d-h),p=h-v,w=g*p-(b-f*v-g*v-f*p),E=L*c,d=me*L,f=d-(d-L),g=L-f,d=me*c,v=d-(d-c),p=c-v,T=g*p-(E-f*v-g*v-f*p),m=w-T,u=w-m,be[0]=w-(m+u)+(u-T),y=b+m,u=y-b,x=b-(y-u)+(m-u),m=x-E,u=x-m,be[1]=x-(m+u)+(u-E),A=y+m,u=A-y,be[2]=y-(A-u)+(m-u),be[3]=A;const H=Bn(N,Do,4,be,Bo);b=a*h,d=me*a,f=d-(d-a),g=a-f,d=me*h,v=d-(d-h),p=h-v,w=g*p-(b-f*v-g*v-f*p),E=l*c,d=me*l,f=d-(d-l),g=l-f,d=me*c,v=d-(d-c),p=c-v,T=g*p-(E-f*v-g*v-f*p),m=w-T,u=w-m,be[0]=w-(m+u)+(u-T),y=b+m,u=y-b,x=b-(y-u)+(m-u),m=x-E,u=x-m,be[1]=x-(m+u)+(u-E),A=y+m,u=A-y,be[2]=y-(A-u)+(m-u),be[3]=A;const J=Bn(H,Bo,4,be,Io);return Io[J-1]}function cf(i,t,e,s,n,r){const o=(t-r)*(e-n),a=(i-n)*(s-r),l=o-a,c=Math.abs(o+a);return Math.abs(l)>=rf*c?l:-lf(i,t,e,s,n,r,c)}function uf(i,t){var e,s,n=0,r,o,a,l,c,h,u,d=i[0],f=i[1],g=t.length;for(e=0;e<g;e++){s=0;var v=t[e],p=v.length-1;if(h=v[0],h[0]!==v[p][0]&&h[1]!==v[p][1])throw new Error("First and last coordinates in a ring must be the same");for(o=h[0]-d,a=h[1]-f,s;s<p;s++){if(u=v[s+1],l=u[0]-d,c=u[1]-f,a===0&&c===0){if(l<=0&&o>=0||o<=0&&l>=0)return 0}else if(c>=0&&a<=0||c<=0&&a>=0){if(r=cf(o,l,a,c,0,0),r===0)return 0;(r>0&&c>0&&a<=0||r<0&&c<=0&&a>0)&&n++}h=u,a=c,o=l}}return n%2!==0}const Oo=new le,pi=new M;class Ka extends Gl{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const t=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],e=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],s=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(s),this.setAttribute("position",new kr(t,3)),this.setAttribute("uv",new kr(e,2))}applyMatrix4(t){const e=this.attributes.instanceStart,s=this.attributes.instanceEnd;return e!==void 0&&(e.applyMatrix4(t),s.applyMatrix4(t),e.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(t){let e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));const s=new Wn(e,6,1);return this.setAttribute("instanceStart",new Bt(s,3,0)),this.setAttribute("instanceEnd",new Bt(s,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){let e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));const s=new Wn(e,6,1);return this.setAttribute("instanceColorStart",new Bt(s,3,0)),this.setAttribute("instanceColorEnd",new Bt(s,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new jl(t.geometry)),this}fromLineSegments(t){const e=t.geometry;return this.setPositions(e.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new le);const t=this.attributes.instanceStart,e=this.attributes.instanceEnd;t!==void 0&&e!==void 0&&(this.boundingBox.setFromBufferAttribute(t),Oo.setFromBufferAttribute(e),this.boundingBox.union(Oo))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new Ct),this.boundingBox===null&&this.computeBoundingBox();const t=this.attributes.instanceStart,e=this.attributes.instanceEnd;if(t!==void 0&&e!==void 0){const s=this.boundingSphere.center;this.boundingBox.getCenter(s);let n=0;for(let r=0,o=t.count;r<o;r++)pi.fromBufferAttribute(t,r),n=Math.max(n,s.distanceToSquared(pi)),pi.fromBufferAttribute(e,r),n=Math.max(n,s.distanceToSquared(pi));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(t){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(t)}}vi.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new F(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}};yi.line={uniforms:ya.merge([vi.common,vi.fog,vi.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>
		#include <clipping_planes_pars_vertex>

		uniform float linewidth;
		uniform vec2 resolution;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
				vUv = uv;

			#endif

			float aspect = resolution.x / resolution.y;

			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			#ifdef WORLD_UNITS

				worldStart = start.xyz;
				worldEnd = end.xyz;

			#else

				vUv = uv;

			#endif

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec3 ndcStart = clipStart.xyz / clipStart.w;
			vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

			// direction
			vec2 dir = ndcEnd.xy - ndcStart.xy;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			dir = normalize( dir );

			#ifdef WORLD_UNITS

				vec3 worldDir = normalize( end.xyz - start.xyz );
				vec3 tmpFwd = normalize( mix( start.xyz, end.xyz, 0.5 ) );
				vec3 worldUp = normalize( cross( worldDir, tmpFwd ) );
				vec3 worldFwd = cross( worldDir, worldUp );
				worldPos = position.y < 0.5 ? start: end;

				// height offset
				float hw = linewidth * 0.5;
				worldPos.xyz += position.x < 0.0 ? hw * worldUp : - hw * worldUp;

				// don't extend the line if we're rendering dashes because we
				// won't be rendering the endcaps
				#ifndef USE_DASH

					// cap extension
					worldPos.xyz += position.y < 0.5 ? - hw * worldDir : hw * worldDir;

					// add width to the box
					worldPos.xyz += worldFwd * hw;

					// endcaps
					if ( position.y > 1.0 || position.y < 0.0 ) {

						worldPos.xyz -= worldFwd * 2.0 * hw;

					}

				#endif

				// project the worldpos
				vec4 clip = projectionMatrix * worldPos;

				// shift the depth of the projected points so the line
				// segments overlap neatly
				vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
				clip.z = clipPose.z * clip.w;

			#else

				vec2 offset = vec2( dir.y, - dir.x );
				// undo aspect ratio adjustment
				dir.x /= aspect;
				offset.x /= aspect;

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				// endcaps
				if ( position.y < 0.0 ) {

					offset += - dir;

				} else if ( position.y > 1.0 ) {

					offset += dir;

				}

				// adjust for linewidth
				offset *= linewidth;

				// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
				offset /= resolution.y;

				// select end
				vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

				// back to clip space
				offset *= clip.w;

				clip.xy += offset;

			#endif

			gl_Position = clip;

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

			#include <logdepthbuf_vertex>
			#include <clipping_planes_vertex>
			#include <fog_vertex>

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform float linewidth;

		#ifdef USE_DASH

			uniform float dashOffset;
			uniform float dashSize;
			uniform float gapSize;

		#endif

		varying float vLineDistance;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#include <common>
		#include <color_pars_fragment>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>
		#include <clipping_planes_pars_fragment>

		vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

			float mua;
			float mub;

			vec3 p13 = p1 - p3;
			vec3 p43 = p4 - p3;

			vec3 p21 = p2 - p1;

			float d1343 = dot( p13, p43 );
			float d4321 = dot( p43, p21 );
			float d1321 = dot( p13, p21 );
			float d4343 = dot( p43, p43 );
			float d2121 = dot( p21, p21 );

			float denom = d2121 * d4343 - d4321 * d4321;

			float numer = d1343 * d4321 - d1321 * d4343;

			mua = numer / denom;
			mua = clamp( mua, 0.0, 1.0 );
			mub = ( d1343 + d4321 * ( mua ) ) / d4343;
			mub = clamp( mub, 0.0, 1.0 );

			return vec2( mua, mub );

		}

		void main() {

			#include <clipping_planes_fragment>

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			float alpha = opacity;

			#ifdef WORLD_UNITS

				// Find the closest points on the view ray and the line segment
				vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
				vec3 lineDir = worldEnd - worldStart;
				vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

				vec3 p1 = worldStart + lineDir * params.x;
				vec3 p2 = rayEnd * params.y;
				vec3 delta = p1 - p2;
				float len = length( delta );
				float norm = len / linewidth;

				#ifndef USE_DASH

					#ifdef USE_ALPHA_TO_COVERAGE

						float dnorm = fwidth( norm );
						alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

					#else

						if ( norm > 0.5 ) {

							discard;

						}

					#endif

				#endif

			#else

				#ifdef USE_ALPHA_TO_COVERAGE

					// artifacts appear on some hardware if a derivative is taken within a conditional
					float a = vUv.x;
					float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
					float len2 = a * a + b * b;
					float dlen = fwidth( len2 );

					if ( abs( vUv.y ) > 1.0 ) {

						alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

					}

				#else

					if ( abs( vUv.y ) > 1.0 ) {

						float a = vUv.x;
						float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
						float len2 = a * a + b * b;

						if ( len2 > 1.0 ) discard;

					}

				#endif

			#endif

			vec4 diffuseColor = vec4( diffuse, alpha );

			#include <logdepthbuf_fragment>
			#include <color_fragment>

			gl_FragColor = vec4( diffuseColor.rgb, alpha );

			#include <tonemapping_fragment>
			#include <colorspace_fragment>
			#include <fog_fragment>
			#include <premultiplied_alpha_fragment>

		}
		`};class an extends Ee{constructor(t){super({type:"LineMaterial",uniforms:ya.clone(yi.line.uniforms),vertexShader:yi.line.vertexShader,fragmentShader:yi.line.fragmentShader,clipping:!0}),this.isLineMaterial=!0,this.setValues(t)}get color(){return this.uniforms.diffuse.value}set color(t){this.uniforms.diffuse.value=t}get worldUnits(){return"WORLD_UNITS"in this.defines}set worldUnits(t){t===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}get linewidth(){return this.uniforms.linewidth.value}set linewidth(t){this.uniforms.linewidth&&(this.uniforms.linewidth.value=t)}get dashed(){return"USE_DASH"in this.defines}set dashed(t){t===!0!==this.dashed&&(this.needsUpdate=!0),t===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashScale(){return this.uniforms.dashScale.value}set dashScale(t){this.uniforms.dashScale.value=t}get dashSize(){return this.uniforms.dashSize.value}set dashSize(t){this.uniforms.dashSize.value=t}get dashOffset(){return this.uniforms.dashOffset.value}set dashOffset(t){this.uniforms.dashOffset.value=t}get gapSize(){return this.uniforms.gapSize.value}set gapSize(t){this.uniforms.gapSize.value=t}get opacity(){return this.uniforms.opacity.value}set opacity(t){this.uniforms&&(this.uniforms.opacity.value=t)}get resolution(){return this.uniforms.resolution.value}set resolution(t){this.uniforms.resolution.value.copy(t)}get alphaToCoverage(){return"USE_ALPHA_TO_COVERAGE"in this.defines}set alphaToCoverage(t){this.defines&&(t===!0!==this.alphaToCoverage&&(this.needsUpdate=!0),t===!0?this.defines.USE_ALPHA_TO_COVERAGE="":delete this.defines.USE_ALPHA_TO_COVERAGE)}}const Fo=new M,No=new M,ce=new At,ue=new At,je=new At,In=new M,On=new ie,he=new Ye,Uo=new M,mi=new le,gi=new Ct,Ve=new At;let We,Ut;function ko(i,t,e){return Ve.set(0,0,-t,1).applyMatrix4(i.projectionMatrix),Ve.multiplyScalar(1/Ve.w),Ve.x=Ut/e.width,Ve.y=Ut/e.height,Ve.applyMatrix4(i.projectionMatrixInverse),Ve.multiplyScalar(1/Ve.w),Math.abs(Math.max(Ve.x,Ve.y))}function hf(i,t){const e=i.matrixWorld,s=i.geometry,n=s.attributes.instanceStart,r=s.attributes.instanceEnd,o=Math.min(s.instanceCount,n.count);for(let a=0,l=o;a<l;a++){he.start.fromBufferAttribute(n,a),he.end.fromBufferAttribute(r,a),he.applyMatrix4(e);const c=new M,h=new M;We.distanceSqToSegment(he.start,he.end,h,c),h.distanceTo(c)<Ut*.5&&t.push({point:h,pointOnLine:c,distance:We.origin.distanceTo(h),object:i,face:null,faceIndex:a,uv:null,uv1:null})}}function df(i,t,e){const s=t.projectionMatrix,r=i.material.resolution,o=i.matrixWorld,a=i.geometry,l=a.attributes.instanceStart,c=a.attributes.instanceEnd,h=Math.min(a.instanceCount,l.count),u=-t.near;We.at(1,je),je.w=1,je.applyMatrix4(t.matrixWorldInverse),je.applyMatrix4(s),je.multiplyScalar(1/je.w),je.x*=r.x/2,je.y*=r.y/2,je.z=0,In.copy(je),On.multiplyMatrices(t.matrixWorldInverse,o);for(let d=0,f=h;d<f;d++){if(ce.fromBufferAttribute(l,d),ue.fromBufferAttribute(c,d),ce.w=1,ue.w=1,ce.applyMatrix4(On),ue.applyMatrix4(On),ce.z>u&&ue.z>u)continue;if(ce.z>u){const x=ce.z-ue.z,b=(ce.z-u)/x;ce.lerp(ue,b)}else if(ue.z>u){const x=ue.z-ce.z,b=(ue.z-u)/x;ue.lerp(ce,b)}ce.applyMatrix4(s),ue.applyMatrix4(s),ce.multiplyScalar(1/ce.w),ue.multiplyScalar(1/ue.w),ce.x*=r.x/2,ce.y*=r.y/2,ue.x*=r.x/2,ue.y*=r.y/2,he.start.copy(ce),he.start.z=0,he.end.copy(ue),he.end.z=0;const v=he.closestPointToPointParameter(In,!0);he.at(v,Uo);const p=ur.lerp(ce.z,ue.z,v),m=p>=-1&&p<=1,y=In.distanceTo(Uo)<Ut*.5;if(m&&y){he.start.fromBufferAttribute(l,d),he.end.fromBufferAttribute(c,d),he.start.applyMatrix4(o),he.end.applyMatrix4(o);const x=new M,b=new M;We.distanceSqToSegment(he.start,he.end,b,x),e.push({point:b,pointOnLine:x,distance:We.origin.distanceTo(b),object:i,face:null,faceIndex:d,uv:null,uv1:null})}}}class ff extends de{constructor(t=new Ka,e=new an({color:Math.random()*16777215})){super(t,e),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const t=this.geometry,e=t.attributes.instanceStart,s=t.attributes.instanceEnd,n=new Float32Array(2*e.count);for(let o=0,a=0,l=e.count;o<l;o++,a+=2)Fo.fromBufferAttribute(e,o),No.fromBufferAttribute(s,o),n[a]=a===0?0:n[a-1],n[a+1]=n[a]+Fo.distanceTo(No);const r=new Wn(n,2,1);return t.setAttribute("instanceDistanceStart",new Bt(r,1,0)),t.setAttribute("instanceDistanceEnd",new Bt(r,1,1)),this}raycast(t,e){const s=this.material.worldUnits,n=t.camera;n===null&&!s&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const r=t.params.Line2!==void 0&&t.params.Line2.threshold||0;We=t.ray;const o=this.matrixWorld,a=this.geometry,l=this.material;Ut=l.linewidth+r,a.boundingSphere===null&&a.computeBoundingSphere(),gi.copy(a.boundingSphere).applyMatrix4(o);let c;if(s)c=Ut*.5;else{const u=Math.max(n.near,gi.distanceToPoint(We.origin));c=ko(n,u,l.resolution)}if(gi.radius+=c,We.intersectsSphere(gi)===!1)return;a.boundingBox===null&&a.computeBoundingBox(),mi.copy(a.boundingBox).applyMatrix4(o);let h;if(s)h=Ut*.5;else{const u=Math.max(n.near,mi.distanceToPoint(We.origin));h=ko(n,u,l.resolution)}mi.expandByScalar(h),We.intersectsBox(mi)!==!1&&(s?hf(this,e):df(this,n,e))}}class Hs extends Ka{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(t){const e=t.length-3,s=new Float32Array(2*e);for(let n=0;n<e;n+=3)s[2*n]=t[n],s[2*n+1]=t[n+1],s[2*n+2]=t[n+2],s[2*n+3]=t[n+3],s[2*n+4]=t[n+4],s[2*n+5]=t[n+5];return super.setPositions(s),this}setColors(t){const e=t.length-3,s=new Float32Array(2*e);for(let n=0;n<e;n+=3)s[2*n]=t[n],s[2*n+1]=t[n+1],s[2*n+2]=t[n+2],s[2*n+3]=t[n+3],s[2*n+4]=t[n+4],s[2*n+5]=t[n+5];return super.setColors(s),this}fromLine(t){const e=t.geometry;return this.setPositions(e.attributes.position.array),this}}class ir extends ff{constructor(t=new Hs,e=new an({color:Math.random()*16777215})){super(t,e),this.isLine2=!0,this.type="Line2"}}const pf=new Hs,wi=new an({color:16711935,linewidth:4,depthTest:!1,transparent:!0});wi.resolution.set(window.innerWidth,window.innerHeight);var Be;class Sr{constructor(t){z(this,Be,void 0);O(this,"points");O(this,"line");O(this,"moveLine");O(this,"count");O(this,"needToAdhereToFirstPoint");O(this,"closestDistanceToAdhere");O(this,"needCheckLinesCross");O(this,"isClosed");O(this,"movePoint");this.scene=t,this.needToAdhereToFirstPoint=!0,this.needCheckLinesCross=!1,this.closestDistanceToAdhere=0,this.points=[],this.count=0,this.isClosed=!1,K(this,Be,!1),this.movePoint=new M,this._create(),this.moveLine.visible=!1,this.group=new Q,this.group.name="绘制组",this.group.add(this.line,this.moveLine),this.scene._add(this.group)}set active(t){P(this,Be)!==t&&(K(this,Be,t),t?this._create():this.end())}get active(){return P(this,Be)}addPoint(t){if(P(this,Be)){if(this.needCheckLinesCross&&Wd(xi(this.points,"x","z"),xi(t,"x","z"))){setTimeout(()=>{alert("相交了,操作无效")},0),console.log("相交了,操作无效");return}this.needToAdhereToFirstPoint&&this.count>1&&t.equals(this.points[0])&&(this.isClosed=!0),this.points.push(t),this.count++,this.updateLine(),this.updateMoveLine(t),this.line.parent||this.group.add(this.line,this.moveLine)}}end(){this.moveLine.deleteSelf()}deletePoint(){P(this,Be)&&this.points.length&&(this.points.pop(),this.count--,this.updateLine(),this.updateMoveLine())}_create(){this.line=new ir(void 0,wi),this.moveLine=new ir(new Hs().setPositions([0,0,0,0,0,0]),wi)}getLength(t=2){return parseFloat(Po(this.points).toFixed(t))}getTotalLength(t=2){return parseFloat(Po([...this.points,this.movePoint]).toFixed(t))}getArea(t=2){return this.isClosed?parseFloat(Vd(xi(this.points,"x","z")).toFixed(t)):0}getCenter(t=new M){const e=t;return this.points.forEach(s=>{e.addScaledVector(s,1/this.points.length)}),e}onresize(t,e){wi.resolution.set(t,e)}updateMoveLine(t){if(P(this,Be))if(this.count){const{x:e,y:s,z:n}=this.points[this.count-1];if(t===void 0){const r=this.moveLine.geometry.attributes.instanceStart.data.array;this.moveLine.geometry.setPositions([e,s,n,r[3],r[4],r[5]])}else{if(this.movePoint.copy(t),this.needToAdhereToFirstPoint){const r=this.points[0];t.distanceTo(r)<this.closestDistanceToAdhere&&t.copy(r)}this.moveLine.geometry.setPositions([e,s,n,t.x,t.y,t.z]),this.moveLine.visible=!0}}else this.moveLine.visible=!1}updateLine(){if(P(this,Be))if(this.line.geometry.dispose(),this.count>=2){const t=new Hs().setPositions(Kd(this.points));this.line.geometry=t}else this.line.geometry=pf}dispose(){this.line&&this.line.deleteSelf(),this.moveLine&&this.moveLine.deleteSelf(),this.line=null,this.moveLine=null,this.count=0,this.points.length=0,this.isClosed=!1,K(this,Be,!1)}}Be=new WeakMap;const zo=new F,Ho=new F;class mf extends vs{constructor(e){super();O(this,"onmousedown",e=>{this.getMouse(e,zo)});O(this,"onmouseup",e=>{if(this.getMouse(e,Ho),!!zo.equals(Ho)&&this.hitPoint&&(this.helper.addPoint(this.hitPoint),this.label&&(this.label.visible=this.helper.count!==0),this.helper.isClosed)){this.removeListener(),this.createLabel(),this.setLabelPosition(this.helper.getCenter()),this.core.enableControlsRotate(!0);let s=[];this.helper.points.forEach(n=>{s.push([n.x,n.z])}),this.polygon=[s],this.selectInsideObj(),this.orientation.updateModules()}});O(this,"hasObj",e=>uf(e,this.polygon));O(this,"selectInsideObj",()=>{let e={person:[],camera:[],buildings:[]},s=q.equip.camera,n=[];this.orientation.getCurrentSceneData().forEach(o=>{o.object3d.visible&&n.push(o)});let r=this.subsystem.buildingNameLabelMap;Object.entries(s).forEach(([o,a])=>{let l=[a.position.x,a.position.z];this.hasObj(l)&&(e.camera.includes(o)||e.camera.push(o))}),n.forEach(o=>{let a=[o.position.x,o.position.z];this.hasObj(a)&&(e.person.includes(o.id)||(e.person.push(o.id),this.orientation.clusterModule.pullFromCluster(o)))}),Object.entries(r).forEach(([o,a])=>{let l=[a.position.x,a.position.z];this.hasObj(l)&&(e.buildings.includes(o)||e.buildings.push(o))}),window.parent.postMessage({cmd:"selectBack",param:e},"*")});O(this,"onkeyup",e=>{e.key==="Escape"&&(this.helper.deletePoint(),this.label.visible=this.helper.count!==0,this.updateLabel())});O(this,"getMouse",(e,s)=>{const{left:n,top:r,width:o,height:a}=this.core.domElement.getBoundingClientRect();s.x=(e.clientX-n)/o*2-1,s.y=-((e.clientY-r)/a)*2+1});O(this,"raycastOnmousemove",e=>{e.length?(this.hitPoint=e[0].point,this.helper.updateMoveLine(this.hitPoint)):this.hitPoint=null});this.core=null,this.scene=null,this.subsystem=null,this.order=2,this.raycastObject=null,this.hitPoint=null,this.orientation=e,this.orientation.addUpdatable(this)}onLoad(e){this.core=e.core,this.scene=e.scene,this.subsystem=e,this.helper=new Sr(this.scene),this.helper.needToAdhereToFirstPoint=!0,this.helper.closestDistanceToAdhere=10,this.helper.needCheckLinesCross=!0}setRaycastObject(e){this.raycastObject=e}start(){this.helper.active=!0,this.mousedownControls=this.core.addEventListener("mousedown"),this.mouseupControls=this.core.addEventListener("mouseup"),this.keyupControls=this.core.addEventListener("keyup"),this.mousedownControls.add(this.onmousedown),this.mouseupControls.add(this.onmouseup),this.keyupControls.add(this.onkeyup),this.raycastControls=this.core.raycast("mousemove",this.raycastObject,this.raycastOnmousemove)}removeListener(){this.helper.active===!0&&(this.helper.active=!1,this.mousedownControls.clear(),this.mouseupControls.clear(),this.keyupControls.clear(),this.raycastControls.clear())}end(){this.removeListener(),this.helper.dispose(),this.label&&this.label.deleteSelf(),this.label=null}createLabel(){const e=$e({innerText:"精确监控",className:"beiLuBoxSelect"});this.label=Ce(e)}updateLabel(){this.label.element&&this.setLabelPosition(this.hitPoint)}setLabelPosition(e,s=10){this.label.position.set(e.x,e.y+s,e.z)}update(e){this.helper.isClosed&&this.selectInsideObj()}}class gf extends vs{constructor(e){super();O(this,"updateVisible",e=>{const s=this.rules;if(!s)return;const n=s[e.typeName];e.object3d.traverse(r=>{r.visible=n,r.isPass=!n}),e.id!==this.orientation.searchId&&e.id!==this.orientation.followId&&(e.isSingle=!n),e.isPass=!n});this.order=0,this.orientation=e,this.rules=null,e.addUpdatable(this)}filter(e){this.rules=e}update(){if(!this.rules)return;this.orientation.map.forEach(this.updateVisible)}}var Hi,Xa;class vf extends de{constructor(e,s){super();z(this,Hi);const n=this.createHeatmap(e,s);this.geometry=n.geometry,this.material=n.material}createHeatmap(e,s){const{width:n,height:r}=Y(this,Hi,Xa).call(this,e,s.radius);this.initData(e,n,r);const o=s.container;o.style.width=`${n*2}px`,o.style.height=`${r*2}px`,document.body.appendChild(o);var a=h337.create(s);a.setData({max:2,data:e});const l=new Vl(a._config.container.children[0]);l.needUpdate=!0;const c=new fa(n*2,r*2,500,500);c.applyMatrix4(new ie().makeRotationX(-Math.PI/2));const h=new Ee({transparent:!0,depthTest:!1,uniforms:{heatmap:{value:l}},vertexShader:`
      uniform sampler2D heatmap;
      varying vec2 vUv;
      varying vec4 heatTexture;

      void main() {
          vUv = uv;
          heatTexture = texture2D(heatmap,vUv);
          vec3 pos = position;
          pos.y = heatTexture.r * 10.0;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(pos,1.0);
      }
      `,fragmentShader:`
      uniform sampler2D heatmap;
      varying vec2 vUv;
      varying vec4 heatTexture;
      void main() {
          vec4 color = heatTexture;
          gl_FragColor = color;
      }
      `});return document.body.removeChild(o),new de(c,h)}createHeightMap(e){}initData(e,s,n){for(let r=0;r<e.length;r++)e[r].x=e[r].x+s,e[r].y=e[r].y+n}}Hi=new WeakSet,Xa=function(e,s){let n=-1/0,r=-1/0;for(let o=0;o<e.length;o++){const{x:a,y:l}=e[o];n=Math.max(n,Math.abs(a)),r=Math.max(r,Math.abs(l))}return{width:n+s,height:r+s}};var Gi,Ya,ji,$a;class yf extends vs{constructor(e){super();z(this,Gi);z(this,ji);this.orientation=e}update(e){const s=e.getCurrentSceneData();this.dispose(),s.length!==0&&(Y(this,Gi,Ya).call(this,s),e.core.scene.add(this.heatmap))}openHeatmap(){this.orientation.addUpdatable(this),this.update(this.orientation)}clearHeatmap(){this.dispose(),this.orientation.removeUpdatable(this)}dispose(){this.heatmap&&this.heatmap.deleteSelf()}}Gi=new WeakSet,Ya=function(e){this.heatmap=new vf(Y(this,ji,$a).call(this,e),{container:document.createElement("div"),maxOpacity:1,radius:5,blur:1,backgroundColor:"rgba(0, 255, 255, 1)"}),this.heatmap.name="heatmap"},ji=new WeakSet,$a=function(e){const s=[];for(let n=0;n<e.length;n++){const r=e[n].position;s.push({x:Math.floor(r.x),y:Math.floor(r.z),value:1})}return s};class bf extends vs{constructor(t){super(),this.id=null,this.orientation=t,this.core=t.core,t.addUpdatable(this)}search(){const t=this.orientation;if(!t.has(this.id))return;const e=t.get(this.id);e.isSingle=!0,t.clusterModule.pullFromCluster(e),e.object3d.traverse(s=>{s.visible=!0}),this.core.controls.enablePan=!1,this.update(t),this.setSearchIcon("big",e)}setSearchIcon(t,e){if(!t)return!1;let s=.03,n="translate(0, -200%) scale(0.75)";t==="big"&&(s=.05,n="translate(0, -320%) scale(1.2)"),e.object3d.traverse(r=>{if(r.isSprite&&r.scale.set(s,s,s),r.isCSS2DObject&&r.classTypeName){let a=r.element.childNodes[0];a.style.transform=n}})}setPosition(){const t=this.id,s=this.orientation.get(t).position;this.core.tweenControl.lerpTo(s,50,1e3)}clearSearch(){const t=this.id;if(!t)return;const e=this.orientation;if(!e.has(t))return;const s=e.get(t);s.isSingle=!1,this.core.controls.enablePan=!0,this.id=null,e.updateModules(),this.setSearchIcon("small",s)}update(t){if(this.id&&!this.orientation.followId){let e=this.orientation.get(this.id);const{originId:s,sceneType:n}=e,{sceneType:r,originId:o}=this.core.getCurrentOriginId();if(n!==r||n===0&&s!==o)return!1}}}const Si={0:"externalPerson",1:"insidePerson",2:"laborPerson",externalPerson:0,insidePerson:1,laborPerson:2};var Vi,Za,qi,Qa,js,nr,Wi,Ja,Ki,el,Vs,rr,Xi,tl;const st=class st{constructor(t){z(this,Vi);z(this,qi);z(this,js);z(this,Wi);z(this,Ki);z(this,Vs);z(this,Xi);this.core=t,this.map=new Map,this.updateMap=new Map,this.updatable=[],this.sceneData={[st.SCENE_TYPE.INDOOR]:{},[st.SCENE_TYPE.OUTDOOR]:[]},this.clusterModule=new tf(this),this.boxSelect=new mf(this),this.personSearchModule=new bf(this),this.personFilter=new gf(this),this.orientation3D=new Jd(this),this.heatmapModule=new yf(this)}get searchId(){return this.personSearchModule.id}set searchId(t){this.has(t)&&(this.personSearchModule.id=t)}init(t){const{add:e,remove:s,update:n}=t;e.forEach(r=>Y(this,js,nr).call(this,r)),s.forEach(r=>Y(this,Ki,el).call(this,r)),n.forEach(r=>Y(this,Wi,Ja).call(this,r)),this.getBuildingDataCount(),this.updateModules()}getBuildingDataCount(){const t=this.sceneData[st.SCENE_TYPE.INDOOR];Reflect.ownKeys(t).forEach(s=>{let n=0;const r=t[s];Reflect.ownKeys(r).forEach(a=>{const l=r[a];n+=l.length})})}has(t){return this.map.has(t)}get(t){return this.map.get(t)}filterByRule(t){this.personFilter.filter(t),this.clearSearch(),this.updateModules()}getCurrentSceneData(t,e=""){if(!t&&!e){const s=this.core.getCurrentOriginId();t=s.sceneType,e=s.originId}if(t===st.SCENE_TYPE.OUTDOOR)return this.sceneData[t];{let s;e.indexOf("F")!==-1?s=e.slice(0,-3):s=e;const n=this.sceneData[t][s];return n?n[e]||[]:[]}}setSearchId(t){this.searchId=t,Fd(t)}setFollowId(t){this.followId=t}search(){this.personSearchModule.search()}clearSearch(){this.personSearchModule.clearSearch()}setHeatmap(t){t?this.heatmapModule.openHeatmap():this.heatmapModule.clearHeatmap()}addUpdatable(t){this.updatable.indexOf(t)===-1&&this.updatable.push(t)}removeUpdatable(t){const e=this.updatable.indexOf(t);e!==-1&&this.updatable.splice(e,1)}updateModules(){this.updatable.sort((t,e)=>t.order-e.order),this.updatable.forEach(t=>t.update(this))}};Vi=new WeakSet,Za=function(t,e){this.map.set(t,e)},qi=new WeakSet,Qa=function(t){this.map.delete(t)},js=new WeakSet,nr=function(t,e){if(Y(this,Xi,tl).call(this,t,e),Y(this,Vi,Za).call(this,t.id,t),t.sceneType===st.SCENE_TYPE.INDOOR){const s=this.sceneData[st.SCENE_TYPE.INDOOR];let n;t.originId.indexOf("F")!==-1?n=t.originId.slice(0,-3):n=t.originId,s[n]||(s[n]={}),s[n][t.originId]||(s[n][t.originId]=[]),s[n][t.originId].push(t)}else this.sceneData[t.sceneType].push(t);t.id===this.followId&&(t.isSingle=!0),t.id===this.searchId&&(t.isSingle=!0),this.orientation3D.add(t)},Wi=new WeakSet,Ja=function(t){const e=this.get(t.id);if(!e)return;const s=e.originId!=t.originId;Y(this,Vs,rr).call(this,e),Y(this,js,nr).call(this,t,s),this.orientation3D.updateData(t)},Ki=new WeakSet,el=function(t){if(!this.has(t.id))return;let e=t.id;this.searchId===e&&(this.clearSearch(e),ja()),this.followId===e&&this.cancelFollow(e),Y(this,Vs,rr).call(this,t)},Vs=new WeakSet,rr=function(t){this.orientation3D.delete(t),Y(this,qi,Qa).call(this,t.id);const{sceneType:e,originId:s}=t;let n=this.getCurrentSceneData(e,s);for(let r=0;r<n.length;r++)if(t.id===n[r].id){n.splice(r,1);break}},Xi=new WeakSet,tl=function(t,e){const{coordinate:s,sceneType:n,type:r,originId:o}=t;t.position=en({coordinate:s,originId:o,sceneType:n}),t.buildingId=o.slice(0,-3),t.typeName=Si[r],t.object3d=this.orientation3D.create(t,e)},O(st,"SCENE_TYPE",{INDOOR:0,OUTDOOR:1});let Xe=st;class sl extends Dd{constructor(t){super(t),this.orientation=t.orientation,this.core=t}clearPerson(){this.orientation.orientation3D.disposeClusterGroup()}startFollowPerson(t){this.orientation.setFollowId(t),this.orientation.startFollow()}processingEquipData(t,e){q.dataProcess(t,e).then(s=>{e==="camera"&&q.searchCameraIdNeed&&(q.searchEquip(q.searchCameraIdNeed,"camera"),q.searchCameraIdNeed=null),e==="inspectionSystem"&&q.searchInspectionSystemNeed&&(q.searchEquip(q.searchInspectionSystemNeed,"inspectionSystem"),q.searchInspectionSystemNeed=null)})}hideInspectionSystemIcon(t){q.hideInspectionSystemIcon(t)}searchPerson(t){this.orientation.search(t)}cancelFollowPerson(){this.orientation.cancelFollow()}clearSelected(){this.orientation.followId&&this.orientation.cancelFollow(),this.orientation.searchId&&this.orientation.clearSearch()}clearCameraVideo(t){q.closeCameraDialog(t),q.cherryPick()}cherryPick(t){const e={[Si[0]]:!1,[Si[1]]:!1,[Si[2]]:!1};t.forEach(s=>{e[s]=!0}),q.setCherryArray(t),this.orientation.filterByRule(e),q.cherryPick(t),Zs.ground.meetingPoint.setCherryArray(t),Zs.ground.meetingPoint.cherryPick(),Zs.ground.escapeRoute.setCherryArray(t),Zs.ground.escapeRoute.cherryPick(),this.core.ground.setFilterBuilding(t),this.core.ground.filterBuildingNum()}setSearchInspection(t){q.setSearchInspection(t)}setFollowPersonIdNeed(t){}searchCamera(t){q.searchEquip(t,"camera")}searchInspectionSystem(t){q.searchEquip(t,"inspectionSystem")}searchInspection(){const t=q.searchInspection;q.dataProcess([t],"inspection"),q.searchEquip(t.id,"inspection"),q.searchInspection=null}getSearchPersonId(){return this.orientation.searchPersonId}getSearchEquipId(){return q.searchCameraId}setSearchCameraId(t){q.searchCameraIdNeed=t}setSearchInspectionSystemId(t){q.searchInspectionSystemNeed=t}setDangerPerson(t){this.orientation.orientation3D.setAlarmPerson(t)}searchAlarmPerson(){this.orientation.orientation3D.searchAlarmPerson()}clearDangerPerson(){this.orientation.orientation3D.clearAlarmPerson()}clearEquipType(t){q.clearEquipType(t)}hideCameraById(t){q.hideCameraById(t)}}function Go(i,t){if(t===ql)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),i;if(t===Kn||t===ba){let e=i.getIndex();if(e===null){const o=[],a=i.getAttribute("position");if(a!==void 0){for(let l=0;l<a.count;l++)o.push(l);i.setIndex(o),e=i.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),i}const s=e.count-2,n=[];if(t===Kn)for(let o=1;o<=s;o++)n.push(e.getX(0)),n.push(e.getX(o)),n.push(e.getX(o+1));else for(let o=0;o<s;o++)o%2===0?(n.push(e.getX(o)),n.push(e.getX(o+1)),n.push(e.getX(o+2))):(n.push(e.getX(o+2)),n.push(e.getX(o+1)),n.push(e.getX(o)));n.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=i.clone();return r.setIndex(n),r.clearGroups(),r}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),i}class xf extends Wl{constructor(t){super(t),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new Jf(e)}),this.register(function(e){return new Af(e)}),this.register(function(e){return new Bf(e)}),this.register(function(e){return new If(e)}),this.register(function(e){return new Of(e)}),this.register(function(e){return new Cf(e)}),this.register(function(e){return new _f(e)}),this.register(function(e){return new Pf(e)}),this.register(function(e){return new Rf(e)}),this.register(function(e){return new Ef(e)}),this.register(function(e){return new Lf(e)}),this.register(function(e){return new Mf(e)}),this.register(function(e){return new Df(e)}),this.register(function(e){return new Sf(e)}),this.register(function(e){return new Ff(e)}),this.register(function(e){return new Nf(e)})}load(t,e,s,n){const r=this;let o;this.resourcePath!==""?o=this.resourcePath:this.path!==""?o=this.path:o=Xn.extractUrlBase(t),this.manager.itemStart(t);const a=function(c){n?n(c):console.error(c),r.manager.itemError(t),r.manager.itemEnd(t)},l=new xa(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(t,function(c){try{r.parse(c,o,function(h){e(h),r.manager.itemEnd(t)},a)}catch(h){a(h)}},s,a)}setDRACOLoader(t){return this.dracoLoader=t,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(t){return this.ktx2Loader=t,this}setMeshoptDecoder(t){return this.meshoptDecoder=t,this}register(t){return this.pluginCallbacks.indexOf(t)===-1&&this.pluginCallbacks.push(t),this}unregister(t){return this.pluginCallbacks.indexOf(t)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this}parse(t,e,s,n){let r;const o={},a={},l=new TextDecoder;if(typeof t=="string")r=JSON.parse(t);else if(t instanceof ArrayBuffer)if(l.decode(new Uint8Array(t,0,4))===il){try{o[V.KHR_BINARY_GLTF]=new Uf(t)}catch(u){n&&n(u);return}r=JSON.parse(o[V.KHR_BINARY_GLTF].content)}else r=JSON.parse(l.decode(t));else r=t;if(r.asset===void 0||r.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new Zf(r,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const u=this.pluginCallbacks[h](c);u.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[u.name]=u,o[u.name]=!0}if(r.extensionsUsed)for(let h=0;h<r.extensionsUsed.length;++h){const u=r.extensionsUsed[h],d=r.extensionsRequired||[];switch(u){case V.KHR_MATERIALS_UNLIT:o[u]=new Tf;break;case V.KHR_DRACO_MESH_COMPRESSION:o[u]=new kf(r,this.dracoLoader);break;case V.KHR_TEXTURE_TRANSFORM:o[u]=new zf;break;case V.KHR_MESH_QUANTIZATION:o[u]=new Hf;break;default:d.indexOf(u)>=0&&a[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}c.setExtensions(o),c.setPlugins(a),c.parse(s,n)}parseAsync(t,e){const s=this;return new Promise(function(n,r){s.parse(t,e,n,r)})}}function wf(){let i={};return{get:function(t){return i[t]},add:function(t,e){i[t]=e},remove:function(t){delete i[t]},removeAll:function(){i={}}}}const V={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Sf{constructor(t){this.parser=t,this.name=V.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const t=this.parser,e=this.parser.json.nodes||[];for(let s=0,n=e.length;s<n;s++){const r=e[s];r.extensions&&r.extensions[this.name]&&r.extensions[this.name].light!==void 0&&t._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(t){const e=this.parser,s="light:"+t;let n=e.cache.get(s);if(n)return n;const r=e.json,l=((r.extensions&&r.extensions[this.name]||{}).lights||[])[t];let c;const h=new U(16777215);l.color!==void 0&&h.setRGB(l.color[0],l.color[1],l.color[2],Ze);const u=l.range!==void 0?l.range:0;switch(l.type){case"directional":c=new Tt(h),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new Xl(h),c.distance=u;break;case"spot":c=new Kl(h),c.distance=u,l.spot=l.spot||{},l.spot.innerConeAngle=l.spot.innerConeAngle!==void 0?l.spot.innerConeAngle:0,l.spot.outerConeAngle=l.spot.outerConeAngle!==void 0?l.spot.outerConeAngle:Math.PI/4,c.angle=l.spot.outerConeAngle,c.penumbra=1-l.spot.innerConeAngle/l.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+l.type)}return c.position.set(0,0,0),c.decay=2,gt(c,l),l.intensity!==void 0&&(c.intensity=l.intensity),c.name=e.createUniqueName(l.name||"light_"+t),n=Promise.resolve(c),e.cache.add(s,n),n}getDependency(t,e){if(t==="light")return this._loadLight(e)}createNodeAttachment(t){const e=this,s=this.parser,r=s.json.nodes[t],a=(r.extensions&&r.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(l){return s._getNodeRef(e.cache,a,l)})}}class Tf{constructor(){this.name=V.KHR_MATERIALS_UNLIT}getMaterialType(){return Dt}extendParams(t,e,s){const n=[];t.color=new U(1,1,1),t.opacity=1;const r=e.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const o=r.baseColorFactor;t.color.setRGB(o[0],o[1],o[2],Ze),t.opacity=o[3]}r.baseColorTexture!==void 0&&n.push(s.assignTexture(t,"map",r.baseColorTexture,Z))}return Promise.all(n)}}class Ef{constructor(t){this.parser=t,this.name=V.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(t,e){const n=this.parser.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name].emissiveStrength;return r!==void 0&&(e.emissiveIntensity=r),Promise.resolve()}}class Af{constructor(t){this.parser=t,this.name=V.KHR_MATERIALS_CLEARCOAT}getMaterialType(t){const s=this.parser.json.materials[t];return!s.extensions||!s.extensions[this.name]?null:_t}extendMaterialParams(t,e){const s=this.parser,n=s.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];if(o.clearcoatFactor!==void 0&&(e.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&r.push(s.assignTexture(e,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(e.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&r.push(s.assignTexture(e,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(r.push(s.assignTexture(e,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const a=o.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new F(a,a)}return Promise.all(r)}}class Mf{constructor(t){this.parser=t,this.name=V.KHR_MATERIALS_IRIDESCENCE}getMaterialType(t){const s=this.parser.json.materials[t];return!s.extensions||!s.extensions[this.name]?null:_t}extendMaterialParams(t,e){const s=this.parser,n=s.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return o.iridescenceFactor!==void 0&&(e.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&r.push(s.assignTexture(e,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(e.iridescenceIOR=o.iridescenceIor),e.iridescenceThicknessRange===void 0&&(e.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(e.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(e.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&r.push(s.assignTexture(e,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(r)}}class Cf{constructor(t){this.parser=t,this.name=V.KHR_MATERIALS_SHEEN}getMaterialType(t){const s=this.parser.json.materials[t];return!s.extensions||!s.extensions[this.name]?null:_t}extendMaterialParams(t,e){const s=this.parser,n=s.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[];e.sheenColor=new U(0,0,0),e.sheenRoughness=0,e.sheen=1;const o=n.extensions[this.name];if(o.sheenColorFactor!==void 0){const a=o.sheenColorFactor;e.sheenColor.setRGB(a[0],a[1],a[2],Ze)}return o.sheenRoughnessFactor!==void 0&&(e.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&r.push(s.assignTexture(e,"sheenColorMap",o.sheenColorTexture,Z)),o.sheenRoughnessTexture!==void 0&&r.push(s.assignTexture(e,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(r)}}class _f{constructor(t){this.parser=t,this.name=V.KHR_MATERIALS_TRANSMISSION}getMaterialType(t){const s=this.parser.json.materials[t];return!s.extensions||!s.extensions[this.name]?null:_t}extendMaterialParams(t,e){const s=this.parser,n=s.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return o.transmissionFactor!==void 0&&(e.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&r.push(s.assignTexture(e,"transmissionMap",o.transmissionTexture)),Promise.all(r)}}class Pf{constructor(t){this.parser=t,this.name=V.KHR_MATERIALS_VOLUME}getMaterialType(t){const s=this.parser.json.materials[t];return!s.extensions||!s.extensions[this.name]?null:_t}extendMaterialParams(t,e){const s=this.parser,n=s.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];e.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&r.push(s.assignTexture(e,"thicknessMap",o.thicknessTexture)),e.attenuationDistance=o.attenuationDistance||1/0;const a=o.attenuationColor||[1,1,1];return e.attenuationColor=new U().setRGB(a[0],a[1],a[2],Ze),Promise.all(r)}}class Rf{constructor(t){this.parser=t,this.name=V.KHR_MATERIALS_IOR}getMaterialType(t){const s=this.parser.json.materials[t];return!s.extensions||!s.extensions[this.name]?null:_t}extendMaterialParams(t,e){const n=this.parser.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name];return e.ior=r.ior!==void 0?r.ior:1.5,Promise.resolve()}}class Lf{constructor(t){this.parser=t,this.name=V.KHR_MATERIALS_SPECULAR}getMaterialType(t){const s=this.parser.json.materials[t];return!s.extensions||!s.extensions[this.name]?null:_t}extendMaterialParams(t,e){const s=this.parser,n=s.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];e.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&r.push(s.assignTexture(e,"specularIntensityMap",o.specularTexture));const a=o.specularColorFactor||[1,1,1];return e.specularColor=new U().setRGB(a[0],a[1],a[2],Ze),o.specularColorTexture!==void 0&&r.push(s.assignTexture(e,"specularColorMap",o.specularColorTexture,Z)),Promise.all(r)}}class Df{constructor(t){this.parser=t,this.name=V.KHR_MATERIALS_ANISOTROPY}getMaterialType(t){const s=this.parser.json.materials[t];return!s.extensions||!s.extensions[this.name]?null:_t}extendMaterialParams(t,e){const s=this.parser,n=s.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return o.anisotropyStrength!==void 0&&(e.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(e.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&r.push(s.assignTexture(e,"anisotropyMap",o.anisotropyTexture)),Promise.all(r)}}class Bf{constructor(t){this.parser=t,this.name=V.KHR_TEXTURE_BASISU}loadTexture(t){const e=this.parser,s=e.json,n=s.textures[t];if(!n.extensions||!n.extensions[this.name])return null;const r=n.extensions[this.name],o=e.options.ktx2Loader;if(!o){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return e.loadTextureImage(t,r.source,o)}}class If{constructor(t){this.parser=t,this.name=V.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(t){const e=this.name,s=this.parser,n=s.json,r=n.textures[t];if(!r.extensions||!r.extensions[e])return null;const o=r.extensions[e],a=n.images[o.source];let l=s.textureLoader;if(a.uri){const c=s.options.manager.getHandler(a.uri);c!==null&&(l=c)}return this.detectSupport().then(function(c){if(c)return s.loadTextureImage(t,o.source,l);if(n.extensionsRequired&&n.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(t)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(t){const e=new Image;e.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",e.onload=e.onerror=function(){t(e.height===1)}})),this.isSupported}}class Of{constructor(t){this.parser=t,this.name=V.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(t){const e=this.name,s=this.parser,n=s.json,r=n.textures[t];if(!r.extensions||!r.extensions[e])return null;const o=r.extensions[e],a=n.images[o.source];let l=s.textureLoader;if(a.uri){const c=s.options.manager.getHandler(a.uri);c!==null&&(l=c)}return this.detectSupport().then(function(c){if(c)return s.loadTextureImage(t,o.source,l);if(n.extensionsRequired&&n.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(t)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(t){const e=new Image;e.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",e.onload=e.onerror=function(){t(e.height===1)}})),this.isSupported}}class Ff{constructor(t){this.name=V.EXT_MESHOPT_COMPRESSION,this.parser=t}loadBufferView(t){const e=this.parser.json,s=e.bufferViews[t];if(s.extensions&&s.extensions[this.name]){const n=s.extensions[this.name],r=this.parser.getDependency("buffer",n.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(e.extensionsRequired&&e.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then(function(a){const l=n.byteOffset||0,c=n.byteLength||0,h=n.count,u=n.byteStride,d=new Uint8Array(a,l,c);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(h,u,d,n.mode,n.filter).then(function(f){return f.buffer}):o.ready.then(function(){const f=new ArrayBuffer(h*u);return o.decodeGltfBuffer(new Uint8Array(f),h,u,d,n.mode,n.filter),f})})}else return null}}class Nf{constructor(t){this.name=V.EXT_MESH_GPU_INSTANCING,this.parser=t}createNodeMesh(t){const e=this.parser.json,s=e.nodes[t];if(!s.extensions||!s.extensions[this.name]||s.mesh===void 0)return null;const n=e.meshes[s.mesh];for(const c of n.primitives)if(c.mode!==Le.TRIANGLES&&c.mode!==Le.TRIANGLE_STRIP&&c.mode!==Le.TRIANGLE_FAN&&c.mode!==void 0)return null;const o=s.extensions[this.name].attributes,a=[],l={};for(const c in o)a.push(this.parser.getDependency("accessor",o[c]).then(h=>(l[c]=h,l[c])));return a.length<1?null:(a.push(this.parser.createNodeMesh(t)),Promise.all(a).then(c=>{const h=c.pop(),u=h.isGroup?h.children:[h],d=c[0].count,f=[];for(const g of u){const v=new ie,p=new M,m=new zs,y=new M(1,1,1),x=new wa(g.geometry,g.material,d);for(let b=0;b<d;b++)l.TRANSLATION&&p.fromBufferAttribute(l.TRANSLATION,b),l.ROTATION&&m.fromBufferAttribute(l.ROTATION,b),l.SCALE&&y.fromBufferAttribute(l.SCALE,b),x.setMatrixAt(b,v.compose(p,m,y));for(const b in l)if(b==="_COLOR_0"){const w=l[b];x.instanceColor=new Yl(w.array,w.itemSize,w.normalized)}else b!=="TRANSLATION"&&b!=="ROTATION"&&b!=="SCALE"&&g.geometry.setAttribute(b,l[b]);ve.prototype.copy.call(x,g),this.parser.assignFinalMaterial(x),f.push(x)}return h.isGroup?(h.clear(),h.add(...f),h):f[0]}))}}const il="glTF",Rs=12,jo={JSON:1313821514,BIN:5130562};class Uf{constructor(t){this.name=V.KHR_BINARY_GLTF,this.content=null,this.body=null;const e=new DataView(t,0,Rs),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(t.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==il)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-Rs,r=new DataView(t,Rs);let o=0;for(;o<n;){const a=r.getUint32(o,!0);o+=4;const l=r.getUint32(o,!0);if(o+=4,l===jo.JSON){const c=new Uint8Array(t,Rs+o,a);this.content=s.decode(c)}else if(l===jo.BIN){const c=Rs+o;this.body=t.slice(c,c+a)}o+=a}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class kf{constructor(t,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=V.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=e,this.dracoLoader.preload()}decodePrimitive(t,e){const s=this.json,n=this.dracoLoader,r=t.extensions[this.name].bufferView,o=t.extensions[this.name].attributes,a={},l={},c={};for(const h in o){const u=or[h]||h.toLowerCase();a[u]=o[h]}for(const h in t.attributes){const u=or[h]||h.toLowerCase();if(o[h]!==void 0){const d=s.accessors[t.attributes[h]],f=rs[d.componentType];c[u]=f.name,l[u]=d.normalized===!0}}return e.getDependency("bufferView",r).then(function(h){return new Promise(function(u){n.decodeDracoFile(h,function(d){for(const f in d.attributes){const g=d.attributes[f],v=l[f];v!==void 0&&(g.normalized=v)}u(d)},a,c)})})}}class zf{constructor(){this.name=V.KHR_TEXTURE_TRANSFORM}extendTexture(t,e){return(e.texCoord===void 0||e.texCoord===t.channel)&&e.offset===void 0&&e.rotation===void 0&&e.scale===void 0||(t=t.clone(),e.texCoord!==void 0&&(t.channel=e.texCoord),e.offset!==void 0&&t.offset.fromArray(e.offset),e.rotation!==void 0&&(t.rotation=e.rotation),e.scale!==void 0&&t.repeat.fromArray(e.scale),t.needsUpdate=!0),t}}class Hf{constructor(){this.name=V.KHR_MESH_QUANTIZATION}}class nl extends gc{constructor(t,e,s,n){super(t,e,s,n)}copySampleValue_(t){const e=this.resultBuffer,s=this.sampleValues,n=this.valueSize,r=t*n*3+n;for(let o=0;o!==n;o++)e[o]=s[r+o];return e}interpolate_(t,e,s,n){const r=this.resultBuffer,o=this.sampleValues,a=this.valueSize,l=a*2,c=a*3,h=n-e,u=(s-e)/h,d=u*u,f=d*u,g=t*c,v=g-c,p=-2*f+3*d,m=f-d,y=1-p,x=m-d+u;for(let b=0;b!==a;b++){const w=o[v+b+a],E=o[v+b+l]*h,T=o[g+b+a],A=o[g+b]*h;r[b]=y*w+x*E+p*T+m*A}return r}}const Gf=new zs;class jf extends nl{interpolate_(t,e,s,n){const r=super.interpolate_(t,e,s,n);return Gf.fromArray(r).normalize().toArray(r),r}}const Le={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},rs={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Vo={9728:qn,9729:ds,9984:uc,9985:hc,9986:dc,9987:Sa},qo={33071:fc,33648:pc,10497:kt},Fn={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},or={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ft={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Vf={CUBICSPLINE:void 0,LINEAR:Ta,STEP:mc},Nn={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function qf(i){return i.DefaultMaterial===void 0&&(i.DefaultMaterial=new mr({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Ai})),i.DefaultMaterial}function Rt(i,t,e){for(const s in e.extensions)i[s]===void 0&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[s]=e.extensions[s])}function gt(i,t){t.extras!==void 0&&(typeof t.extras=="object"?Object.assign(i.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Wf(i,t,e){let s=!1,n=!1,r=!1;for(let c=0,h=t.length;c<h;c++){const u=t[c];if(u.POSITION!==void 0&&(s=!0),u.NORMAL!==void 0&&(n=!0),u.COLOR_0!==void 0&&(r=!0),s&&n&&r)break}if(!s&&!n&&!r)return Promise.resolve(i);const o=[],a=[],l=[];for(let c=0,h=t.length;c<h;c++){const u=t[c];if(s){const d=u.POSITION!==void 0?e.getDependency("accessor",u.POSITION):i.attributes.position;o.push(d)}if(n){const d=u.NORMAL!==void 0?e.getDependency("accessor",u.NORMAL):i.attributes.normal;a.push(d)}if(r){const d=u.COLOR_0!==void 0?e.getDependency("accessor",u.COLOR_0):i.attributes.color;l.push(d)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l)]).then(function(c){const h=c[0],u=c[1],d=c[2];return s&&(i.morphAttributes.position=h),n&&(i.morphAttributes.normal=u),r&&(i.morphAttributes.color=d),i.morphTargetsRelative=!0,i})}function Kf(i,t){if(i.updateMorphTargets(),t.weights!==void 0)for(let e=0,s=t.weights.length;e<s;e++)i.morphTargetInfluences[e]=t.weights[e];if(t.extras&&Array.isArray(t.extras.targetNames)){const e=t.extras.targetNames;if(i.morphTargetInfluences.length===e.length){i.morphTargetDictionary={};for(let s=0,n=e.length;s<n;s++)i.morphTargetDictionary[e[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Xf(i){let t;const e=i.extensions&&i.extensions[V.KHR_DRACO_MESH_COMPRESSION];if(e?t="draco:"+e.bufferView+":"+e.indices+":"+Un(e.attributes):t=i.indices+":"+Un(i.attributes)+":"+i.mode,i.targets!==void 0)for(let s=0,n=i.targets.length;s<n;s++)t+=":"+Un(i.targets[s]);return t}function Un(i){let t="";const e=Object.keys(i).sort();for(let s=0,n=e.length;s<n;s++)t+=e[s]+":"+i[e[s]]+";";return t}function ar(i){switch(i){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Yf(i){return i.search(/\.jpe?g($|\?)/i)>0||i.search(/^data\:image\/jpeg/)===0?"image/jpeg":i.search(/\.webp($|\?)/i)>0||i.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const $f=new ie;class Zf{constructor(t={},e={}){this.json=t,this.extensions={},this.plugins={},this.options=e,this.cache=new wf,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=!1,r=-1;typeof navigator<"u"&&(s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,n=navigator.userAgent.indexOf("Firefox")>-1,r=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||s||n&&r<98?this.textureLoader=new Ke(this.options.manager):this.textureLoader=new $l(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new xa(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(t){this.extensions=t}setPlugins(t){this.plugins=t}parse(t,e){const s=this,n=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(o){const a={scene:o[0][n.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:n.asset,parser:s,userData:{}};return Rt(r,a,n),gt(a,n),Promise.all(s._invokeAll(function(l){return l.afterRoot&&l.afterRoot(a)})).then(function(){t(a)})}).catch(e)}_markDefs(){const t=this.json.nodes||[],e=this.json.skins||[],s=this.json.meshes||[];for(let n=0,r=e.length;n<r;n++){const o=e[n].joints;for(let a=0,l=o.length;a<l;a++)t[o[a]].isBone=!0}for(let n=0,r=t.length;n<r;n++){const o=t[n];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(s[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(t,e){e!==void 0&&(t.refs[e]===void 0&&(t.refs[e]=t.uses[e]=0),t.refs[e]++)}_getNodeRef(t,e,s){if(t.refs[e]<=1)return s;const n=s.clone(),r=(o,a)=>{const l=this.associations.get(o);l!=null&&this.associations.set(a,l);for(const[c,h]of o.children.entries())r(h,a.children[c])};return r(s,n),n.name+="_instance_"+t.uses[e]++,n}_invokeOne(t){const e=Object.values(this.plugins);e.push(this);for(let s=0;s<e.length;s++){const n=t(e[s]);if(n)return n instanceof Promise?n.catch(function(r){return console.warn("THREE.GLTFLoader: Extension error:",r),null}):n}return null}_invokeAll(t){const e=Object.values(this.plugins);e.unshift(this);const s=[];for(let n=0;n<e.length;n++){const r=t(e[n]);r&&s.push(r)}return s}getDependency(t,e){const s=t+":"+e;let n=this.cache.get(s);if(!n){switch(t){case"scene":n=this.loadScene(e);break;case"node":n=this._invokeOne(function(r){return r.loadNode&&r.loadNode(e)});break;case"mesh":n=this._invokeOne(function(r){return r.loadMesh&&r.loadMesh(e)});break;case"accessor":n=this.loadAccessor(e);break;case"bufferView":n=this._invokeOne(function(r){return r.loadBufferView&&r.loadBufferView(e)});break;case"buffer":n=this.loadBuffer(e);break;case"material":n=this._invokeOne(function(r){return r.loadMaterial&&r.loadMaterial(e)});break;case"texture":n=this._invokeOne(function(r){return r.loadTexture&&r.loadTexture(e)});break;case"skin":n=this.loadSkin(e);break;case"animation":n=this._invokeOne(function(r){return r.loadAnimation&&r.loadAnimation(e)});break;case"camera":n=this.loadCamera(e);break;default:if(n=this._invokeOne(function(r){return r!=this&&r.getDependency&&r.getDependency(t,e)}),!n)throw new Error("Unknown type: "+t);break}this.cache.add(s,n)}return n}getDependencies(t){let e=this.cache.get(t);if(!e){const s=this,n=this.json[t+(t==="mesh"?"es":"s")]||[];e=Promise.all(n.map(function(r,o){return s.getDependency(t,o)})),this.cache.add(t,e)}return e}loadBuffer(t){const e=this.json.buffers[t],s=this.fileLoader;if(e.type&&e.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+e.type+" buffer type is not supported.");if(e.uri===void 0&&t===0)return Promise.resolve(this.extensions[V.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(r,o){s.load(Xn.resolveURL(e.uri,n.path),r,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+e.uri+'".'))})})}loadBufferView(t){const e=this.json.bufferViews[t];return this.getDependency("buffer",e.buffer).then(function(s){const n=e.byteLength||0,r=e.byteOffset||0;return s.slice(r,r+n)})}loadAccessor(t){const e=this,s=this.json,n=this.json.accessors[t];if(n.bufferView===void 0&&n.sparse===void 0){const o=Fn[n.type],a=rs[n.componentType],l=n.normalized===!0,c=new a(n.count*o);return Promise.resolve(new oe(c,o,l))}const r=[];return n.bufferView!==void 0?r.push(this.getDependency("bufferView",n.bufferView)):r.push(null),n.sparse!==void 0&&(r.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(r).then(function(o){const a=o[0],l=Fn[n.type],c=rs[n.componentType],h=c.BYTES_PER_ELEMENT,u=h*l,d=n.byteOffset||0,f=n.bufferView!==void 0?s.bufferViews[n.bufferView].byteStride:void 0,g=n.normalized===!0;let v,p;if(f&&f!==u){const m=Math.floor(d/f),y="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+m+":"+n.count;let x=e.cache.get(y);x||(v=new c(a,m*f,n.count*f/h),x=new Zl(v,f/h),e.cache.add(y,x)),p=new Bt(x,l,d%f/h,g)}else a===null?v=new c(n.count*l):v=new c(a,d,n.count*l),p=new oe(v,l,g);if(n.sparse!==void 0){const m=Fn.SCALAR,y=rs[n.sparse.indices.componentType],x=n.sparse.indices.byteOffset||0,b=n.sparse.values.byteOffset||0,w=new y(o[1],x,n.sparse.count*m),E=new c(o[2],b,n.sparse.count*l);a!==null&&(p=new oe(p.array.slice(),p.itemSize,p.normalized));for(let T=0,A=w.length;T<A;T++){const C=w[T];if(p.setX(C,E[T*l]),l>=2&&p.setY(C,E[T*l+1]),l>=3&&p.setZ(C,E[T*l+2]),l>=4&&p.setW(C,E[T*l+3]),l>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return p})}loadTexture(t){const e=this.json,s=this.options,r=e.textures[t].source,o=e.images[r];let a=this.textureLoader;if(o.uri){const l=s.manager.getHandler(o.uri);l!==null&&(a=l)}return this.loadTextureImage(t,r,a).catch(function(l){return console.warn(`THREE.GLTFLoader: Error loading texture ${t}:`,l),null})}loadTextureImage(t,e,s){const n=this,r=this.json,o=r.textures[t],a=r.images[e],l=(a.uri||a.bufferView)+":"+o.sampler;if(this.textureCache[l])return this.textureCache[l];const c=this.loadImageSource(e,s).then(function(h){if(!h)return console.warn(`THREE.GLTFLoader: Failed to load texture image for texture ${t}`),null;h.flipY=!1,h.name=o.name||a.name||"",h.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(h.name=a.uri);const d=(r.samplers||{})[o.sampler]||{};return h.magFilter=Vo[d.magFilter]||ds,h.minFilter=Vo[d.minFilter]||Sa,h.wrapS=qo[d.wrapS]||kt,h.wrapT=qo[d.wrapT]||kt,n.associations.set(h,{textures:t}),h}).catch(function(h){return console.warn(`THREE.GLTFLoader: Error in loadTextureImage for texture ${t}:`,h),null});return this.textureCache[l]=c,c}loadImageSource(t,e){const s=this,n=this.json,r=this.options;if(this.sourceCache[t]!==void 0)return this.sourceCache[t].then(d=>d.clone());const o=n.images[t],a=self.URL||self.webkitURL;let l=o.uri||"",c=!1,h=null;if(o.bufferView!==void 0)l=s.getDependency("bufferView",o.bufferView).then(function(d){c=!0;const f=o.mimeType||"image/png",g=new Blob([d],{type:f});return h=a.createObjectURL(g),h}).catch(function(d){return console.warn(`THREE.GLTFLoader: Failed to get bufferView for image ${t}:`,d),null});else if(o.uri===void 0)return console.error("THREE.GLTFLoader: Image "+t+" is missing URI and bufferView"),Promise.resolve(null);const u=Promise.resolve(l).then(function(d){return d?new Promise(function(f,g){let v=f;e.isImageBitmapLoader===!0&&(v=function(p){const m=new fs(p);m.needsUpdate=!0,f(m)}),e.load(Xn.resolveURL(d,r.path),v,void 0,function(p){console.warn("THREE.GLTFLoader: Failed to load texture image:",d,p),f(null)})}):null}).then(function(d){return c===!0&&h&&setTimeout(()=>{try{a.revokeObjectURL(h)}catch(f){console.warn("THREE.GLTFLoader: Error revoking object URL:",f)}},1e3),d&&(d.userData.mimeType=o.mimeType||Yf(o.uri)),d}).catch(function(d){if(c===!0&&h)try{a.revokeObjectURL(h)}catch(f){console.warn("THREE.GLTFLoader: Error revoking object URL on error:",f)}return console.warn("THREE.GLTFLoader: Couldn't load texture",l,d),null});return this.sourceCache[t]=u,u}assignTexture(t,e,s,n){const r=this;return this.getDependency("texture",s.index).then(function(o){if(!o)return console.warn(`THREE.GLTFLoader: Texture for ${e} failed to load, using default material`),null;if(s.texCoord!==void 0&&s.texCoord>0&&(o=o.clone(),o.channel=s.texCoord),r.extensions[V.KHR_TEXTURE_TRANSFORM]){const a=s.extensions!==void 0?s.extensions[V.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const l=r.associations.get(o);o=r.extensions[V.KHR_TEXTURE_TRANSFORM].extendTexture(o,a),r.associations.set(o,l)}}return n!==void 0&&(o.colorSpace=n),t[e]=o,o}).catch(function(o){return console.warn(`THREE.GLTFLoader: Failed to assign texture for ${e}:`,o),null})}assignFinalMaterial(t){const e=t.geometry;let s=t.material;const n=e.attributes.tangent===void 0,r=e.attributes.color!==void 0,o=e.attributes.normal===void 0;if(t.isPoints){const a="PointsMaterial:"+s.uuid;let l=this.cache.get(a);l||(l=new Ql,ns.prototype.copy.call(l,s),l.color.copy(s.color),l.map=s.map,l.sizeAttenuation=!1,this.cache.add(a,l)),s=l}else if(t.isLine){const a="LineBasicMaterial:"+s.uuid;let l=this.cache.get(a);l||(l=new Jl,ns.prototype.copy.call(l,s),l.color.copy(s.color),l.map=s.map,this.cache.add(a,l)),s=l}if(n||r||o){let a="ClonedMaterial:"+s.uuid+":";n&&(a+="derivative-tangents:"),r&&(a+="vertex-colors:"),o&&(a+="flat-shading:");let l=this.cache.get(a);l||(l=s.clone(),r&&(l.vertexColors=!0),o&&(l.flatShading=!0),n&&(l.normalScale&&(l.normalScale.y*=-1),l.clearcoatNormalScale&&(l.clearcoatNormalScale.y*=-1)),this.cache.add(a,l),this.associations.set(l,this.associations.get(s))),s=l}t.material=s}getMaterialType(){return mr}loadMaterial(t){const e=this,s=this.json,n=this.extensions,r=s.materials[t];let o;const a={},l=r.extensions||{},c=[];if(l[V.KHR_MATERIALS_UNLIT]){const u=n[V.KHR_MATERIALS_UNLIT];o=u.getMaterialType(),c.push(u.extendParams(a,r,e))}else{const u=r.pbrMetallicRoughness||{};if(a.color=new U(1,1,1),a.opacity=1,Array.isArray(u.baseColorFactor)){const d=u.baseColorFactor;a.color.setRGB(d[0],d[1],d[2],Ze),a.opacity=d[3]}u.baseColorTexture!==void 0&&c.push(e.assignTexture(a,"map",u.baseColorTexture,Z)),a.metalness=u.metallicFactor!==void 0?u.metallicFactor:1,a.roughness=u.roughnessFactor!==void 0?u.roughnessFactor:1,u.metallicRoughnessTexture!==void 0&&(c.push(e.assignTexture(a,"metalnessMap",u.metallicRoughnessTexture)),c.push(e.assignTexture(a,"roughnessMap",u.metallicRoughnessTexture))),o=this._invokeOne(function(d){return d.getMaterialType&&d.getMaterialType(t)}),c.push(Promise.all(this._invokeAll(function(d){return d.extendMaterialParams&&d.extendMaterialParams(t,a)})))}r.doubleSided===!0&&(a.side=ze);const h=r.alphaMode||Nn.OPAQUE;if(h===Nn.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,h===Nn.MASK&&(a.alphaTest=r.alphaCutoff!==void 0?r.alphaCutoff:.5)),r.normalTexture!==void 0&&o!==Dt&&(c.push(e.assignTexture(a,"normalMap",r.normalTexture)),a.normalScale=new F(1,1),r.normalTexture.scale!==void 0)){const u=r.normalTexture.scale;a.normalScale.set(u,u)}if(r.occlusionTexture!==void 0&&o!==Dt&&(c.push(e.assignTexture(a,"aoMap",r.occlusionTexture)),r.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=r.occlusionTexture.strength)),r.emissiveFactor!==void 0&&o!==Dt){const u=r.emissiveFactor;a.emissive=new U().setRGB(u[0],u[1],u[2],Ze)}return r.emissiveTexture!==void 0&&o!==Dt&&c.push(e.assignTexture(a,"emissiveMap",r.emissiveTexture,Z)),Promise.all(c).then(function(){const u=new o(a);return r.name&&(u.name=r.name),gt(u,r),e.associations.set(u,{materials:t}),r.extensions&&Rt(n,u,r),u})}createUniqueName(t){const e=ec.sanitizeNodeName(t||"");return e in this.nodeNamesUsed?e+"_"+ ++this.nodeNamesUsed[e]:(this.nodeNamesUsed[e]=0,e)}loadGeometries(t){const e=this,s=this.extensions,n=this.primitiveCache;function r(a){return s[V.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,e).then(function(l){return Wo(l,a,e)})}const o=[];for(let a=0,l=t.length;a<l;a++){const c=t[a],h=Xf(c),u=n[h];if(u)o.push(u.promise);else{let d;c.extensions&&c.extensions[V.KHR_DRACO_MESH_COMPRESSION]?d=r(c):d=Wo(new Ht,c,e),n[h]={primitive:c,promise:d},o.push(d)}}return Promise.all(o)}loadMesh(t){const e=this,s=this.json,n=this.extensions,r=s.meshes[t],o=r.primitives,a=[];for(let l=0,c=o.length;l<c;l++){const h=o[l].material===void 0?qf(this.cache):this.getDependency("material",o[l].material);a.push(h)}return a.push(e.loadGeometries(o)),Promise.all(a).then(function(l){const c=l.slice(0,l.length-1),h=l[l.length-1],u=[];for(let f=0,g=h.length;f<g;f++){const v=h[f],p=o[f];let m;const y=c[f];if(p.mode===Le.TRIANGLES||p.mode===Le.TRIANGLE_STRIP||p.mode===Le.TRIANGLE_FAN||p.mode===void 0)m=r.isSkinnedMesh===!0?new tc(v,y):new de(v,y),m.isSkinnedMesh===!0&&m.normalizeSkinWeights(),p.mode===Le.TRIANGLE_STRIP?m.geometry=Go(m.geometry,ba):p.mode===Le.TRIANGLE_FAN&&(m.geometry=Go(m.geometry,Kn));else if(p.mode===Le.LINES)m=new sc(v,y);else if(p.mode===Le.LINE_STRIP)m=new ic(v,y);else if(p.mode===Le.LINE_LOOP)m=new nc(v,y);else if(p.mode===Le.POINTS)m=new rc(v,y);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);Object.keys(m.geometry.morphAttributes).length>0&&Kf(m,r),m.name=e.createUniqueName(r.name||"mesh_"+t),gt(m,r),p.extensions&&Rt(n,m,p),e.assignFinalMaterial(m),u.push(m)}for(let f=0,g=u.length;f<g;f++)e.associations.set(u[f],{meshes:t,primitives:f});if(u.length===1)return r.extensions&&Rt(n,u[0],r),u[0];const d=new Q;r.extensions&&Rt(n,d,r),e.associations.set(d,{meshes:t});for(let f=0,g=u.length;f<g;f++)d.add(u[f]);return d})}loadCamera(t){let e;const s=this.json.cameras[t],n=s[s.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return s.type==="perspective"?e=new ms(ur.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):s.type==="orthographic"&&(e=new oc(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(e.name=this.createUniqueName(s.name)),gt(e,s),Promise.resolve(e)}loadSkin(t){const e=this.json.skins[t],s=[];for(let n=0,r=e.joints.length;n<r;n++)s.push(this._loadNodeShallow(e.joints[n]));return e.inverseBindMatrices!==void 0?s.push(this.getDependency("accessor",e.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(n){const r=n.pop(),o=n,a=[],l=[];for(let c=0,h=o.length;c<h;c++){const u=o[c];if(u){a.push(u);const d=new ie;r!==null&&d.fromArray(r.array,c*16),l.push(d)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',e.joints[c])}return new ac(a,l)})}loadAnimation(t){const e=this.json,s=this,n=e.animations[t],r=n.name?n.name:"animation_"+t,o=[],a=[],l=[],c=[],h=[];for(let u=0,d=n.channels.length;u<d;u++){const f=n.channels[u],g=n.samplers[f.sampler],v=f.target,p=v.node,m=n.parameters!==void 0?n.parameters[g.input]:g.input,y=n.parameters!==void 0?n.parameters[g.output]:g.output;v.node!==void 0&&(o.push(this.getDependency("node",p)),a.push(this.getDependency("accessor",m)),l.push(this.getDependency("accessor",y)),c.push(g),h.push(v))}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(h)]).then(function(u){const d=u[0],f=u[1],g=u[2],v=u[3],p=u[4],m=[];for(let y=0,x=d.length;y<x;y++){const b=d[y],w=f[y],E=g[y],T=v[y],A=p[y];if(b===void 0)continue;b.updateMatrix&&b.updateMatrix();const C=s._createAnimationTracks(b,w,E,T,A);if(C)for(let R=0;R<C.length;R++)m.push(C[R])}return new lc(r,void 0,m)})}createNodeMesh(t){const e=this.json,s=this,n=e.nodes[t];return n.mesh===void 0?null:s.getDependency("mesh",n.mesh).then(function(r){const o=s._getNodeRef(s.meshCache,n.mesh,r);return n.weights!==void 0&&o.traverse(function(a){if(a.isMesh)for(let l=0,c=n.weights.length;l<c;l++)a.morphTargetInfluences[l]=n.weights[l]}),o})}loadNode(t){const e=this.json,s=this,n=e.nodes[t],r=s._loadNodeShallow(t),o=[],a=n.children||[];for(let c=0,h=a.length;c<h;c++)o.push(s.getDependency("node",a[c]));const l=n.skin===void 0?Promise.resolve(null):s.getDependency("skin",n.skin);return Promise.all([r,Promise.all(o),l]).then(function(c){const h=c[0],u=c[1],d=c[2];d!==null&&h.traverse(function(f){f.isSkinnedMesh&&f.bind(d,$f)});for(let f=0,g=u.length;f<g;f++)h.add(u[f]);return h})}_loadNodeShallow(t){const e=this.json,s=this.extensions,n=this;if(this.nodeCache[t]!==void 0)return this.nodeCache[t];const r=e.nodes[t],o=r.name?n.createUniqueName(r.name):"",a=[],l=n._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(t)});return l&&a.push(l),r.camera!==void 0&&a.push(n.getDependency("camera",r.camera).then(function(c){return n._getNodeRef(n.cameraCache,r.camera,c)})),n._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(t)}).forEach(function(c){a.push(c)}),this.nodeCache[t]=Promise.all(a).then(function(c){let h;if(r.isBone===!0?h=new cc:c.length>1?h=new Q:c.length===1?h=c[0]:h=new ve,h!==c[0])for(let u=0,d=c.length;u<d;u++)h.add(c[u]);if(r.name&&(h.userData.name=r.name,h.name=o),gt(h,r),r.extensions&&Rt(s,h,r),r.matrix!==void 0){const u=new ie;u.fromArray(r.matrix),h.applyMatrix4(u)}else r.translation!==void 0&&h.position.fromArray(r.translation),r.rotation!==void 0&&h.quaternion.fromArray(r.rotation),r.scale!==void 0&&h.scale.fromArray(r.scale);return n.associations.has(h)||n.associations.set(h,{}),n.associations.get(h).nodes=t,h}),this.nodeCache[t]}loadScene(t){const e=this.extensions,s=this.json.scenes[t],n=this,r=new Q;s.name&&(r.name=n.createUniqueName(s.name)),gt(r,s),s.extensions&&Rt(e,r,s);const o=s.nodes||[],a=[];for(let l=0,c=o.length;l<c;l++)a.push(n.getDependency("node",o[l]));return Promise.all(a).then(function(l){for(let h=0,u=l.length;h<u;h++)r.add(l[h]);const c=h=>{const u=new Map;for(const[d,f]of n.associations)(d instanceof ns||d instanceof fs)&&u.set(d,f);return h.traverse(d=>{const f=n.associations.get(d);f!=null&&u.set(d,f)}),u};return n.associations=c(r),r})}_createAnimationTracks(t,e,s,n,r){const o=[],a=t.name?t.name:t.uuid,l=[];ft[r.path]===ft.weights?t.traverse(function(d){d.morphTargetInfluences&&l.push(d.name?d.name:d.uuid)}):l.push(a);let c;switch(ft[r.path]){case ft.weights:c=Gr;break;case ft.rotation:c=jr;break;case ft.position:case ft.scale:c=Hr;break;default:switch(s.itemSize){case 1:c=Gr;break;case 2:case 3:default:c=Hr;break}break}const h=n.interpolation!==void 0?Vf[n.interpolation]:Ta,u=this._getArrayFromAccessor(s);for(let d=0,f=l.length;d<f;d++){const g=new c(l[d]+"."+ft[r.path],e.array,u,h);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(g),o.push(g)}return o}_getArrayFromAccessor(t){let e=t.array;if(t.normalized){const s=ar(e.constructor),n=new Float32Array(e.length);for(let r=0,o=e.length;r<o;r++)n[r]=e[r]*s;e=n}return e}_createCubicSplineTrackInterpolant(t){t.createInterpolant=function(s){const n=this instanceof jr?jf:nl;return new n(this.times,this.values,this.getValueSize()/3,s)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Qf(i,t,e){const s=t.attributes,n=new le;if(s.POSITION!==void 0){const a=e.json.accessors[s.POSITION],l=a.min,c=a.max;if(l!==void 0&&c!==void 0){if(n.set(new M(l[0],l[1],l[2]),new M(c[0],c[1],c[2])),a.normalized){const h=ar(rs[a.componentType]);n.min.multiplyScalar(h),n.max.multiplyScalar(h)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const r=t.targets;if(r!==void 0){const a=new M,l=new M;for(let c=0,h=r.length;c<h;c++){const u=r[c];if(u.POSITION!==void 0){const d=e.json.accessors[u.POSITION],f=d.min,g=d.max;if(f!==void 0&&g!==void 0){if(l.setX(Math.max(Math.abs(f[0]),Math.abs(g[0]))),l.setY(Math.max(Math.abs(f[1]),Math.abs(g[1]))),l.setZ(Math.max(Math.abs(f[2]),Math.abs(g[2]))),d.normalized){const v=ar(rs[d.componentType]);l.multiplyScalar(v)}a.max(l)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(a)}i.boundingBox=n;const o=new Ct;n.getCenter(o.center),o.radius=n.min.distanceTo(n.max)/2,i.boundingSphere=o}function Wo(i,t,e){const s=t.attributes,n=[];function r(o,a){return e.getDependency("accessor",o).then(function(l){i.setAttribute(a,l)})}for(const o in s){const a=or[o]||o.toLowerCase();a in i.attributes||n.push(r(s[o],a))}if(t.indices!==void 0&&!i.index){const o=e.getDependency("accessor",t.indices).then(function(a){i.setIndex(a)});n.push(o)}return zr.workingColorSpace!==Ze&&"COLOR_0"in s&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${zr.workingColorSpace}" not supported.`),gt(i,t),Qf(i,t,e),Promise.all(n).then(function(){return t.targets!==void 0?Wf(i,t.targets,e):i})}class Jf{constructor(t){this.parser=t,this.name="BL_decrypt"}beforeRoot(){const t=this.parser.json.asset,e=this.parser.json.accessors;if(t.copyright==="bestWay"&&t.encrypt===1&&e)for(let s=0;s<e.length-1;s++){const n=e[s];if(n.type==="VEC3"){n.count-=1;break}}}}const fe=document.createElement("div");fe.style.position="fixed";fe.style.zIndex="9";fe.style.top="0px";fe.style.left="0px";fe.style.width="100%";fe.style.height="100%";fe.style.display="none";fe.style.textAlign="center";fe.style.flexDirection="column";fe.style.justifyContent="center";fe.style.alignItems="center";fe.style.userSelect="none";document.body.appendChild(fe);const rl=document.createElement("img");rl.src="./loading.webp ";fe.appendChild(rl);const Ko="Loading... ",ps=document.createElement("span");ps.style.fontSize="24px";ps.style.opacity="1";ps.style.color="#FFFFFF";fe.appendChild(ps);const Ti={service(i){fe.style.display="flex",ps.innerHTML=Ko+i+"%"},close(){fe.style.display="none",ps.innerHTML=Ko+0+"%"}},ep=new vc(function(){Ti.close(),Id()},function(t,e,s){Ti.service((100*e/s).toFixed(2))},function(t){console.error("Error loading:",t),Ti.close()}),Xo=new xf(ep);function ol(i,t,e){const s=[];if(Ti.service(0),Bd(),Array.isArray(i))i.forEach(n=>{if(n.type!==".glb"&&n.type!==".gltf")return;const r=Xo.loadAsync(n.path).then(o=>{t(o,n.name)});s.push(r)});else{if(i.type!==".glb"&&i.type!==".gltf")return;const n=Xo.loadAsync(i.path).then(r=>t(r,i.name));s.push(n)}return Promise.all(s).then(()=>{e&&e()})}const Yo={"1楼_外壳":"广播电视大楼","2楼_外壳":"科技楼",柴油发电机房_外壳:"柴油发电机房"};class tp extends Ht{constructor(t=3e3,e=!1){super(),isNaN(t)?this._initByData(t.pathPointList,t.options,t.usage,e):this._initByMaxVertex(t,e)}_initByMaxVertex(t,e){this.setAttribute("position",new oe(new Float32Array(t*3),3).setUsage(Is)),this.setAttribute("normal",new oe(new Float32Array(t*3),3).setUsage(Is)),this.setAttribute("uv",new oe(new Float32Array(t*2),2).setUsage(Is)),e&&this.setAttribute("uv2",new oe(new Float32Array(t*2),2).setUsage(Is)),this.drawRange.start=0,this.drawRange.count=0,this.setIndex(t>65536?new Vr(t*3,1):new qr(t*3,1))}_initByData(t,e={},s,n){const r=$o(t,e,n);r&&r.count!==0?(this.setAttribute("position",new oe(new Float32Array(r.position),3).setUsage(s||Ys)),this.setAttribute("normal",new oe(new Float32Array(r.normal),3).setUsage(s||Ys)),this.setAttribute("uv",new oe(new Float32Array(r.uv),2).setUsage(s||Ys)),n&&this.setAttribute("uv2",new oe(new Float32Array(r.uv2),2).setUsage(s||Ys)),this.setIndex(r.position.length/3>65536?new Vr(r.indices,1):new qr(r.indices,1))):this._initByMaxVertex(2,n)}update(t,e={}){const s=!!this.getAttribute("uv2"),n=$o(t,e,s);n?(this._updateAttributes(n.position,n.normal,n.uv,s?n.uv2:null,n.indices),this.drawRange.count=n.count):this.drawRange.count=0}_resizeAttribute(t,e){let s=this.getAttribute(t);for(;s.array.length<e;){const n=s.array.length,r=new oe(new Float32Array(n*2),s.itemSize,s.normalized);r.name=s.name,r.usage=s.usage,this.setAttribute(t,r),s=r}}_resizeIndex(t){let e=this.getIndex();for(;e.array.length<t;){const s=e.array.length,n=new oe(s*2>65535?new Uint32Array(s*2):new Uint16Array(s*2),1);n.name=e.name,n.usage=e.usage,this.setIndex(n),e=n}}_updateAttributes(t,e,s,n,r){this._resizeAttribute("position",t.length);const o=this.getAttribute("position");o.array.set(t,0),o.updateRange.count=t.length,o.needsUpdate=!0,this._resizeAttribute("normal",e.length);const a=this.getAttribute("normal");a.array.set(e,0),a.updateRange.count=e.length,a.needsUpdate=!0,this._resizeAttribute("uv",s.length);const l=this.getAttribute("uv");if(l.array.set(s,0),l.updateRange.count=s.length,l.needsUpdate=!0,n){this._resizeAttribute("uv2",n.length);const h=this.getAttribute("uv2");h.array.set(n,0),h.updateRange.count=n.length,h.needsUpdate=!0}this._resizeIndex(r.length);const c=this.getIndex();c.set(r,0),c.updateRange.count=r.length,c.needsUpdate=!0}}function $o(i,t,e=!1){const s=t.width||.1,n=t.progress!==void 0?t.progress:1,r=t.arrow!==void 0?t.arrow:!0,o=t.side!==void 0?t.side:"both",a=s/2,l=o!=="both"?s/2:s,c=i.distance(),h=n*c;if(c==0)return null;const u=a/l,d=a/c;let f=0;const g=[],v=[],p=[],m=[],y=[];let x=0;const b=new M,w=new M,E=new M,T=new M,A=new M,C=new M;function R(B){const N=g.length===0,H=B.sharp&&!N,J=B.dist/c,ne=B.dist/c,pe=B.dir,X=B.up,ys=B.right;if(o!=="left"?b.copy(ys).multiplyScalar(a*B.widthScale):b.set(0,0,0),o!=="right"?w.copy(ys).multiplyScalar(-a*B.widthScale):w.set(0,0,0),b.add(B.pos),w.add(B.pos),H){E.fromArray(g,g.length-6).sub(w),T.fromArray(g,g.length-3).sub(b);const ln=E.length(),Ws=T.length(),bs=ln-Ws;let xs,Pt;bs>0?(xs=E,Pt=w):(xs=T,Pt=b),A.copy(xs).setLength(Math.abs(bs)).add(Pt);let cn=C.copy(Pt).sub(A).normalize().dot(pe),un=C.copy(Pt).sub(A).length(),Ks=cn*un*2;C.copy(pe).setLength(Ks).add(A),bs>0?(g.push(A.x,A.y,A.z,b.x,b.y,b.z,w.x,w.y,w.z,b.x,b.y,b.z,C.x,C.y,C.z,b.x,b.y,b.z),x+=6,y.push(x-6,x-8,x-7,x-6,x-7,x-5,x-4,x-6,x-5,x-2,x-4,x-1),f+=12):(g.push(w.x,w.y,w.z,A.x,A.y,A.z,w.x,w.y,w.z,b.x,b.y,b.z,w.x,w.y,w.z,C.x,C.y,C.z),x+=6,y.push(x-6,x-8,x-7,x-6,x-7,x-5,x-6,x-5,x-3,x-2,x-3,x-1),f+=12),v.push(X.x,X.y,X.z,X.x,X.y,X.z,X.x,X.y,X.z,X.x,X.y,X.z,X.x,X.y,X.z,X.x,X.y,X.z),p.push(J-u,0,J-u,1,J,0,J,1,J+u,0,J+u,1),e&&m.push(ne-d,0,ne-d,1,ne,0,ne,1,ne+d,0,ne+d,1)}else g.push(w.x,w.y,w.z,b.x,b.y,b.z),v.push(X.x,X.y,X.z,X.x,X.y,X.z),p.push(J,0,J,1),e&&m.push(ne,0,ne,1),x+=2,N||(y.push(x-2,x-4,x-3,x-2,x-3,x-1),f+=6)}const L=new M;function _(B){const N=B.dir,H=B.up,J=B.right,ne=B.dist/l,pe=B.dist/c;o!=="left"?b.copy(J).multiplyScalar(a*2):b.set(0,0,0),o!=="right"?w.copy(J).multiplyScalar(-a*2):w.set(0,0,0),L.copy(N).setLength(a*3),b.add(B.pos),w.add(B.pos),L.add(B.pos),g.push(w.x,w.y,w.z,b.x,b.y,b.z,L.x,L.y,L.z),v.push(H.x,H.y,H.z,H.x,H.y,H.z,H.x,H.y,H.z),p.push(ne,o!=="both"?o!=="right"?-2:0:-.5,ne,o!=="both"?o!=="left"?2:0:1.5,ne+1.5,o!=="both"?0:.5),e&&m.push(pe,o!=="both"?o!=="right"?-2:0:-.5,pe,o!=="both"?o!=="left"?2:0:1.5,pe+1.5*s/c,o!=="both"?0:.5),x+=3,y.push(x-1,x-3,x-2),f+=3}let D;if(h>0)for(let B=0;B<i.count;B++){const N=i.array[B];if(N.dist>h){const H=i.array[B-1];D=new yc;const J=(h-H.dist)/(N.dist-H.dist);D.lerpPathPoints(H,N,J),R(D);break}else R(N)}else D=i.array[0];return r&&(D=D||i.array[i.count-1],_(D)),{position:g,normal:v,uv:p,uv2:m,indices:y,count:f}}var Yi,al,$i,ll,Zi,cl,Qi,ul;class sp extends de{constructor(e,s={}){super();z(this,Yi);z(this,$i);z(this,Zi);z(this,Qi);this.elapsedTime={value:0};const n={value:s.seg},r={value:s.modelPosition},o={time:this.elapsedTime,seg:n,position:r,uColor:s.uColor};this.geometry=Y(this,Yi,al).call(this,e),this.material=Y(this,$i,ll).call(this,o)}update(e){this.elapsedTime.value=e}}Yi=new WeakSet,al=function(e){const s=new M(0,1,0),n=new bc;n.set(e,.5,10,s,!1);const r=new tp;return r.update(n,{width:3.2,arrow:!1,side:"both"}),r},$i=new WeakSet,ll=function(e){return new Ee({uniforms:{uElapseTime:e.time,uSeg:e.seg,modelPosition:e.position,edgeColor:{value:new U("#fffffff")},uColor:{value:e.uColor||new U("#00DC3B")}},vertexShader:Y(this,Zi,cl).call(this),fragmentShader:Y(this,Qi,ul).call(this),side:ze,forceSinglePass:!0})},Zi=new WeakSet,cl=function(){return`
      uniform float uElapseTime;
      varying vec2 st;

      #include <common>
      #include <uv_pars_vertex>
      #include <normal_pars_vertex>
      #include <logdepthbuf_pars_vertex>

      void main() {
      	#include <uv_vertex>
      	#include <beginnormal_vertex>
      	#include <defaultnormal_vertex>
      	#include <normal_vertex>
      	#include <begin_vertex>
        st = uv;
      	#include <project_vertex>
      	#include <logdepthbuf_vertex>
      	#include <worldpos_vertex>
      }`},Qi=new WeakSet,ul=function(){return`
      uniform float uSeg;
      uniform float modelPosition;
      uniform vec3 uColor;
      uniform vec3 edgeColor;
    uniform float uElapseTime;
    varying vec2 st;


      void rotate2d(inout vec2 v, float a) {
       mat2 m = mat2(cos(a), -sin(a), sin(a), cos(a));
       v = m * v;
      }
       float arrow(vec2 av) {
        float line1L = 0.5;
         float line1 = length(av - vec2(clamp(av.x, -line1L, line1L), 0.));
         line1 = smoothstep(0.06, 0.05, line1);

         vec2 rav = av;
         rav.x -= line1L + 0.03;
         rotate2d(rav, 3.1415/1.54);

         float arrowL = 0.39;
         float line2 = length(rav - vec2(clamp(rav.x, 0., arrowL), 0.));
         line2 = smoothstep(0.06, 0.05, line2);

         rotate2d(rav, -3.1415 * 1.3 );
         float line3 = length(rav - vec2(clamp(rav.x, 0., arrowL),0.));
         line3 = smoothstep(0.06, 0.05, line3);

         return clamp(line2 + line3 , 0., 1.);
      }
    #include <common>
    #include <packing>
    #include <color_pars_fragment>
    #include <uv_pars_fragment>
    #include <normal_pars_fragment>
    #include <logdepthbuf_pars_fragment>
    #include <clipping_planes_pars_fragment>

    void main() {
    	#include <logdepthbuf_fragment>
    	#include <normal_fragment_begin>
    	#include <normal_fragment_maps>
     #include <dithering_fragment>

      float p = uSeg; //线段段数
      vec2 nst = (st * 2.0)-1.0;
      vec2 vSt = vec2(fract(nst.x * p- uElapseTime), nst.y);
          vec3 col;
          float a = arrow(vSt) ;
          vec3 cola = uColor;  //底色
          vec3 colb = edgeColor;
          col = mix(cola,colb,a);

          float al = 1.0;
          // float al = a;
          if(abs(0.5 - st.y) >= 0.4){
            float s = smoothstep(0.4, 0.5,abs(0.5 - st.y));
            col = mix(cola,colb,s);
            al = 1.0;
          }
          gl_FragColor = vec4(col,al);
    }
`};class ip{constructor(t,e){this.core=e,this.scene=t,this.cherryArray=[],this.path=[],this.gatherMap=new Map,this.realTimeMap=new Map,this.trackGroup=new Q,this.trackGroup.name="逃生路线",this.scene._add(this.trackGroup)}setCherryArray(t){this.cherryArray=t}cherryPick(){this.trackGroup.traverse(t=>{t instanceof de&&(t.visible=this.cherryArray.includes("escapeRoute"))}),this.cherryArray.includes("escapeRoute")?(this.core.core.postprocessing.setNoSelection(this.path),this.core.core.postprocessing.addOutline(this.path,1)):(this.core.core.postprocessing.clearOutline(this.path,1),this.core.core.postprocessing.clearNoSelection())}init(t){t.forEach(({id:e,data:s,name:n})=>{const r=s.map(l=>{let c=en({sceneType:1,originId:"",coordinate:l});return new M(c.x,c.y+.1,c.z)}),o=new xc(r);let a=new sp(r,{seg:Math.floor(o.getLength())/4});a.material.depthTest=!0,a.visible=this.cherryArray.includes("escapeRoute"),this.trackGroup.add(a),this.path.push(a)})}dispose(){[...this.path].forEach(t=>{t.deleteSelf()}),this.path=[],console.log(this.path,this.trackGroup),this.core.core.postprocessing.clearOutline(this.path,1)}update(t){this.path.forEach(e=>{e&&e.update(t.elapsedTime)})}}function Pi(i,t=[],e=!1,s=1){if(i instanceof de){const{geometry:n,material:r}=i,o=new wa(n,r,t.length);return o.instanceMatrix.setUsage(Is),!t||t.length===0?(console.error(`${i.name}:创建实例化对象，无位置信息`),new Q):(t.forEach((a,l)=>{const c=new ie;let h=1;if(Array.isArray(s)){const[u,d]=s;h=u+Math.random()*(d-u)}else h=parseFloat(s);if(c.makeScale(h,h,h),c.setPosition(a),e)if(e.length){const u=new ie().makeRotationFromEuler(e[l]);c.multiply(u)}else c.multiply(new ie().makeRotationY(Math.random()*Math.PI*2));o.setMatrixAt(l,c),o.castShadow=!0}),o)}else if(i instanceof Q){const n=new Q;return i.traverse(r=>{r instanceof de&&n.add(Pi(r,t,e,s))}),n}else{const n=new Q;return i.children.forEach(r=>{n.add(Pi(r,t,e,s))}),n}}const nt=i=>{const t=new le;t.setFromObject(i);const e=t.getCenter(new M),s=t.max.distanceTo(e);return{center:e,radius:s,min:t.min,max:t.max,boundingBox:t}},np=(i,t,e,s,n)=>{let r=document.createElement("div"),o=document.createElement("div");o.append(r),o.draggable=!1,o.className="beilu_three_Board_text_person",r.innerText=i;let a=Ce(o),l=null;return r.onclick=c=>{l&&(clearTimeout(l),l=null),l=setTimeout(()=>{t&&t(a,c),l=null},250)},r.ondblclick=c=>{l&&(clearTimeout(l),l=null),e&&e(a,c)},s&&(r.onmouseenter=c=>{s(a,c)}),n&&(r.onmouseleave=c=>{n(a,c)}),a},rp=(i,t=!1)=>{let e=document.createElement("div"),s=document.createElement("div");s.append(e),s.draggable=!1,s.className="buildingNum",e.innerText=i;let n=Ce(s);return n.visible=t,n},Zo=new F,Qo=new F;class op{constructor(t){O(this,"onmousedown",t=>{this.getMouse(t,Zo)});O(this,"onmouseup",t=>{if(this.getMouse(t,Qo),!!Zo.equals(Qo)){if(t.button===2){this.removeListener(),this.helper.active=!1,re.dispose(this.label,!0),this.label=null,this.addCloseButton(this.hitPoint);return}this.hitPoint&&(this.helper.addPoint(this.hitPoint),this.label&&(this.label.visible=this.helper.count!==0),this.createLabel2(this.hitPoint))}});O(this,"onkeyup",t=>{console.log("触发键盘操作"),t.key==="Escape"&&(this.helper.deletePoint(),this.updateLabel(),this.label.visible=this.helper.count!==0,re.dispose(this.labels.pop(),!0))});O(this,"getMouse",(t,e)=>{const{left:s,top:n,width:r,height:o}=this.core.domElement.getBoundingClientRect();e.x=(t.clientX-s)/r*2-1,e.y=-((t.clientY-n)/o)*2+1});O(this,"raycastOnmousemove",t=>{t.length?(this.hitPoint=t[0].point,this.helper.updateMoveLine(this.hitPoint),!this.label&&this.helper.count>0?this.createLabel():this.label&&this.updateLabel()):this.hitPoint=null});this.core=t.core,this.scene=t.scene,this.subsystem=t,this.active=!1,this.raycastObject=null,this.hitPoint=null,this.helper=new Sr(this.scene),this.core.onresizeQueue.set(Symbol(),this.helper.onresize),this.labels=[]}setRaycastObject(t){this.raycastObject=t}start(){this.active!==!0&&(this.active=!0,this.helper.active=!0,this.mousedownControls=this.core.addEventListener("mousedown"),this.mouseupControls=this.core.addEventListener("mouseup"),this.keyupControls=this.core.addEventListener("keyup"),this.mousedownControls.add(this.onmousedown),this.mouseupControls.add(this.onmouseup),this.keyupControls.add(this.onkeyup),this.raycastControls=this.core.raycast("mousemove",this.raycastObject,this.raycastOnmousemove))}removeListener(){console.log("触发移除监听"),this.helper.active===!0&&(this.helper.active=!1,this.mousedownControls.clear(),this.mouseupControls.clear(),this.keyupControls.clear(),this.raycastControls.clear())}end(){(this.active=!1)||(this.active=!1,this.removeListener(),this.helper.dispose(),re.dispose([this.label,this.labels],!0),this.labels.length=0,this.label=null)}createLabel(){const t=document.createElement("div");t.className="measure-container";const e=$e({innerText:"0m",className:"area-label"});t.appendChild(e),this.label=Ce(t),this.scene.add(this.label)}createLabel2(t){const e=document.createElement("div");e.className="measure-container";const s=this.helper.getTotalLength(2),n=$e({innerText:s+"m",className:"area-label"});e.appendChild(n);let r=Ce(e);r.position.set(t.x,t.y+10,t.z),this.labels.push(r),this.scene.add(r)}addCloseButton(t){const e=$e({innerText:"X",className:"measure-close"});this.labels[this.labels.length-1].element.appendChild(e),e.onclick=()=>{this.end(),this.start()}}updateLabel(){const t=this.label.element;if(t){const e=this.helper.getTotalLength(2);t.children[0].innerText=e+"m",this.hitPoint&&this.setLabelPosition(this.hitPoint)}}setLabelPosition(t,e=10){this.label.position.set(t.x,t.y+e,t.z)}}const Jo=new F,ea=new F;class ap{constructor(t){O(this,"onmousedown",t=>{this.getMouse(t,Jo)});O(this,"onmouseup",t=>{this.getMouse(t,ea),Jo.equals(ea)&&this.hitPoint&&(this.helper.addPoint(this.hitPoint),this.label&&(this.label.visible=this.helper.count!==0),this.helper.isClosed&&(this.removeListener(),this.setLabelData(this.helper.getArea(2)),this.setLabelPosition(this.helper.getCenter()),this.addCloseButton(this.hitPoint)))});O(this,"onkeyup",t=>{t.key==="Escape"&&(this.helper.deletePoint(),this.label.visible=this.helper.count!==0,this.updateLabel())});O(this,"getMouse",(t,e)=>{const{left:s,top:n,width:r,height:o}=this.core.domElement.getBoundingClientRect();e.x=(t.clientX-s)/r*2-1,e.y=-((t.clientY-n)/o)*2+1});O(this,"raycastOnmousemove",t=>{t.length?(this.hitPoint=t[0].point,this.helper.updateMoveLine(this.hitPoint),!this.label&&this.helper.count>0?this.createLabel():this.label&&this.updateLabel()):this.hitPoint=null});this.core=t.core,this.scene=t.scene,this.subsystem=t,this.active=!1,this.raycastObject=null,this.hitPoint=null,this.helper=new Sr(this.scene),this.helper.needToAdhereToFirstPoint=!0,this.helper.closestDistanceToAdhere=10,this.helper.needCheckLinesCross=!0,this.core.onresizeQueue.set(Symbol(),this.helper.onresize)}setRaycastObject(t){this.raycastObject=t}start(){this.active!==!0&&(this.active=!0,this.helper.active=!0,this.mousedownControls=this.core.addEventListener("mousedown"),this.mouseupControls=this.core.addEventListener("mouseup"),this.keyupControls=this.core.addEventListener("keyup"),this.mousedownControls.add(this.onmousedown),this.mouseupControls.add(this.onmouseup),this.keyupControls.add(this.onkeyup),this.raycastControls=this.core.raycast("mousemove",this.raycastObject,this.raycastOnmousemove))}removeListener(){this.helper.active===!0&&(this.helper.active=!1,this.mousedownControls.clear(),this.mouseupControls.clear(),this.keyupControls.clear(),this.raycastControls.clear())}end(){this.active!==!1&&(this.active=!1,this.removeListener(),this.helper.dispose(),this.label&&this.label.deleteSelf(),this.label=null)}createLabel(){const t=document.createElement("div");t.className="measure-container";const e=$e({innerText:"0m²",className:"area-label"});t.appendChild(e),this.label=Ce(t),this.scene.add(this.label)}updateLabel(){this.label.element&&this.setLabelPosition(this.hitPoint)}addCloseButton(t){const e=$e({innerText:"X",className:"measure-close"});this.label.element.appendChild(e),e.onclick=()=>{this.end(),this.start()}}setLabelPosition(t,e=20){this.label.position.set(t.x,t.y+e,t.z)}setLabelData(t){this.label.element&&(this.label.element.children[0].innerText=t+"m²")}}class lp{constructor(t,e){this.core=e,this.scene=t,this.fenceObj={},this.dangerFence=null,this.dangerFenceGroup=new Q,this.dangerFenceGroupName="dangerFence",this.scene._add(this.dangerFenceGroup),this.FenceGroup=new Q,this.FenceGroupName="FenceGroup",this.scene._add(this.FenceGroup),this.buildingFenceGroup=new Q,this.FenceGroupName="buildingFence",this.scene._add(this.buildingFenceGroup),this.textures=this.createTextures()}create(t){const{fenceData:e,id:s,name:n,type:r}=t;if(this.fenceObj[s])return console.log("围栏已存在"),!1;let o=[],a=[];e.map((y,x)=>{o.push([y.position.x,y.position.y,y.position.z]),x<e.length-1&&a.push(y.position)});const l=[],c=10,h=new Ht,u=[],d=[],f=o.reduce((y,x,b)=>{let w=0;if(b>0){let E=new M(...o[b-1]),T=new M(...x);w=E.distanceTo(T)}return y+=w,l.push(y),y},0);o.forEach((y,x)=>{if(x==0)return;const b=o[x-1];u.push(...b),d.push(l[x-1]/f,0),u.push(...y),d.push(l[x]/f,0),u.push(b[0],b[1]+c,b[2]),d.push(l[x-1]/f,1),u.push(...y),d.push(l[x]/f,0),u.push(y[0],y[1]+c,y[2]),d.push(l[x]/f,1),u.push(b[0],b[1]+c,b[2]),d.push(l[x-1]/f,1)}),h.setAttribute("position",new oe(new Float32Array(u),3)),h.setAttribute("uv",new oe(new Float32Array(d),2));const g=new Dt({map:this.textures[r],transparent:!0,opacity:1,depthWrite:!1,depthTest:!0,side:ze,forceSinglePass:!0}),v=new de(h,g);v.material.onBeforeCompile=y=>{const x=`
      vec3 outgoingLight = reflectedLight.indirectDiffuse;
      outgoingLight.xyz *= 1.8;
      `;y.fragmentShader=y.fragmentShader.replace("vec3 outgoingLight = reflectedLight.indirectDiffuse",x)};let p=this.getCenter(a),m=this.createLabel(n,p,this.boardClick.bind(this));r==="danger"&&(m=this.createDangerLabel(n,p,this.boardClick.bind(this))),m.position.set(p.x,16,p.z),r==="building"?(this.buildingFenceGroup.add(m),this.buildingFenceGroup.add(v),this.cameraMove(n)):r==="area"?(this.fenceObj[s]={mesh:v,label:m},this.FenceGroup.add(m),this.FenceGroup.add(v)):r==="danger"&&(this.dangerFence={mesh:v,label:m},this.dangerFenceGroup.add(m),this.dangerFenceGroup.add(v),this.core.tweenControl.lerpTo(p,50,1e3,new M(-40,40,0)))}getCenter(t,e=new M){const s=e;return t.forEach(n=>{s.addScaledVector(n,1/t.length)}),s}createTextures(){const t={danger:"/textures/areaNice/03.png",building:"/textures/areaNice/02.png",area:"/textures/areaNice/03.png"},e=new Ke,s={};return Reflect.ownKeys(t).forEach(r=>{const o=e.load(t[r]);o.wrapS=kt,o.wrapT=kt,o.repeat.set(-1,2),s[r]=o}),s}boardClick(t){this.core.tweenControl.lerpTo(t,50,1e3,new M(0,10,0))}createLabel(t,e,s){let n=document.createElement("img"),r=document.createElement("img");n.className="by_arrow_left",n.src="/textures/arrow_left.png",r.className="by_arrow_right",r.src="/textures/arrow_right.png";const o=$e({innerText:t,className:"by_label_b",children:[n,r]});return typeof s=="function"&&(o.onclick=()=>{s(e)}),Ce(o)}createDangerLabel(t,e,s){const n=$e({innerText:t,className:"by_label_b_danger"});return typeof s=="function"&&(n.onclick=()=>{s(e)}),Ce(n)}clearDangerFence(){this.dangerFence=null;for(let t=this.dangerFenceGroup.children.length-1;t>=0;t--)this.dangerFenceGroup.children[t].deleteSelf()}clearBuildingFence(){this.dangerFence=null;for(let t=this.buildingFenceGroup.children.length-1;t>=0;t--)this.buildingFenceGroup.children[t].deleteSelf()}clearFence(){this.fenceObj={};for(let t=this.FenceGroup.children.length-1;t>=0;t--)this.FenceGroup.children[t].deleteSelf()}initDangerFence(t){this.clearDangerFence(),this.create(t,!0)}dispose(){this.clearDangerFence(),this.clearFence(),this.clearBuildingFence()}update(){if(!this.textures)return!1;Reflect.ownKeys(this.textures).forEach(t=>{const e=this.textures[t];e.offset.y-=.01})}cameraMove(t){const e={化工分公司:{camera:{x:-337,y:857,z:616},controls:{x:-350,y:3,z:-306}},热电分公司:{camera:{x:-1033,y:666,z:-77},controls:{x:-1033,y:74,z:-543}},水泥有限公司:{camera:{x:-960,y:677,z:272},controls:{x:-960,y:-16,z:-93}}},s=e[t].camera,n=e[t].controls,r=this.core.camera,o=this.core.controls;return new Promise((a,l)=>{this.core.tweenControl.changeTo({start:r.position,end:s,duration:1e3,onComplete:()=>{o.enabled=!0,a()},onStart:()=>{o.enabled=!1}}),this.core.tweenControl.changeTo({start:o.target,end:n,duration:1e3,onUpdate:()=>{r.lookAt(o.target)}})})}}function cp(){return new Ee({transparent:!0,vertexShader:up,fragmentShader:hp,side:ze,uniforms:{uTime:wc,uStyle:ct}})}const up=`
#include <logdepthbuf_pars_vertex>
#include <common>
${Ea}
varying vec2 st;

void main(){
  st = uv;

  #include <begin_vertex>
  #include <project_vertex>
  #include <logdepthbuf_vertex>
}
`,hp=`

${Ea}
varying vec2 st;
uniform float uTime;
uniform float uStyle;
#define TAU 6.28318530718
#define MAX_ITER 5


#include <logdepthbuf_pars_fragment>
void main() {


  float time = uTime * .5+23.0;

  vec2 q = st * 0.3;
      vec2 p = mod(q*TAU, TAU)-250.0;

   vec2 i = vec2(p);
   float c = 1.0;
   float inten = .005;

   for (int n = 0; n < MAX_ITER; n++)
   {
    float t = time * (1.0 - (3.5 / float(n+1)));
    i = p + vec2(cos(t - i.x) + sin(t + i.y), sin(t - i.y) + cos(t + i.x));
    c += 1.0/length(vec2(p.x / (sin(i.x+t)/inten),p.y / (cos(i.y+t)/inten)));
   }
   c /= float(MAX_ITER);
   c = 1.17-pow(c, 1.4);
   vec3 color = vec3(pow(abs(c), 8.0));
      color = clamp(color + vec3(0.0, 0.35, 0.5), 0.0, 1.0);

   if(uStyle == ${Sc}.){
     gl_FragColor = vec4(color, 0.4);
   }else if(uStyle == ${Tc}.){
    gl_FragColor = vec4(color*0.1,0.4);
   }

   ${Ec}
 #include <logdepthbuf_fragment>
}
`;function dp(i,t={value:0},e=new U(16776960),s){const n={uTime:t,uColor:e,num:s};i.onBeforeCompile=r=>{_e(r,"gatherFenceEffect",n)}}function fp(i,t=1800,e=3e3){const s={fade:t,land:e};i.onBeforeCompile=n=>{_e(n,"edgeFadeDis",s)}}function pp(i,t=10){const e={strength:t};i.onBeforeCompile=s=>{_e(s,"brighten",e)}}function mp(i,t=10){const e={strength:t,uStyle:ct};i.onBeforeCompile=s=>{_e(s,"brightenNight",e)}}function gp(i,t){const e={uTime:t};i.onBeforeCompile=s=>{_e(s,"fadeByTime",e)}}function vp(i,t,e=new U("#3acacc")){const s={uTime:t,uBox:Ac,lightIndex:Mc,uColor:e};i.onBeforeCompile=n=>{_e(n,"dynamicFade",s)}}function yp(i){const t={uStyle:ct};i.onBeforeCompile=e=>{_e(e,"glassEffect",t)}}function ta(i,t=new U("#59FFD3")){const e={uStyle:ct,uColor:t};i.onBeforeCompile=s=>{_e(s,"treeModify",e)}}function bp(i,t=.9){const e={uStyle:ct,uSpeed:t};i.onBeforeCompile=s=>{_e(s,"pathFlow",e)}}function ge(i,t=new U("#59FFD3")){const e={uStyle:ct,uColor:t};i.onBeforeCompile=s=>{_e(s,"sci_colorModify",e)}}function pt(i,t=10){const e={uStyle:ct,strength:t};i.onBeforeCompile=s=>{_e(s,"sci_brighten",e)}}function Ls(i,t=new U("#59FFD3"),e=1600,s=2800){const n={uStyle:ct,fade:e,land:s,uColor:t};i.onBeforeCompile=r=>{_e(r,"sci_outerLand",n)}}function sa(i,t=5.5){const e={uStyle:ct,strength:t};i.onBeforeCompile=s=>{_e(s,"sci_playground",e)}}function xp(i,t=.5){const e=new Ke().load("./textures/water_normal.jpg");e.wrapS=e.wrapT=kt,i.normalMap=e,i.normalScale.set(t,t)}function wp(i){const t=i.core,e=t.camera,s=t.controls;let n;function r(){clearTimeout(n),s.autoRotate=!1,s.rotateSpeed=1,n=setTimeout(()=>{s.target.copy(Ri.Default.target),e.position.copy(Ri.Default.position),s.autoRotate=!0,s.rotateSpeed=.01},i.roamDuration*1e3)}function o(){i.core.domElement.addEventListener("mousemove",r)}function a(){i.core.domElement.removeEventListener("mousemove",r),clearTimeout(n)}const l=()=>({begin:o,updateCameraState:r,stop:a});return i.useCameraState=l,l}const Sp=cp();function Tp(i,t){const e=t.onRenderQueue||t.core.onRenderQueue,s=i.material;if(s.name.includes("镜面水")){i.visible=!1;const n=new le;n.setFromObject(i);const r=new Cc(n,100,100),o=r.mesh;i.getWorldPosition(o.position),o.rotation.z=i.rotation.y,e.set(Symbol(),r.update.bind(r)),t.add(o)}else s.name.includes("水")&&(i.material=Sp);s.name.includes("漆面")&&(s.roughness=.5,s.metalness=.5,xp(s,.1)),s.name.includes("夜光玻璃")?(s.transparent=!0,yp(s)):s.name.includes("夜光")?mp(s,20):s.name.includes("发光")&&(pp(s,10),i.castShadow=!1,t.bloomLights.push(i)),s.name.includes("边缘虚化")&&(s.transparent=!0,fp(s,1600,2800)),s.needsUpdate=!0}function Ep(i,t,e){i.isMesh&&(Ap(i,t,e),Tp(i,e))}function Ap(i,t,e){const s=i.material;t==="其他模型"&&i.name.includes("地块区域建筑3_32")&&pt(i.material,10),t==="杂项"&&(s.name==="车流线"&&(i.material.transparent=!0,bp(i.material),e.postprocessing.addBloom(i)),s.name==="球场灯带"&&(pt(i.material),e.postprocessing.addBloom(i)),s.name==="生活区标识灯"&&pt(i.material,10),s.name==="造型灯-白色"&&pt(i.material,10)),t==="外地形"&&(s.transparent=!0,["外场景地面_9"].includes(i.name)&&Ls(i.material,new U("#00010F")),["外场景地面_4"].includes(i.name)&&Ls(i.material,new U("#020418")),["外场景地面_5"].includes(i.name)&&Ls(i.material,new U("#1B56C7")),["外场景地面_6","外场景地面_7","外场景地面_8"].includes(i.name)&&Ls(i.material,new U("#000E12")),["外场景地面_3","外场景地面_2","外场景地面_1"].includes(i.name)&&Ls(i.material,new U("#04142E"))),t==="内地形"&&(i.name.includes("内部地面绿化")&&(i.name.includes("_2")?ge(i.material,new U("#86E0E3")):i.name.includes("_4")?ge(i.material,new U("#43a0e8")):i.name.includes("_5")?ge(i.material,new U("#030d2e")):i.name.includes("_6")?ge(i.material,new U("#030d2e")):ge(i.material,new U("#0C1F12"))),i.name.includes("主道路")&&(["主道路_1","主道路_6","主道路_2","主道路_5","主道路_9"].includes(i.name)&&ge(i.material,new U("#000E12")),["主道路_8"].includes(i.name)&&pt(i.material,.5)),i.name.includes("道路标线")&&pt(i.material,10),["地面_13"].includes(i.name)&&sa(i.material),["地面_14","地面_15"].includes(i.name)&&sa(i.material,3),["地面_1"].includes(i.name)&&ge(i.material,new U("#0D1A21")),["地面_11","地面_2"].includes(i.name)&&(ge(i.material,new U("#020627")),new U("#04142E")),["地面_4","地面_17"].includes(i.name)&&ge(i.material,new U("#04142E")),["地面_23"].includes(i.name)&&pt(i.material,10),["地面_20"].includes(i.name)&&ge(i.material,new U("#020418")),["地面_19"].includes(i.name)&&ge(i.material,new U("#1B56C7")),["地面_21"].includes(i.name)&&ge(i.material,new U("#0C1F12")),["地面_12"].includes(i.name)&&ge(i.material,new U("#630402")),["地面_6"].includes(i.name)&&ge(i.material,new U("#0c2c96")),["地面_5"].includes(i.name)&&ge(i.material,new U("#030d2e")),["地面_16"].includes(i.name)&&ge(i.material,new U("#2de84c"))),t==="杂项"&&i.name==="道路名称"&&pt(i.material,20),t==="树"&&(["shu3_2","shu4_2"].includes(i.name)||i.name.includes("_1"))&&ta(i.material)}class Mp{constructor(t,e){this.core=e,this.scene=t,this.fenceObj={},this.FenceGroup=new Q,this.FenceGroupName="FenceGroup",this.scene._add(this.FenceGroup),this.elapsedTime={value:0},this.gatherColor={green:new U("#00DC3B"),yellow:new U("#FFBC00")},this.gatherModelColor={green:new U(0,.2,0),yellow:new U(.2,.2,0)},this.textures=this.createShaders()}create(t){const{id:e,type:s,areaType:n,areaDataOut:r,areaDataBuilding:o,areaName:a}=t;if(this.fenceObj[e])return console.log("围栏已存在"),!1;let l=s===1?"green":"yellow";if(n===1){let c=[],h=[],u=[];r.map((T,A)=>{let C=en({sceneType:1,originId:"",coordinate:T});c.push([C.x,C.y,C.z]),u.push(C.x,C.y,C.z),A<r.length-1&&h.push(C)});const d=[];let f=this.createLine(u,l);const g=10,v=new Ht,p=[],m=[],y=c.reduce((T,A,C)=>{let R=0;if(C>0){let L=new M(...c[C-1]),_=new M(...A);R=L.distanceTo(_)}return T+=R,d.push(T),T},0);c.forEach((T,A)=>{if(A==0)return;const C=c[A-1];p.push(...C),m.push(d[A-1]/y,0),p.push(...T),m.push(d[A]/y,0),p.push(C[0],C[1]+g,C[2]),m.push(d[A-1]/y,1),p.push(...T),m.push(d[A]/y,0),p.push(T[0],T[1]+g,T[2]),m.push(d[A]/y,1),p.push(C[0],C[1]+g,C[2]),m.push(d[A-1]/y,1)}),v.setAttribute("position",new oe(new Float32Array(p),3)),v.setAttribute("uv",new oe(new Float32Array(m),2));const x=this.textures[l],b=new de(v,x);b.renderOrder=32;let w=this.getCenter(h),E=this.createLabel(a,w,this.boardClick.bind(this),s);E.position.set(w.x,16,w.z),this.fenceObj[e]={object3d:b,label:E,type:"fence",line:f},this.FenceGroup.add(E),this.FenceGroup.add(b),this.FenceGroup.add(f)}if(n===2){let c=this.core.singleBuildingGroup,h=this.core.buildingMeshObj;if(!c[o]&&!h[o])return console.log("楼栋信息在三维场景中不在");let u=c[o]||h[o],d=this.gatherModel(u,s,a);this.fenceObj[e]={object3d:u,label:d,type:"geometry"},this.FenceGroup.add(d)}console.log(this.FenceGroup,this.core,"FenceGroup")}createLine(t,e){let s=new an({color:this.gatherColor[e],linewidth:5,dashed:!1,depthTest:!1});s.resolution.set(window.innerWidth,window.innerHeight);const n=new Hs;n.setPositions(t);let r=new ir(n,s);return r.computeLineDistances(),r.scale.set(1,1,1),r}gatherModel(t,e,s){let n=e===1?"green":"yellow";t.traverse(c=>{if(c instanceof de)if(c.material.length){let h=[];c.material.map(u=>{let d=u.clone();d.transparent=!0,d.opacity=.88,d.emissive=this.gatherModelColor[n],h.push(d)}),c.oldMaterial=c.material,c.material=h}else{let h=c.material.clone();h.transparent=!0,h.opacity=.88,h.emissive=this.gatherModelColor[n],c.oldMaterial=c.material,c.material=h}});const{center:r,max:o}=nt(t),a=new M(r.x,o.y,r.z);let l=this.createLabel(s,a,this.boardClick.bind(this),e);return l.position.set(a.x,a.y+8,a.z),l}getCenter(t,e=new M){const s=e;return t.forEach(n=>{s.addScaledVector(n,1/t.length)}),s}createShaders(){const t={green:this.gatherColor.green,yellow:this.gatherColor.yellow};let e={};return Object.entries(t).forEach(([s,n])=>{let r=new mr({side:ze,transparent:!0,depthTest:!0,depthWrite:!1,blending:_c});dp(r,this.elapsedTime,n,{value:2}),e[s]=r}),e}boardClick(t){this.core.tweenControl.lerpTo(t,50,1e3,new M(0,10,0))}createLabel(t,e,s,n){let r=document.getElementById("statusBoard").cloneNode(!0);return r.innerText=t,n===2&&(r.className="yellowArea"),typeof s=="function"&&(r.onclick=()=>{s(e)}),Ce(r)}clearGeometryGather(t){t.traverse(e=>{e instanceof de&&(e.material=e.oldMaterial,delete e.oldMaterial)})}clearFence(){Object.values(this.fenceObj).forEach(t=>{t.type==="fence"&&(t.object3d.deleteSelf(),t.label.deleteSelf(),t.line.deleteSelf()),t.type==="geometry"&&(t.label.deleteSelf(),this.clearGeometryGather(t.object3d)),this.FenceGroup.children.forEach(e=>{e.removeFromParent()}),this.fenceObj={}})}dispose(){this.clearFence()}changeDomVisible(t){Object.values(this.fenceObj).forEach(e=>{e.label.element.style.display=t?"block":"none"})}update(t){Object.values(this.fenceObj).length&&(this.core.core.sceneType===0&&this.changeDomVisible(!1),this.core.core.sceneType===1&&this.changeDomVisible(!0))}}class Cp{constructor(t,e){this.core=e,this.scene=t,this.cherryArray=[],this.spriteObject={},this.equipSprite=this.generateLabel("/equip/road.png"),this.equipGroup=new Q,this.scene._add(this.equipGroup)}setCherryArray(t){this.cherryArray=t}cherryPick(){this.equipGroup.traverse(t=>{t instanceof Ci&&(t.visible=this.cherryArray.includes("meetingPoint"))})}create(t){const{id:e,position:s,name:n}=t;if(this.spriteObject[e])return console.log("集合点已存在"),!1;let r=this.equipSprite.clone();r.name=n;let o=en({sceneType:1,originId:"",coordinate:s});r.position.set(o.x,o.y,o.z),r.visible=this.cherryArray.includes("meetingPoint"),this.spriteObject[e]=r,this.equipGroup.add(r)}generateLabel(t,e=.048){const s=new Ke().load(t),n=new pr({map:s,sizeAttenuation:!1,depthTest:!1,depthWrite:!1}),r=new Ci(n);return r.renderOrder=1,r.scale.set(e,e,e),r.center=new F(.5,0),r}dispose(){this.clearFence()}update(t){}}const _p=["1楼_外壳.glb","2楼_外壳.glb","3楼_外壳.glb","其他.glb","地面.glb","塔-信号发射器.glb","柴油发电机房_外壳.glb","车.glb"],Pp=["1楼","2楼","柴油发电机房"];class ia{constructor(){this.element=null,this.css2dObject=null,this.isVisible=!1,this.createTooltip()}createTooltip(){const t=document.createElement("div");t.className="building-tooltip-container",t.style.cssText=`
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
      transform: translate(-50%, -100%);
      margin-top: -8px;
    `;const e=document.createElement("div");e.innerHTML="双击进入室内，单击拉近视角",t.appendChild(e);const s=document.createElement("div");s.style.cssText=`
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid rgba(0, 0, 0, 0.8);
    `,t.appendChild(s),this.element=t,this.css2dObject=Ce(t),this.css2dObject.visible=!1}show(t){this.isVisible||(this.css2dObject.position.copy(t),this.css2dObject.visible=!0,this.element.style.opacity="1",this.isVisible=!0)}hide(){this.isVisible&&(this.element.style.opacity="0",setTimeout(()=>{this.css2dObject.visible=!1,this.isVisible=!1},200))}updatePosition(t){this.isVisible&&this.css2dObject.position.copy(t)}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.css2dObject=null}}class lr{constructor(){this.element=null,this.isVisible=!1,this.createHint()}createHint(){const t=document.createElement("div");t.className="scene-hint-container",t.style.cssText=`
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      background: rgba(0, 0, 0, 0.8) !important;
      color: white !important;
      padding: 12px 16px !important;
      border-radius: 8px !important;
      font-size: 14px !important;
      white-space: nowrap !important;
      pointer-events: none !important;
      z-index: 9999 !important;
      opacity: 0 !important;
      transition: opacity 0.3s ease !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      backdrop-filter: blur(4px) !important;
      font-family: Arial, sans-serif !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
      display: block !important;
      visibility: visible !important;
      height: auto !important;
      width: auto !important;
      overflow: visible !important;
      transform: none !important;
    `;const e=document.createElement("div");e.innerHTML="右键双击恢复默认视角",t.appendChild(e),document.body.appendChild(t),this.element=t,console.log("SceneHint created:",t),setTimeout(()=>{this.element&&(this.element.style.opacity="1",this.isVisible=!0,console.log("SceneHint force shown"))},100)}show(t){this.element&&(this.element.querySelector("div").innerHTML=t,this.element.style.opacity="1",this.isVisible=!0,console.log("SceneHint shown:",t))}hide(){this.element&&this.isVisible&&(this.element.style.opacity="0",this.isVisible=!1,console.log("SceneHint hidden"))}updateMessage(t){this.element&&(this.element.querySelector("div").innerHTML=t,console.log("SceneHint message updated:",t))}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,console.log("SceneHint destroyed")}}class Rp{constructor(){this.mixer=null,this.actions=new Map,this.clock=new pa,this.isPlaying=!1}init(t){this.mixer=t,this.clock.start()}addAction(t,e){e&&(this.actions.set(t,e),e.setLoop(Dc),e.clampWhenFinished=!0)}play(t){const e=this.actions.get(t);e&&(e.reset(),e.play(),this.isPlaying=!0)}stop(t){const e=this.actions.get(t);e&&(e.stop(),this.isPlaying=!1)}update(){this.mixer&&this.isPlaying&&this.mixer.update(this.clock.getDelta())}}const Lp=Symbol(),na=Symbol(),hl=new M,Dp=new Ct(hl,2880),Bp=new Ct(hl,2880),kn={maxPolarAngle:Math.PI/2};class Ip extends sl{constructor(e){super(e);O(this,"limitCameraInSphere",()=>{this.controls.enableRotate&&(this.camera.position.clampSphere(Dp),this.controls.target.clampSphere(Bp),this.camera.position.y=this.camera.position.y<this.altitude?this.altitude:this.camera.position.y,this.controls.target.y=this.controls.target.y<this.altitude?this.altitude:this.controls.target.y)});O(this,"boardClick",e=>{const s=new M(2,2,0);this.tweenControl.lerpTo(e.position,20,1e3,s)});this.tweenControl=e.tweenControl,this.scene.background=Aa,this.onRenderQueue=e.onRenderQueue,this.controls=e.controls,this.baseCamera=e.baseCamera,this.camera=e.camera,this.orientation=e.orientation,this.boxSelect=e.orientation.boxSelect,this.postprocessing=e.postprocessing,this.outBuildingGroup=new Q,this.outBuildingGroup.name="outBuildingGroup",this._add(this.outBuildingGroup),this.buildingMeshArr=[],this.buildingMeshObj={},this.buildingNames=Pp,this.bloomLights=[],this.buildingNameLabelMap={},this.buildingNum={},this.singleBuildingGroup={},this.labelGroup=new Q,this.labelGroup.name="labelGroupHome",this._add(this.labelGroup),this.groundMesh=null,this.fencePlate=null,this.gatherOrSilentPlate=null,this.eventClear=[],this.pointerArr=[],this.isLoaded=!1,this.searchBuildingId=null,this.roamEnabled=!1,this.roamDuration=10,this.filterBuildingArr=["buildingBoard"],this.boxSelectStatus=!1,this.instancedMesh=[],this.altitude=-20,this.modelList=[],this.modelGroup=new Q,this.scene.add(this.modelGroup),this.loadedModels=new Map,this.animationManager=new Rp,this.tooltip=new ia,this.labelGroup.add(this.tooltip.css2dObject),this.sceneHint=new lr,this.init()}async init(){console.log("Ground system initializing...");try{const e=_p.map(s=>({name:s.replace(".glb",""),path:`./models/outDoor/${s}`,type:".glb"}));console.log("Loading models with configs:",e),this.initLight(),await ol(e,(s,n)=>{if(!s||!s.scene){console.error(`❌ 模型加载失败: ${n} - 无效的模型数据`);return}console.log(`✅ 成功加载模型: ${n}`),this.onProgress(s,n)},()=>{console.log("✅ 所有模型加载完成"),this.onLoaded()}),this.fencePlate=new lp(this.scene,this),this.escapeRoute=new ip(this.scene,this),this.gatherOrSilentPlate=new Mp(this.scene,this),this.meetingPoint=new Cp(this.scene,this),console.log("Creating Weather instance with this:",this),console.log("Ground scene:",this.scene),this.weather=new Pc(this),console.log("Weather instance created:",this.weather),this.measureDistance=new op(this),this.measureArea=new ap(this),this.core&&this.core.onRenderQueue&&(this.core.onRenderQueue.set(Lp,this.update.bind(this)),this.gatherOrSilentPlate&&this.core.onRenderQueue.set("gatherOrSilentFence",this.gatherOrSilentPlate.update.bind(this.gatherOrSilentPlate)),this.escapeRoute&&this.core.onRenderQueue.set("escapeRoute",this.escapeRoute.update.bind(this.escapeRoute)))}catch(e){throw console.error("❌ 加载模型时出错:",e),e.response&&(console.error("响应状态:",e.response.status),console.error("响应头:",e.response.headers)),e}}handleControls(){this.controls.addEventListener("change",this.limitCameraInSphere),Reflect.ownKeys(kn).forEach(e=>{this.controls.data[e]=this.controls[e],this.controls[e]=kn[e]})}resetControls(){this.controls.removeEventListener("change",this.limitCameraInSphere),Reflect.ownKeys(kn).forEach(e=>{this.controls[e]=this.controls.data[e]})}setCameraState(e){if(!this.useCameraState)return;const{begin:s,updateCameraState:n,stop:r}=this.useCameraState();n(this.roamDuration),e&&this.core.currentSystem===this?s():r()}addEventListener(){if(this.eventClear.length>0)return;let e=this.core.raycast("dblclick",this.buildingMeshArr,r=>{if(r.length){let a=r[0].object;for(;a.parent&&!this.buildingNames.some(l=>a.name.includes(l));)a=a.parent;!this.boxSelectStatus&&this.buildingNames.some(l=>a.name.includes(l))&&(kd(a.name.split("_")[0]),this.core.changeSystem("indoorSubsystem",a.name.split("_")[0]))}});this.addGroundEvent();let s=this.core.rightDblClickListener(()=>{this.resetCamera()});this.eventClear.push(e.clear),this.eventClear.push(s),Object.values(this.buildingNum).forEach(r=>{r.element.onclick=()=>this.buildingNumClick(r.name)});const n=this.core.raycast("dblclick",this.groundMesh,r=>{r.length&&!this.boxSelectStatus&&this.tweenControl.lerpTo(r[0].point,50,1e3,new M(0,10,0))});this.eventClear.push(n.clear)}groundClickEvent(e){let s=e.intersectObjects(this.buildingMeshArr);if(s.length){const n=s[0].object;n.userData.buildingName&&this.commonSearchBuilding(n.userData.buildingName)}}addGroundEvent(){this.core.addClickCustom(this.groundClickEvent.bind(this));let e=this.core.raycast("mousemove",this.buildingMeshArr,n=>{if(!(this.core.elapsedTime*10&1))if(n.length){const r=n[0].object;if(r.userData.buildingName){this.postprocessing.clearOutlineAll(1);const o=this.buildingMeshObj[this.searchBuildingId],a=this.buildingMeshArr.filter(c=>c.userData.buildingName===r.userData.buildingName);a.length>0&&this.postprocessing.addOutline([...a,o],1);const l=r.userData.buildingName;if(this.buildingNames.some(c=>l.includes(c))){const c=new M;r.getWorldPosition(c),c.y+=10,this.tooltip.show(c)}}}else{if(this.postprocessing.clearOutlineAll(1),this.searchBuildingId){let r=this.buildingMeshObj[this.searchBuildingId];this.postprocessing.addOutline(r,1)}this.tooltip.hide()}}),s=this.core.raycast("mousemove",this.orientation.orientation3D.pointerArr,n=>{n.length?document.body.style.cursor="pointer":document.body.style.cursor="auto"});this.eventClear.push(s.clear),this.eventClear.push(e.clear)}onEnter(){debugger;this.weather&&this.weather.resetComposer(this.weather.lightingPattern),this.handleControls(),q.onLoad(this,this.core),this.boxSelect.onLoad(this),this.filterBuildingNum(),this.tooltip||(this.tooltip=new ia,this.labelGroup.add(this.tooltip.css2dObject)),this.sceneHint.show("右键双击恢复默认视角"),this.groundMesh&&(this.onLoaded(),this.isLoaded=!0)}initDangerFence(e){this.fencePlate.initDangerFence(e)}hideBuildingLabel(e=this.searchBuildingId){let s=e||this.searchBuildingId;if(!s)return!1;this.buildingNameLabelMap[s].visible=!1,this.buildingNameLabelMap[s].element.style.display="none",this.searchBuildingId=null,this.postprocessing.clearOutlineAll(1)}hideAllBuildingLabel(){Object.values(this.buildingNameLabelMap).map(e=>{e.visible=!1,e.element.style.display="none"}),Object.values(this.buildingNum).forEach(e=>{e.traverse(s=>{s.visible=!1,e.element.style.display="none"})}),this.searchBuildingId=null,this.tooltip&&this.tooltip.hide()}clearDangerFence(){this.fencePlate.clearDangerFence()}clearBuildingFence(){this.fencePlate.clearBuildingFence()}changeWeather(e){this.weather.setWeather(e.type,e.level)}switchWeather(e){this.weather.switchWeather(e)}updateLightingPattern(e){this.weather.updateLightingPattern(e)}historyTrackCommand(e){e.cmd==="trackInit"&&(this.orientation.orientation3D.hiddenAllPerson=!0,this.orientation.updateModules(),this.removeEventListener(),this.postprocessing.clearOutlineAll()),e.cmd==="trackClear"&&(this.removeEventListener(),this.historyTrack.path||this.addEventListener(),this.orientation.orientation3D.hiddenAllPerson=!1,this.orientation.updateModules()),this.historyTrack.command(e)}startMeasuring(){this.removeEventListener(),this.measureDistance.start()}removeMeasuring(){this.measureDistance.end(),this.addEventListener(),this.resetCamera()}startMeasureArea(){this.removeEventListener(),this.measureArea.start()}removeMeasureArea(){this.measureArea.end(),this.addEventListener(),this.resetCamera()}changeBoxSelect(e){this.boxSelectStatus=e,e?(this.removeEventListener(),this.boxSelect.start()):(this.boxSelect.end(),this.addEventListener(),this.resetCamera())}searchBuilding(e=!0){e&&Ud(this.searchBuildingId);let s=this.buildingNameLabelMap[this.searchBuildingId];this.boardClick(s),this.postprocessing.clearOutlineAll(1);let n=this.buildingMeshObj[this.searchBuildingId];this.postprocessing.addOutline(n,1)}createFence(e){this.fencePlate.create(e)}clearFence(){this.fencePlate.dispose()}onProgress(e,s){if(this.core.scene!==this.scene)return;const n=e.scene;if(s==="地面"){const{min:r,max:o}=nt(n);if(this.altitude=r.y,n.traverse(a=>{a.isMesh&&(a.receiveShadow=!0)}),this.groundMesh=n,this.weather){const l=new le(new M(r.x-100,r.y,r.z-100),new M(o.x+100,o.y+500,o.z+100));this.weather.setBoundingBox(l)}}if(this.buildingNames&&this.buildingNames.some(r=>s.includes(r))&&(n.name=s,this.outBuildingGroup.add(n),n.traverse(r=>{r.isMesh&&(r.castShadow=!0,r.receiveShadow=!0,this.buildingMeshArr.push(r),this.buildingMeshObj[r.name]=r,r.userData.buildingName=s)}),this.setBuildingBoard(n)),e.animations&&e.animations.length>0){const r=new Rc(n);this.animationManager.init(r),e.animations.forEach(o=>{const a=r.clipAction(o);this.animationManager.addAction(o.name,a)}),e.animations.length>0&&this.animationManager.play(e.animations[0].name)}this._add(n)}materialClone(e,s){if(e.isMesh){const n=e.material.name;if(s[n])e.material=s[n];else{const r=e.material.clone();s[n]=r,e.material=r}e.material.originTransparent=e.material.transparent}}setBuildingBoard(e){const{center:s,max:n}=nt(e),r=new M(s.x,n.y,s.z),o=e.name,a=Yo[o],l=np(a,h=>{this.cameraMoveToBuildingTitle(o)},h=>{this.core.changeSystem("indoorSubsystem",o.split("_")[0])},h=>{if(this.buildingNames.some(u=>o.includes(u))){const u=h.position.clone();u.y+=5,this.tooltip.show(u)}},h=>{this.tooltip&&this.tooltip.hide()});l.visible=!0,l.position.copy(r),this.labelGroup.add(l),this.buildingNameLabelMap[o]=l;const c=rp(0,!1);c.position.copy(r),c.scale.set(.2,.2,.2),c.name=o,this.labelGroup.add(c),this.buildingNum[o]=c}setFilterBuilding(e){this.filterBuildingArr.length=0,this.filterBuildingArr=e}filterBuildingNum(){const e=this.filterBuildingArr.includes("buildingBoard");Object.values(this.buildingNum).forEach(s=>{s.traverse(n=>{n.visible=e,n.visible=parseInt(n.element.innerText)>0?e:!1})})}cameraMoveToBuildingTitle(e){this.commonSearchBuilding(e)}commonSearchBuilding(e){console.log(e,"id"),this.searchBuildingId=e,this.searchBuilding(),this.removeEventListener(),this.addEventListener()}buildingNumClick(e){Hd(e)}changeBuildingNumber(e){e.map(s=>{const{id:n,number:r}=s;if(!Yo[n]||!this.buildingNum[n])return!1;this.buildingNum[n].element.innerText=String(r),this.buildingNum[n].visible=r>0&&this.filterBuildingArr.includes("buildingBoard")})}showSingleBuildingBoard(e){Object.entries(this.buildingNameLabelMap).map(([s,n])=>{s===e?n.visible=!0:n.visible=!1})}onLeave(){this.weather.resetComposer(),this.hideAllBuildingLabel(),this.resetControls(),this.setCameraState(!1),this.core.onRenderQueue.delete(na),this.measureArea.end(),this.measureDistance.end(),this.boxSelect.end(),this.removeEventListener(),document.body.style.cursor="auto",this.tooltip&&(this.tooltip.hide(),this.tooltip.destroy(),this.tooltip=null),this.sceneHint&&this.sceneHint.hide(),console.log("离开地面广场系统")}onLoaded(){this.useCameraState||wp(this),this.roamEnabled&&this.setCameraState(!0),this.instancedMesh&&this.instancedMesh.length>0&&this.instancedMesh.forEach(e=>{e&&e instanceof ve&&this._add(e)}),console.log("All models loaded successfully"),this.addEventListener(),Va("home"),this.resetCamera(1500).then(()=>{this.core&&this.core.crossSearch&&this.core.crossSearch.changeSceneSearch(),super.updateOrientation()}),this.fencePlate&&this.core.onRenderQueue.set(na,this.fencePlate.update.bind(this.fencePlate)),this.measureArea&&this.groundMesh&&this.measureArea.setRaycastObject(this.groundMesh),this.boxSelect&&this.groundMesh&&this.boxSelect.setRaycastObject(this.groundMesh),this.measureDistance&&this.groundMesh&&this.measureDistance.setRaycastObject(this.groundMesh)}removeEventListener(){this.eventClear.forEach(e=>e()),this.eventClear=[]}update(){this.animationManager.update()}loadInstancedModel(e,s,n){const r=new Q,o={},a={},l={},c=new M;function h(u){u.getWorldPosition(c);const d=u.name.split("_")[0];a[d]=a[d]||[],a[d].push(c.clone()),l[d]=l[d]||[],l[d].push(u.rotation)}return e.forEach(u=>{u.name.includes("zuobiao")&&u.traverse(d=>{h(d)}),u.name.includes("shili")&&u.children.forEach(d=>{o[d.name]=d,d.name.includes("shu")&&d.traverse(f=>{f instanceof de&&(f.material=new Lc({map:f.material.map}),Ep(f,"树",this))})})}),Object.keys(o).forEach(u=>{const d=o[u];let f;u.indexOf("shu")!==-1?f=Pi(d,a[u],!0,n):f=Pi(d,a[u],l[u],n),r.add(f),f instanceof Q?f.traverse(s):s(f)}),r}resetCamera(e=1e3){if(!this.groundMesh)return console.warn("地面模型未加载，无法重置相机"),Promise.resolve();const{radius:s}=nt(this.groundMesh),n=new M(0,0,0),r=new M(n.x,n.y+s/4,n.z+s*.68),o=n.clone();return new Promise((a,l)=>{r.distanceTo(this.camera.position)<5&&o.distanceTo(this.controls.target)<5&&a(),this.tweenControl.changeTo({start:this.camera.position,end:r,duration:e,onComplete:()=>{this.controls.enabled=!0,a()},onStart:()=>{this.controls.enabled=!1}}),this.tweenControl.changeTo({start:this.controls.target,end:o,duration:e,onUpdate:()=>{this.camera.lookAt(this.controls.target)}})})}initLight(){const e=new hr(16777215,1.25),s=new Tt(16777215,1.55);s.shadow.camera.near=1,s.shadow.camera.far=3500,s.shadow.camera.right=2500,s.shadow.camera.left=-2500,s.shadow.camera.top=1600,s.shadow.camera.bottom=-1600,s.shadow.mapSize.width=Math.pow(2,11),s.shadow.mapSize.height=Math.pow(2,11),s.shadow.blurSamples=8,s.shadow.radius=1.15,s.shadow.bias=-.0015,s.position.set(-800,1300,1e3),s.castShadow=!0,this.ambientLight=e,this._add(this.ambientLight),new dr(s.shadow.camera),new fr(s),this.directionalLight=s,this._add(this.directionalLight),new Tt(13421772,.3).position.set(-150,150,0),new Tt(16777215,.4).position.set(150,100,0)}showAllBuildingLabel(){Object.values(this.buildingNameLabelMap).forEach(e=>{e.visible=!0,e.element.style.display="block"})}destroy(){this.tooltip&&(this.tooltip.destroy(),this.tooltip=null),this.sceneHint&&(this.sceneHint.destroy(),this.sceneHint=null)}}let ra=0;const dl=new M,Lt=new Ct(dl,1800),zn=new Ct(dl,900),Hn={maxPolarAngle:Math.PI/2.05};class Op extends sl{constructor(e){super(e);O(this,"limitCameraInSphere",()=>{this.camera.position.clampSphere(Lt),this.controls.target.clampSphere(zn),this.camera.position.y=this.camera.position.y<Lt.center.y?Lt.center.y:this.camera.position.y,this.controls.target.y=this.controls.target.y<Lt.center.y?Lt.center.y:this.controls.target.y});this.gatherOrSilentData={},this.gatherOrSilentLabel=null,this.scene.background=Aa,this.onRenderQueue=e.onRenderQueue,this.controls=e.controls,this.camera=e.camera,this.tweenControl=e.tweenControl,this.orientation=e.orientation,this.buildingObject={},this.currentFloor=null,this.eventClear=[],this.building=null,this.buildingName=null,this.endChangeFloor=!0,this.floors=[],this.sceneHint=new lr,this.initLight()}onEnter(e){this.core.ground&&this.core.ground.hideAllBuildingLabel&&this.core.ground.hideAllBuildingLabel(),this.currentPoint=null,q.onLoad(this,this.core),this.sceneHint||(this.sceneHint=new lr),this.sceneHint.show("右键双击返回室外");let s={name:e,path:`./models/inDoor/${e}_室内.glb`,type:".glb"};return this.buildingName=e,ol([s],this.onProgress.bind(this),this.onLoaded.bind(this))}createGround(e,s){const n=new Bc(e,s);this.scene.add(n)}handleControls(e){Lt.center.set(e.center.x,e.min.y,e.center.z),Lt.radius=e.radius*10,zn.center.set(e.center.x,e.min.y,e.center.z),zn.radius=e.radius*5,this.controls.addEventListener("change",this.limitCameraInSphere),Reflect.ownKeys(Hn).forEach(s=>{this.controls.data[s]=this.controls[s],this.controls[s]=Hn[s]})}resetControls(){this.controls.removeEventListener("change",this.limitCameraInSphere),Reflect.ownKeys(Hn).forEach(e=>{this.controls[e]=this.controls.data[e]})}onChangeSystemCustom(e,s,n){e==="outToIn"&&this.onEnter(n).then(()=>{this.changeFloor(s)}),e==="inToInSingle"&&this.changeFloor(s),e==="inToInOther"&&(this.clearIndoorData(),this.onEnter(n).then(()=>{this.changeFloor(s)}))}onProgress(e,s){const n=e.scene;n.children[0].children.forEach(r=>{const o={group:r,uTime:{value:1}};r.traverse(a=>{a.isMesh&&(this.modelProcessing(a,o),a.userData.parent=r.name)}),r.name.indexOf("BDW")===-1&&this.floors.push(r),this.buildingObject[r.name]=o}),n.name=s,this.building=n,this.scene.add(n)}modelProcessing(e,s){e.castShadow=!0,e.receiveShadow=!0,e.material.transparent&&(e.renderOrder=3,e.material.depthWrite=!0),e.material=e.material.clone(),e.material.transparent=!0,e.material.metalness=.2,e.material.roughness=.8,!e.name.includes("BDW")&&e.material.name.includes("建筑外壳")?(vp(e.material,s.uTime,new U("#3acacc")),e.renderOrder=2):gp(e.material,s.uTime)}onLoaded(){const e=nt(this.building);this.createGround(e.center,e.min),this.cameraMove(this.building).then(()=>{this.handleControls(e)}),this.addEventListener()}cameraMove(e){return new Promise((s,n)=>{let r,o;const{center:a,radius:l}=nt(e);o=a,r=new M;const c=this.camera.position.distanceTo(a),h=(c-Math.sqrt(l)*12)/c;r.lerpVectors(this.camera.position,a,h),this.tweenControl.changeTo({start:this.camera.position,end:r,duration:1e3,onComplete:()=>{this.controls.enable=!0,s()},onStart:()=>{this.controls.enable=!1}}),this.tweenControl.changeTo({start:this.controls.target,end:o,duration:1e3,onUpdate:()=>{this.controls.update()}})})}cameraMoveToFloor(e){return new Promise((s,n)=>{const{center:r,radius:o,min:a,max:l}=nt(e),c=l.y-a.y,h=r.clone(),u=Math.max(c*1.5,o*2),d=new M(r.x,r.y+c+u*.8,r.z+u*.6);this.tweenControl.changeTo({start:this.camera.position,end:d,duration:1200,onComplete:()=>{this.controls.enable=!0,s()},onStart:()=>{this.controls.enable=!1}}),this.tweenControl.changeTo({start:this.controls.target,end:h,duration:1200,onUpdate:()=>{this.controls.update()}})})}onLeave(){this.core.ground&&this.core.ground.showAllBuildingLabel&&this.core.ground.showAllBuildingLabel(),console.log("离开子场景"),this.resetControls(),this.sceneHint&&this.sceneHint.hide(),this.dispose()}addEventListener(){this.addRayDbClick(),this.addRayMove(),this.addRightDbClickQuit()}addRayDbClick(){let e=this.core.raycast("dblclick",this.floors,s=>{if(s.length){let n=s[0].object.userData.parent;this.changeFloor(n)}});return this.eventClear.push(e.clear),e.clear}disposeGatherOrSilent(){let e=[];for(let s in this.gatherOrSilentData)e.push(s);e.forEach(s=>{delete this.gatherOrSilentData[s]}),this.gatherOrSilentData={},this.disPoseGatherShader()}changeFloor(e){if(console.log(e,"floor"),!this.buildingObject||!this.buildingObject[e])return console.warn(`楼层 "${e}" 的建筑数据尚未加载完成，请稍后再试`),!1;if(!this.endChangeFloor)return!1;this.resetData(),this.currentFloor||(this.endChangeFloor=!1,this.removeEventListener(),this.addPointerLister(),this.addIndoorEvent(),this.core.isFollowing()||this.addRightDbClickReset(),this.switchFloorAnimate(e).then(s=>{window.configs.floorToName[this.buildingName+"_室内"]&&window.configs.floorToName[this.buildingName+"_室内"][e]&&Va(window.configs.floorToName[this.buildingName+"_室内"][e]),super.updateOrientation(),this.core.crossSearch.changeSceneSearch(),this.endChangeFloor=!0,this.gatherOrSilentShader(),this.sceneHint&&this.sceneHint.updateMessage("右键双击显示楼栋")}),this.buildingAnimate(e)),this.currentFloor.name!==e&&this.floorSwitchInner(e)}gatherOrSilentShader(){if(this.disPoseGatherShader(),this.gatherOrSilentData[this.currentFloor.name]){const{id:e,type:s,areaType:n,areaDataOut:r,areaDataBuilding:o,areaName:a}=this.gatherOrSilentData[this.currentFloor.name];this.gatherOrSilentLabel=this.core.ground.gatherOrSilentPlate.gatherModel(this.currentFloor,s,a),this.scene.add(this.gatherOrSilentLabel)}}disPoseGatherShader(){this.gatherOrSilentLabel&&(this.core.ground.gatherOrSilentPlate.clearGeometryGather(this.currentFloor),this.gatherOrSilentLabel.deleteSelf(),this.gatherOrSilentLabel=null)}addIndoorEvent(){let e=this.core.addClickCustom(this.indoorClickEvent.bind(this));this.eventClear.push(e)}indoorClickEvent(e){const n=e.intersectObject(this.orientation.orientation3D.singleGroup).filter(a=>a.object.visible);if(n.length){this.core.clearSearch();const a=n[0].object;this.orientation.setSearchId(a.name),this.orientation.search(),this.orientation.personSearchModule.setPosition();return}const o=e.intersectObject(q.equipGroup).filter(a=>a.object.visible);if(o.length){console.log(o[0],"点击设备牌子"),this.core.clearSearch();let a=o[0].object.typeName,l=o[0].object.name;q.searchEquip(l,a);return}}addPointerLister(){let e=this.core.raycast("mousemove",this.orientation.orientation3D.pointerArr,s=>{s.length?document.body.style.cursor="pointer":document.body.style.cursor="auto"});this.eventClear.push(e.clear)}addRayMove(){let e=this.core.raycast("mousemove",this.floors,s=>{if(s.length){let n=s[0].object.userData.parent;if(this.currentPoint===n)return;this.currentPoint=n,document.body.style.cursor="pointer",this.core.postprocessing.clearOutlineAll(1),this.core.postprocessing.addOutline(this.buildingObject[n].group,1)}else{if(!this.currentPoint)return;this.resetEffect()}});return this.eventClear.push(e.clear),e.clear}addRightDbClickReset(){const e=this.rightDblClickListener(()=>{this.removeEventListener(),this.cameraMove(this.building),this.addEventListener(),this.resetBuilding(),this.disPoseGatherShader()});this.eventClear.push(e)}setFloorGatherOrSilent(e){this.gatherOrSilentData[e.areaDataFloor]=e}addRightDbClickQuit(){const e=this.rightDblClickListener(()=>{this.core.changeSystem("ground")});this.eventClear.push(e)}rightDblClickListener(e){return this.core.addEventListener("mouseup").add(r=>{if(r.button!==2)return;let o=new Date().getTime();o-ra<250&&(e(r),o=0),ra=o})}switchFloorAnimate(e){if(!this.buildingObject||!this.buildingObject[e]||!this.buildingObject[e].group)return console.error(`楼层 "${e}" 的建筑数据不完整，无法执行楼层切换动画`),Promise.reject(new Error(`楼层 "${e}" 的建筑数据不完整`));const s=this.buildingObject[e].group,{min:n,max:r}=nt(s);return new Promise((o,a)=>{$s(r.y,n.y),this.currentFloor=s,this.cameraMoveToFloor(s).then(()=>{o({sceneType:0,originId:e})})})}floorSwitchInner(e){if(!this.buildingObject||!this.buildingObject[e]||!this.buildingObject[e].group){console.error(`楼层 "${e}" 的建筑数据不完整，无法执行楼层内部切换`);return}this.endChangeFloor=!1;const s=this.buildingObject[e].group,{min:n,max:r}=nt(s);Ic(),$s(r.y,n.y);let o=this.currentFloor.name;this.buildingObject[o].uTime.value=.2,this.buildingObject[e].group.visible=!0,this.buildingObject[e].uTime.value=1,new pn(this.buildingObject[o].uTime).to({value:0},1e3).start().onComplete(()=>{this.buildingObject[o].group.visible=!1}),this.currentFloor=s,this.cameraMoveToFloor(s).then(()=>{getPerson({sceneType:0,originId:e}),super.updateOrientation(),this.core.crossSearch.changeSceneSearch(),this.endChangeFloor=!0})}resetEffect(){this.currentPoint=null,document.body.style.cursor="auto",this.core.postprocessing.clearOutlineAll(1)}buildingAnimate(e){return new Promise((s,n)=>{Reflect.ownKeys(this.buildingObject).forEach(r=>{r===e||new pn(this.buildingObject[r].uTime).to({value:0},1e3).start().onComplete(()=>{this.buildingObject[r].group.visible=!1,s()})})})}resetBuilding(){$s(),Reflect.ownKeys(this.buildingObject).forEach(e=>{this.buildingObject[e].group.visible=!0,new pn(this.buildingObject[e].uTime).to({value:1},1e3).start().onComplete(()=>{this.currentFloor=null,this.resetData()})}),this.sceneHint&&this.sceneHint.updateMessage("右键双击返回室外")}resetData(){this.orientation.orientation3D.disposeClusterGroup(),q.disposeAll()}removeEventListener(){this.eventClear.forEach(e=>e()),this.eventClear=[],this.resetEffect()}dispose(){this.currentFloor=null,this.buildingObject={},this.removeEventListener(),this.resetData(),this.scene.dispose(),$s(),this.sceneHint&&(this.sceneHint.destroy(),this.sceneHint=null)}cameraMoveLimit(e,s){const n=new le().setFromCenterAndSize(e,s),r=this.camera.position,o=this.controls.target,a=r.clone(),l=o.clone();this.controls.addEventListener("change",c=>{n.containsPoint(r)?(l.copy(o),a.copy(r)):(o.copy(l),r.copy(a))})}initLight(){const e=new hr(16777215,1.5),s=new Tt(16777215,1.4);s.shadow.camera.near=1,s.shadow.camera.far=1e3,s.shadow.camera.right=1e3,s.shadow.camera.left=-1e3,s.shadow.camera.top=600,s.shadow.camera.bottom=-600,s.shadow.mapSize.width=Math.pow(2,11),s.shadow.mapSize.height=Math.pow(2,11),s.shadow.blurSamples=8,s.shadow.radius=1.15,s.shadow.bias=-.0015,s.position.set(-100,300,-300),s.castShadow=!0,this.ambientLight=e,this._add(this.ambientLight),new dr(s.shadow.camera),new fr(s),this.directionLight=s,this._add(this.directionLight),new Tt(13421772,.3).position.set(-150,150,0);const r=new Tt(16777215,.4);r.position.set(150,100,0),this._add(r)}clearIndoorData(){console.log("清理室内系统数据"),this.removeEventListener(),this.resetData(),this.disposeGatherOrSilent(),this.sceneHint&&this.sceneHint.hide(),this.building&&this.building.parent&&(this.building.parent.remove(this.building),this.building=null),this.buildingObject={},this.floors=[],this.currentFloor=null,this.endChangeFloor=!0,this.resetControls()}}const Gn=new M;class Fp{constructor(t){this.camera=t.camera,this.controls=t.controls}lerpTo(t,e=100,s=1e3,n=new M){const r=this.camera.position.distanceTo(t),o=(r-e)/r;Gn.lerpVectors(this.camera.position,t,o),Gn.add(n),this.changeTo({start:this.camera.position,end:Gn,duration:s,onStart:()=>this.controls.enabled=!1,onComplete:()=>this.controls.enabled=!0}),this.changeTo({start:this.controls.target,end:t,duration:s,onUpdate:()=>{this.camera.lookAt(this.controls.target)}})}changeTo(t){const{start:e,end:s,duration:n,onUpdate:r,onComplete:o,onStart:a}=t;if(!(!n||!s||!e))return new Wr.Tween(e).to(s,n).onStart(a).onUpdate(r).onComplete(o).start()}removeAll(){Wr.removeAll()}}class Np{constructor(t){this.core=t,this.crossSearchBuilding=!1,this.crossSearchInspection=!1,this.crossSearchDangerPerson=!1,this.crossSearchPerson=!1,this.crossFollowPerson=!1,this.setCrossSearchId=null,this.setCrossFollowId=null,this.crossGatherWarning=null}setCrossGatherWarning(t){this.crossGatherWarning=t}setCrossSearchBuildingStatus(t){this.crossSearchBuilding=t}setCrossFollowStatus(t){this.crossFollowPerson=t}setCrossSearchPersonStatus(t){this.crossSearchPerson=t}setCrossSearchInspectionStatus(t){this.crossSearchInspection=t}setCrossSearchDangerPersonStatus(t){this.crossSearchDangerPerson=t}changeSceneSearch(){this.crossSearchBuilding&&this.core.sceneType===1&&(this.core.ground.searchBuilding(),this.crossSearchBuilding=!1),this.crossSearchInspection&&(this.core.currentSystem.searchInspection(),this.crossSearchInspection=!1),this.crossGatherWarning&&(this.core.gatherWarning.gatherDangerFun(this.crossGatherWarning),this.crossGatherWarning=null),this.crossSearchPerson&&(this.core.orientation.setSearchId(this.setCrossSearchId),this.core.orientation.search(),this.core.orientation.personSearchModule.setPosition(),this.crossSearchPerson=!1,this.setCrossSearchId=null),this.crossFollowPerson&&(this.core.currentSystem.startFollowPerson(this.setCrossFollowId),this.crossFollowPerson=!1,this.setCrossFollowId=null),this.crossSearchDangerPerson&&(this.core.currentSystem.searchAlarmPerson(),this.crossSearchDangerPerson=!1)}}class Up{constructor(t){this.core=t,this.circles=[],this.eventClear=[],this.gatherMap=new Map,this.realTimeMap=new Map,this.memoryManager=new re}addEvents(){let t=this.core.raycast("click",this.circles,s=>{s.length?(console.log(s[0].point,"位置坐标"),this.showLabel(s[0].object.typeId)):this.showLabel(null)});this.eventClear.push(t.clear);let e=this.core.raycast("mousemove",this.circles,s=>{s.length?document.body.style.cursor="pointer":document.body.style.cursor="block"});this.eventClear.push(e.clear)}showLabel(t){this.realTimeMap.forEach((e,s)=>{e.board.visible=s===t})}removeEventListener(){this.eventClear.forEach(t=>{t()}),this.eventClear=[]}gatherDanger(t){const e=t.sceneChangeType;t.isDanger=!0,e==="noChange"?this.gatherDangerFun(t):(this.core.changeSystemCustom(e,t.originId,t.sceneType),this.core.crossSearch.setCrossGatherWarning(t))}async realTimeGather(t){this.removeEventListener(),this.circles=[],(!t||t.length===0)&&this.disposeRealTimeGather();let e={add:[],update:[],remove:[]},s=new Map;t.forEach(n=>{n.isDanger=!1,s.set(n.id,n),this.realTimeMap.get(n.id)&&e.update.push(n),this.realTimeMap.get(n.id)||e.add.push(n)}),this.realTimeMap.forEach((n,r)=>{s.get(r)||e.remove.push(r)}),e.add.forEach(({position:n,radius:r,level:o,users:a,id:l,name:c},h)=>{this.gatherDangerFun({position:n,radius:r,level:o,users:a,id:l,isDanger:!1,name:c},"add")}),e.update.forEach(({position:n,radius:r,level:o,users:a,id:l,name:c},h)=>{this.gatherDangerFun({position:n,radius:r,level:o,users:a,id:l,isDanger:!1,name:c},"update")}),e.remove.forEach(n=>{this.deleteRealTimeById(n)}),this.addEvents()}deleteRealTimeById(t){let e=this.realTimeMap.get(t).obj;for(let s=e.length-1;s>=0;s--)re.dispose(e[s]);re.dispose(this.realTimeMap.get(t).board),re.dispose(this.realTimeMap.get(t).object3d),this.realTimeMap.delete(t)}getCenterPosition(t){let e=0,s=0,n=0,r=t.length;t.forEach(c=>{e+=c.x,s+=c.y,n+=c.z});let o=e/r,a=s/r,l=n/r;return new M(o,a,l)}gatherDangerFun({position:t,radius:e,level:s,users:n,id:r,isDanger:o=!1,name:a},l){let c=null,h=null;if(l==="add"&&(h=new ve,c=this.setPersonBoard({name:`${n.split(",").length}人`,id:r,areaName:`${a}`},!0,s,n,o,r),c.center.set(.5,1),h.add(c),h.position.set(0,0,0),this.core.scene.add(h),o||(c.visible=!1)),l==="update"){c=this.realTimeMap.get(r).board,h=this.realTimeMap.get(r).object3d;let d=this.realTimeMap.get(r).obj;for(let f=d.length-1;f>=0;f--)re.dispose(this.realTimeMap.get(r).obj[f]);this.realTimeMap.get(r).obj=null}c.position.copy(this.getCenterPosition(t));let u=[];t.forEach(d=>{e||(e=500);let f=e/100,g=new Oc(new M,f,s);h.add(g),u.push(g),g.typeId=r,this.circles.push(g),g.position.copy(d)}),o?(this.disposeGather(),this.gatherMap.set(r,{obj:u,board:c,object3d:h})):(l==="add"&&this.realTimeMap.set(r,{obj:u,board:c,object3d:h}),l==="update"&&(this.realTimeMap.get(r).obj=u,this.realTimeMap.get(r).object3d=h))}setPersonBoard(t,e=!1,s,n,r,o){let a={3:"#FFDE33",2:"#FF9441",1:"#FF4747"},l={3:"yellow",2:"orange",1:"red"},c=document.createElement("div");c.style="margin-bottom:12px";let h=document.createElement("span");h.style.color=a[s],h.innerText=t.name;let u=document.createElement("span");u.style.color=a[s],u.innerText=t.areaName;let d=document.createElement("div"),f=document.createElement("div"),g=document.createElement("div"),v=document.createElement("div");v.className="beilu_three_Board_text_gather_span",v.style.background=`${a[s]}`;let p=document.createElement("div");p.className="beilu_three_Board_text_gather_span",p.style.background=`${a[s]}`,g.append(c),g.append(d),g.append(f),g.draggable=!1,g.className="beilu_three_Board_text_gather",g.style.border=`1px solid ${a[s]}`,f.className=`beilu_three_Board_text_gather_down_${l[s]}`,c.innerText="聚集人数：",c.append(h),c.append(v),d.innerText="报警位置：",d.append(p),d.append(u),c.onclick=()=>{Gd({users:n,isDanger:r,alarmId:o})};let m=Ce(g,"board"+t.id);return m.visible=e,m}disposeGather(){this.gatherMap.forEach(t=>{let e=t.obj;for(let s=e.length-1;s>=0;s--)re.dispose(e[s]);re.dispose(t.board),re.dispose(t.object3d)}),this.gatherMap.clear(),this.circles=[],this.removeEventListener()}disposeRealTimeGather(){this.realTimeMap.forEach(t=>{for(let e=t.obj.length-1;e>=0;e--)re.dispose(t.obj[e]);re.dispose(t.board),re.dispose(t.object3d)}),this.realTimeMap.clear(),this.circles=[],this.removeEventListener()}}let oa=0;const aa=new F,jn=new F,ks=class ks extends Rd{constructor(e){super(e);O(this,"getMouse",(e,s)=>{const{left:n,top:r,width:o,height:a}=this.domElement.getBoundingClientRect();s.x=(e.clientX-n)/o*2-1,s.y=-((e.clientY-r)/a)*2+1});this.time=new Date().getTime(),this.cache=!0,this.currentSystem=null,this.firstLoad=!0,this.sceneType=1,this.dwObj={},this.ray=new Mi,this.inDoorModel=!1;const s=ks.Default.position.clone().applyAxisAngle(new M(0,1,0),45).multiplyScalar(.25);this.camera.position.copy(s),this.controls.target.copy(ks.Default.target),this.controls.minDistance=10}setIndoorModel(e){this.inDoorModel=e}isIndoorModel(){return this.inDoorModel}init(){this.initCSS2DRenderer(),this.initCSS3DRenderer(),this.initComposer(),this._beginRender(),this.controlEvent()}_beginRender(){this.renderEnabled||(this.firstLoad?(this.setClass(),this.firstLoad=!1):this.currentSystem.onEnter(),this.beginRender())}_stopRender(){this.stopRender(),this.currentSystem.onLeave()}setClass(){this.tweenControl=new Fp(this),this.orientation=new Xe(this),this.ground=new Ip(this),this.indoorSubsystem=new Op(this),this.crossSearch=new Np(this),this.gatherWarning=new Up(this),this.changeSystem("ground"),this.onRenderQueue.set("elapsedTimeUpdate",e=>Fc(e.elapsedTime))}hideInspectionSystemIcon(e){this.currentSystem.hideInspectionSystemIcon(e)}isSearching(){return!!this.orientation.searchId}isFollowing(){return!!this.orientation.followId}cherryPick(e){this.currentSystem.cherryPick(e)}createFence(e){this.currentSystem.createFence&&this.currentSystem.createFence(e)}changeSystem(e,s=null){this.clearFence(),this.changeSystemCommon(e),this.orientation.clearSearch(),this[e].onEnter(s)}changeIndoor(e){const s=window.floorToName[e];if(!s){console.warn(`未找到建筑 "${e}" 的配置信息`);return}const{path:n,floor:r}=s,o=n.replace("inDoor/","").replace("_室内","");this.currentSystem===this.indoorSubsystem&&(console.log("当前已在室内系统，执行清理操作"),this.indoorSubsystem.clearIndoorData()),this.changeSystem("indoorSubsystem",o),(()=>new Promise(c=>{const h=()=>{this.indoorSubsystem&&this.indoorSubsystem.building&&this.indoorSubsystem.buildingObject&&this.indoorSubsystem.buildingObject[r]?c():setTimeout(h,100)};h()}))().then(()=>{this.changeFloor(r)})}clearFence(){this.currentSystem&&this.currentSystem.clearFence&&this.currentSystem.clearFence()}clearEquipType(e){this.currentSystem.clearEquipType(e)}changeSystemCommon(e){const s=this[e],n=this.currentSystem;if(!s){console.warn(`${e}子系统未初始化`);return}if(n)if(s===n)if(e==="indoorSubsystem")console.log("室内系统重新初始化");else return;else n.onLeave();this.orientation.orientation3D.disposeClusterGroup(),this.orientation.orientation3D.disposeAlarm(),this.changeScene(s.scene),this.currentSystem=s,this.sceneType=e==="ground"?Xe.SCENE_TYPE.OUTDOOR:Xe.SCENE_TYPE.INDOOR}changeSystemCustom(e,s,n){const r=n===Xe.SCENE_TYPE.INDOOR?"indoorSubsystem":"ground";this.changeSystemCommon(r);const o=this[r];e==="inToOut"?o.onEnter():o.onChangeSystemCustom(e,s,s.slice(0,-3))}controlEvent(){this.controls.addEventListener("start",()=>{this.setRaycasterState("mousemove",!1)}),this.controls.addEventListener("end",()=>{this.setRaycasterState("mousemove",!0)})}getCurrentOriginId(){return{sceneType:this.sceneType,originId:this.indoorSubsystem.currentFloor?this.indoorSubsystem.currentFloor.name:""}}setHeatmap(e){this.orientation.setHeatmap(e)}changeScene(e){this.scene=e}changeWeather(e){this.currentSystem.changeWeather(e)}switchWeather(e){this.ground.switchWeather(e)}changeFloor(e){this.indoorSubsystem&&this.indoorSubsystem.changeFloor(e)}startMeasuring(){this.changeView(new M(0,1,0),1200),this.enableControlsRotate(!1),this.currentSystem.startMeasuring(),this.setCameraState(!1)}removeMeasuring(){this.enableControlsRotate(!0),this.currentSystem.removeMeasuring(),this.setCameraState(this.ground.roamEnabled)}startMeasureArea(){this.changeView(new M(0,1,0),1200),this.enableControlsRotate(!1),this.currentSystem.startMeasureArea(),this.setCameraState(!1)}removeMeasureArea(){this.currentSystem.removeMeasureArea(),this.enableControlsRotate(!0),this.setCameraState(this.ground.roamEnabled)}changeBoxSelect(e){console.log("test"),this.changeView(new M(0,1,0),1200),this.enableControlsRotate(!e),this.ground.changeBoxSelect(e),e?this.setCameraState(!1):this.setCameraState(this.ground.roamEnabled)}reSelect(){this.ground.boxSelect.end(),this.ground.boxSelect.start(),this.changeView(new M(0,1,0),1200),this.enableControlsRotate(!1),this.setCameraState(!1)}changeView(e=new M(0,1,0),s=100){const n=new M().addScaledVector(e,s);this.camera.position.copy(n),this.controls.target.set(0,0,0)}resetCameraUp(){this.camera.up.set(0,1,0)}enableControlsRotate(e){this.controls.enableRotate=e}historyTrackCommand(e){this.currentSystem.historyTrackCommand(e)}clearSearch(){}searchPerson(e){const{originId:s,sceneType:n,sceneChangeType:r,id:o}=e;r!=="noChange"?(this.changeSystemCustom(r,s,n),this.crossSearch.setCrossSearchId=o,this.crossSearch.setCrossSearchPersonStatus(!0)):(this.orientation.setSearchId(o),this.orientation.search(),this.orientation.personSearchModule.setPosition())}followCheck(e,s){let n=e.data.param.update.length&&e.data.param.update.filter(c=>{if(c.id===s)return c});if(!n||n.length===0)return!1;let{id:r,sceneType:o,originId:a}=n[0];o===0&&!a.includes("F")&&(o=1);let l=Nc({sceneType:o,originId:a});l!=="noChange"&&(this.orientation.cancelFollow(),this.followChangeScene({originId:a,sceneType:o,sceneChangeType:l,id:r}))}followChangeScene({originId:e,sceneType:s,sceneChangeType:n,id:r}){this.changeSystemCustom(n,e,s),this.crossSearch.setCrossFollowId=r,this.crossSearch.setCrossFollowStatus(!0)}startFollow(e){this.postprocessing.clearOutlineAll(1);const{sceneChangeType:s,id:n}=e;s!=="noChange"&&this.followChangeScene(e),s==="noChange"&&this.currentSystem.startFollowPerson(n)}cancelFollow(){this.currentSystem.cancelFollowPerson(),this.sceneType===0&&(this.indoorSubsystem.removeEventListener(),this.indoorSubsystem.addPointerLister(),this.indoorSubsystem.addIndoorEvent(),this.indoorSubsystem.addRightDbClickReset())}changeMouseEventSwitch(e){e?this.currentSystem.addEventListener():(this.currentSystem.removeEventListener(),this.postprocessing.clearOutlineAll(1),this.postprocessing.clearOutlineAll(2))}bindGroundEvent(){this.sceneType===1&&(this.ground.removeEventListener(),this.ground.addEventListener())}bindSearchEvent(){this.sceneType===1&&(this.ground.removeEventListener(),this.ground.addGroundEvent())}clearSelected(e){this.currentSystem.clearSelected(e)}clearAllPerson(){this.currentSystem.clearPerson()}dangerFenceInit(e){this.ground.initDangerFence(e)}hideBuildingDialog(e){this.ground.hideBuildingLabel(e)}hideCameraDialog(e){this.currentSystem.clearCameraVideo(e)}clearDanger(){this.orientation.orientation3D.personDangerData&&this.currentSystem.clearDangerPerson(),this.ground.clearDangerFence()}personAlarmInit(e){const{originId:s,sceneType:n,sceneChangeType:r,id:o}=e;this.currentSystem.setDangerPerson(e),r!=="noChange"&&(this.changeSystemCustom(r,s,n),this.crossSearch.setCrossSearchDangerPersonStatus(!0)),r==="noChange"&&this.currentSystem.searchAlarmPerson()}changeBuildingNum(e){this.ground.changeBuildingNumber(e)}hideCameraById(e){this.currentSystem.hideCameraById(e)}switchGatherStatus(e){this.orientation.clusterModule.setActive(e)}setGatherLevel(e){this.orientation.clusterModule.setLevel(e)}roamEnabled(e){this.ground.roamEnabled=e,this.ground.setCameraState(e)}roamDuration(e){this.ground.roamDuration=e}searchBuilding(e,s){this.ground.searchBuildingId=e,this.sceneType===0?(this.changeSystem("ground"),this.crossSearch.setCrossSearchBuildingStatus(!0)):this.ground.searchBuilding(s)}searchCamera(e){const{originId:s,sceneType:n,sceneChangeType:r,id:o}=e;r!=="noChange"&&(this.changeSystemCustom(r,s,n),this.currentSystem.setSearchCameraId(o)),r==="noChange"&&this.currentSystem.searchCamera(o)}searchInspectionSystem(e){const{originId:s,sceneType:n,sceneChangeType:r,id:o}=e;r!=="noChange"&&(this.changeSystemCustom(r,s,n),this.currentSystem.setSearchInspectionSystemId(o)),r==="noChange"&&this.currentSystem.searchInspectionSystem(o)}search(e){if(this.clearSearch(),!e)return;const{type:s,sceneType:n,originId:r,id:o,filter:a,sceneChangeType:l,inDoorModel:c}=e;if(!c)return this.searchBuilding(r,!1),this.setIndoorModel(!0),!1;if(s==="person")return this.searchPerson(e);if(s==="building")return this.searchBuilding(o);if(s==="equip")return this.searchCamera(e);if(s==="inspection")return this.searchInspection(e);if(s==="personDanger")return this.personAlarmInit(e);if(s==="inspectionSystem")return this.searchInspectionSystem(e)}searchInspection(e){const{originId:s,sceneType:n,sceneChangeType:r,id:o,name:a,position:l}=e;this.currentSystem.setSearchInspection({id:o,name:a,position:l}),r!=="noChange"&&(this.changeSystemCustom(r,s,n),this.crossSearch.setCrossSearchInspectionStatus(!0)),r==="noChange"&&this.currentSystem.searchInspection()}processingEquipment(e,s){this.currentSystem.processingEquipData(e,s)}changeLighting(e){this.currentSystem.updateLightingPattern(e)}setCameraState(e){this.currentSystem.setCameraState(e)}beginWander(){this.currentSystem.beginWander()}resetCamera(){this.currentSystem.resetCamera()}endWander(){this.currentSystem.endWander()}rightDblClickListener(e){return this.addEventListener("mouseup").add(r=>{if(r.button!==2)return;let o=new Date().getTime();o-oa<250&&(o=0,e(r)),oa=o})}addClickCustom(e){let s=null;const r=this.addEventListener("mousedown").add(h=>{h.button!==2&&this.getMouse(h,aa)}),o=this.addEventListener("mouseup");let a;const l=o.add(h=>{h.button!==2&&(this.getMouse(h,jn),aa.equals(jn)&&(s?(clearTimeout(s),s=null):s=setTimeout(()=>{a=new Mi,a.setFromCamera(jn,this.camera),e(a),clearTimeout(s),s=null},250)))});return()=>{r(),l(),a=null}}};O(ks,"Default",{position:new M(154,265,612),target:new M(-446,10,-389)});let Ri=ks;export{Ri as Store3D};
